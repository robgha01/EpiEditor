//>>built
define("epi-cms/component/Versions",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dom-class","dojo/string","dojo/topic","dojo/when","dojo/_base/json","dojox/html/entities","dgrid/OnDemandGrid","dgrid/Selection","epi-cms/dgrid/formatters","epi","epi/dependency","epi/shell/TypeDescriptorManager","epi/shell/command/_WidgetCommandProviderMixin","epi/shell/command/withConfirmation","epi/shell/widget/_FocusableMixin","epi/shell/DialogService","epi-cms/_MultilingualMixin","epi-cms/ApplicationSettings","epi-cms/core/ContentReference","epi-cms/component/command/DeleteVersion","epi-cms/component/command/DeleteLanguageBranch","epi-cms/component/command/SetCommonDraft","epi-cms/command/ShowAllLanguages","epi-cms/contentediting/ContentActionSupport","epi-cms/widget/_GridWidgetBase","epi/i18n!epi/cms/nls/episerver.cms.components.versions"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e){return _2([_1d,_11,_13,_15],{showAllLanguages:true,isMultilingual:false,postMixInProperties:function(){this._commonDrafts={};this.storeKeyName="epi.cms.contentversion";this.ignoreVersionWhenComparingLinks=false;this.forceContextReload=true;this.inherited(arguments);this._currentContentLanguage=_16.currentContentLanguage;this._showAllLanguagesCommand=new _1b({model:this});var _1f=_f.resolve("epi.storeregistry");this._contentStore=_1f.get("epi.cms.contentdata");},buildRendering:function(){this.inherited(arguments);var _20=_2([_b,_c]);this.grid=new _20({columns:{language:{label:_e.resources.header.language},status:{label:_e.resources.header.status,renderCell:_d.commonDraft},savedDate:{label:_e.resources.header.saved,formatter:this._localizeDate},savedBy:{label:_e.resources.header.by,formatter:this._createUserFriendlyUsername}},selectionMode:"single",selectionEvents:"click,dgrid-cellfocusin",sort:[{attribute:"savedDate",descending:true}]},this.domNode);},postCreate:function(){this.inherited(arguments);this.add("commands",this._showAllLanguagesCommand);this._commonDraftCommand=new _1a();this._deleteVersionCommand=new _18();this._deleteLanguageBranchCommand=new _19();this.own(_4.after(this._commonDraftCommand,"execute",_3.hitch(this,function(_21){_21.then(_3.hitch(this,this.fetchData),_3.hitch(this,this._onSetCommonDraftFailure));})),_4.after(this._deleteVersionCommand,"execute",_3.hitch(this,function(_22){_22.then(_3.hitch(this,this._onDeleteVersionSuccess),_3.hitch(this,this._onDeleteVersionFailure));})),_4.after(this._deleteLanguageBranchCommand,"execute",_3.hitch(this,function(_23){_23.then(_3.hitch(this,this._onDeleteLanguageBranchSuccess),_3.hitch(this,this._onDeleteVersionFailure));})));this.add("commands",this._commonDraftCommand);this.add("commands",_12(this._deleteVersionCommand,null,{title:_1e.deletemenuitemtitle,heading:_1e.deleteversion.note,description:_1e.deleteversion.confirmquestion}));this._deleteLanguageBranchSettings={cancelActionText:_e.resources.action.cancel,setFocusOnConfirmButton:false};this.add("commands",_12(this._deleteLanguageBranchCommand,null,this._deleteLanguageBranchSettings));},startup:function(){if(this._started){return;}this.inherited(arguments);this.own(_4.around(this.grid,"renderRow",_3.hitch(this,this._aroundRenderRow)));this._toggleLanguage();this.fetchData();},_setShowAllLanguagesAttr:function(_24){this._set("showAllLanguages",_24);this._showAllLanguagesCommand.set("active",!_24);this._toggleFilterByLanguage(_24);},contextChanged:function(_25,_26){this.inherited(arguments);!this._isContentContext(_25)&&this.grid.set("store",null);},fetchData:function(){_8(this.getCurrentContent(),_3.hitch(this,function(_27){if(!_27){return;}this._setQuery(_27.contentLink,this.showAllLanguages);this.set("isMultilingual",true);}));},_aroundRenderRow:function(_28){return _3.hitch(this,function(_29){if(_29.isCommonDraft){var _2a=this._commonDrafts[_29.language];if(_2a&&_2a!==_29.contentLink){this._removeCommonDraft(_2a);}this._commonDrafts[_29.language]=_29.contentLink;}this._versionsByLanguage[_29.language]=this._versionsByLanguage[_29.language]||[];if(_1.every(this._versionsByLanguage[_29.language],function(ver){return ver!==_29.contentLink;})){this._versionsByLanguage[_29.language].push(_29.contentLink);}var row=_28.apply(this.grid,arguments);_5.toggle(row,"dgrid-row-published",_29.status===_1c.versionStatus.Published);return row;});},_onError:function(e){if(e.error&&e.error.status===403){_8(this.getCurrentContent(),_3.hitch(this,function(_2b){this._showErrorMessage(_e.resources.messages.nopermissiontoviewdata);this.set("isMultilingual",false);this._updateMenu(_2b);}));}else{this.inherited(arguments);}},_onSelect:function(e){var _2c=e.rows[0].data;this._updateMenu(_2c);this.inherited(arguments);},_updateMenu:function(_2d){this._commonDraftCommand.set("model",_2d);this._deleteVersionCommand.set("model",_2d);_8(this._contentStore.get(_2d.contentLink),_3.hitch(this,function(_2e){if(_2e&&_2e.currentLanguageBranch){var _2f=_3.replace(_1e.deletelanguagebranch.label,[_2e.currentLanguageBranch.name]),_30=_10.getResourceValue(_2e.typeIdentifier,"deletelanguagebranchdescription");_3.mixin(this._deleteLanguageBranchSettings,{confirmActionText:_2f,description:_3.replace(_30,[_a.encode(_2e.name),_2e.currentLanguageBranch.name]),title:_2f});this._deleteLanguageBranchCommand.set("label",_2f);}this._deleteLanguageBranchCommand.set("model",_2e);}));},_showNotificationMessage:function(_31){_14.alert({title:_1e.notificationtitle,description:_31});},_selectCommonDraftVersion:function(uri,_32){var _33={sender:this};if(_32){_33.forceReload=_32;}_7.publish("/epi/shell/context/request",{uri:uri},_33);},_onDeleteLanguageBranchSuccess:function(){return _8(this._onDeleteVersionSuccess(arguments),_3.hitch(this,function(){var _34=this._deleteLanguageBranchCommand.model.currentLanguageBranch.languageId;_1.forEach(this._versionsByLanguage[_34],_3.hitch(this,function(ver){this.store.notify(undefined,new _17(ver));}));}));},_onDeleteVersionSuccess:function(){var _35=this;return _8(this.getCurrentContent(),function(_36){var _37=new _17(_36.contentLink);var _38=_37.createVersionUnspecificReference().toString();_35._selectCommonDraftVersion("epi.cms.contentdata:///"+_38,true);});},_onDeleteVersionFailure:function(_39){if(!_39||!_39.status){return;}else{if(_39.status===403){this._showNotificationMessage(_1e.deleteversion.cannotdeletepublished);}else{if(_39.status===409){var _3a=_39.responseText?_9.fromJson(_39.responseText).message:_1e.deleteversion.cannotdelete;this._showNotificationMessage(_3a);}else{this._showNotificationMessage(_1e.deleteversion.cannotdelete);}}}},_onSetCommonDraftFailure:function(){this._showNotificationMessage(_1e.setcommondraft.failuremessage);},_removeCommonDraft:function(_3b){if(_3b){var _3c=this.grid.row(_3b).data;if(_3c){_3c.isCommonDraft=false;}}},_toggleFilterByLanguage:function(_3d){return _8(this.getCurrentContext()).then(function(_3e){if(!this._isContentContext(_3e)){this.grid.set("store",null);}else{this._setQuery(_3e.id,_3d);this._toggleLanguage();}}.bind(this));},_setQuery:function(_3f,_40){var _41={contentLink:new _17(_3f).createVersionUnspecificReference().toString()};if(!_40){_41.language=this._currentContentLanguage;}this.grid.set("query",_41);if(!this.grid.store){this.grid.set("store",this.store);}this._versionsByLanguage={};},_toggleLanguage:function(){var _42=this.showAllLanguages?"table-cell":"none";this.grid.styleColumn("language",_6.substitute("display:${0};",[_42]));}});});