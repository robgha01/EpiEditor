//>>built
define("epi-cms/component/MediaViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/when","dojo/topic","epi","epi/shell/widget/dialog/Dialog","epi-cms/core/ContentReference","epi-cms/asset/view-model/HierarchicalListViewModel","epi-cms/widget/viewmodel/MultipleFileUploadViewModel","epi-cms/widget/MultipleFileUpload","epi-cms/command/UploadContent","epi-cms/command/EditImage","epi-cms/command/DownloadMedia","epi-cms/asset/command/UploadContentToSelection","epi/i18n!epi/cms/nls/episerver.cms.components.media"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){return _2([_a],{dropZoneSettings:null,_dialog:null,postscript:function(){this.inherited(arguments);this.own(_6.subscribe("/epi/cms/upload",function(_12){this.set("selectedTreeItems",this.get("selectedTreeItems"));if(this.isPseudoContextualRoot({contentLink:_12})&&this.treeStoreModel&&typeof this.treeStoreModel.refreshRoots==="function"){this.treeStoreModel.refreshRoots(this);}}.bind(this)));},_getTypesToCreate:function(){return [];},_setupCommands:function(){this.inherited(arguments);var _13={selection:this.selection};var _14=new _d(_3.mixin({iconClass:"epi-iconPlus",label:_11.command.label,resources:_11,viewModel:this},_13));var _15={uploadDefault:{command:_14},upload:{command:new _10(_3.mixin({category:"context",iconClass:"epi-iconUpload",label:_11.linktocreateitem,viewModel:this},_13)),order:2},editImage:{command:new _e(_3.mixin({category:"context",forceContextChange:true,label:_11.command.openineditor},_13)),order:3},download:{command:new _f(_3.mixin({category:"context",label:_11.command.download},_13)),order:4}};this.own(_14.watch("canExecute",this._onUploadCommandUpdated.bind(this)));this._commandRegistry=_3.mixin(this._commandRegistry,_15);this.pseudoContextualCommands.push(this._commandRegistry.uploadDefault.command);this.pseudoContextualCommands.push(this._commandRegistry.upload.command);},_onUploadCommandUpdated:function(_16,_17,_18){var _19=this._commandRegistry.uploadDefault.command;var _1a=_19.get("model");var _1b=_1a?_1a.length===1:false;var _1c=_1b?_1a[0].name:null;var _1d=this.get("isSearching");var _1e={dropFolderName:_1c,validSelection:_1b,enabled:!_1d&&(_18||!_1b)};this.set("dropZoneSettings",_1e);},_selectedTreeItemsSetter:function(_1f){this._commandRegistry.uploadDefault.command.set("model",_1f);this.inherited(arguments);},upload:function(_20,_21,_22){var _23=new _c({model:new _b({store:this.get("store"),query:this.get("listQuery")})});_23.on("beforeUploaderChange",_3.hitch(this,function(){this._uploading=true;}));_23.on("close",_3.hitch(this,function(_24){this._dialog&&(_24?this._dialog.hide():this._dialog.destroy());}));_23.on("uploadComplete",_3.hitch(this,function(_25){if(_23.createAsLocalAsset){_5(this.treeStoreModel&&typeof this.treeStoreModel.refreshRoots==="function"&&this.treeStoreModel.refreshRoots(this),_3.hitch(this,function(){_23.set("createAsLocalAsset",false);_23.set("uploadDirectory",this.get("selectedTreeItems")[0].id);_23.model.set("query",this.get("listQuery"));}));}else{this.onListItemUpdated(_25);_6.publish("/epi/cms/upload",_21);this.selectListItemsByContentReferences(_25.map(function(_26){var _27=_9.toContentReference(_26.contentLink);return _27.createVersionUnspecificReference().toString();}));}if(this._dialog&&!this._dialog.open){this._dialog.destroy();}this._uploading=false;}));this._dialog=new _8({title:_11.linktocreateitem,dialogClass:"epi-dialog-upload",content:_23,autofocus:true,defaultActionsVisible:false,closeIconVisible:false,destroyOnHide:false});this._dialog.definitionConsumer.add({name:"close",label:_7.resources.action.close,action:function(){_23.close();}});this._dialog.resize({w:700});this._dialog.show();var _28=this.get("selectedTreeItems")[0];this._buildBreadcrumb(_28,_23);_23.set("uploadDirectory",_21||_28.id);_23.set("createAsLocalAsset",_22);_23.upload(_20);},onListItemUpdated:function(_29){var _2a=this.store;return _5(this.getCurrentContext(),function(_2b){var _2c=(new _9(_2b.id)).createVersionUnspecificReference().toString();return _5(_2a.get(_2c),function(_2d){var _2e=_1.filter(_29,function(_2f){return _2d.name.toLowerCase()===_2f.fileName.toLowerCase();})[0];return _2e?_2d:null;});});},_buildBreadcrumb:function(_30,_31){if(!_31){return;}if(this.treeStoreModel.isTypeOfRoot(_30)){_31.set("breadcrumb",[_30]);return;}this.treeStoreModel.getAncestors(_30.contentLink,_3.hitch(this,function(_32){var _33,_34=[_30];for(var i=_32.length-1;i>=0;i--){_33=_32[i];_34.unshift(_33);if(this.treeStoreModel.isTypeOfRoot(_33)){break;}}_31.set("breadcrumb",_34);}));}});});