//>>built
define("epi-cms/content-approval/viewmodels/ApprovalStepViewModel",["dojo/_base/declare","dojo/_base/lang","epi-cms/content-approval/viewmodels/ReviewerViewModel","dojo/Stateful","dojo/Evented","epi/shell/DestroyableByKey","epi-cms/content-approval/command/AddApprovalStep","epi-cms/content-approval/command/RemoveApprovalStep","epi-cms/content-approval/ApprovalEnums","dojo/store/Memory","dojo/store/Observable","epi/i18n!epi/nls/episerver.cms.contentapproval"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _1([_4,_6,_5],{reviewers:null,commands:null,userStore:null,canBeDeleted:true,selfApprove:true,isReadOnly:false,name:"",isValid:true,validationMessages:[],languages:null,showValidations:false,addReviewer:function(_d){_d.languages=_d.languages||[];this.reviewers.add(this._createReviewer(_d));},filterOutExistingUsers:function(_e){var _f=this.get("reviewers").query();return _e=_e.filter(function(_10){return !_f.some(function(_11){return (_10.name.toLowerCase()===_11.name.toLowerCase()&&_10.reviewerType===_11.reviewerType);});},this);},filterReviewers:function(_12){this.reviewers.query().forEach(function(_13){if(_12===null||_13.languages.length===0){_13.set("canApprove",true);return;}var _14=_13.languages.some(function(_15){return _15===_12;});_13.set("canApprove",_14);});},createApprovalStep:function(){this.emit("create-step",this);},removeApprovalStep:function(){this.emit("remove-step",this);},removeReviewer:function(_16){if(this.isReadOnly){return;}this.reviewers.remove(this._getReviewerId(_16));},serialize:function(){var _17=this.reviewers.data.map(function(_18){return _18.serialize();});return {name:this.name,reviewers:_17};},validate:function(){if(!this.reviewers){return;}var _19=[],_1a=this.reviewers.query(),_1b=this._validateReviewers(_1a);if(_1b){_19.push(_1b);}_1b=this._validateLanguages(_1a);if(_1b){_19.push(_1b);}_1b=this._validateSelfApprove(_1a);if(_1b){_19.push(_1b);}_1b=this._validateRoles(_1a);if(_1b){_19.push(_1b);}this.set("validationMessages",_19);this.set("isValid",_19.length===0);},hasErrors:function(){return this.validationMessages.some(function(_1c){return _1c.level==="error";});},hasWarnings:function(){return this.validationMessages.some(function(_1d){return _1d.level==="warning";});},_createReviewer:function(_1e){var _1f=new _3(_1e);_1f.id=this._getReviewerId(_1e);this.own(_1f.watch("languages",function(){this.validate();this.emit("change");}.bind(this)));this.validate();return _1f;},_getReviewerId:function(_20){return _20.name.toLowerCase()+":"+_20.reviewerType;},_nameSetter:function(_21){_21=_21||"";if(_21===this.name){return;}this.name=_21;this.emit("change");},_nameGetter:function(){return this.name||_c.step.header.placeholder;},_reviewersSetter:function(_22){var _23=_22.map(function(_24){return this._createReviewer(_24);},this);this.reviewers=_b(new _a({data:_23}));this.destroyByKey("reviewersObserveHandle");this.ownByKey("reviewersObserveHandle",this.reviewers.query().observe(function(){this.validate();this.emit("change");}.bind(this)));this.validate();},_selfApproveSetter:function(_25){this.selfApprove=_25;this.validate();},_commandsGetter:function(){if(this.commands===null){this.commands=[new _7({model:this}),new _8({model:this})];}return this.commands;},_validateLanguages:function(_26){var _27=null;if(!this.languages||_26.length===0){return _27;}var _28=[];this.languages.forEach(function(_29){var _2a=_26.some(function(_2b){if(_2b.languages.length===0){return true;}return _2b.languages.some(function(_2c){return _2c===_29.value;});});if(!_2a){if(_27){_27.languages.push(_29.value);}else{_27={languages:[_29.value],level:"warning"};}_28.push(_29.text);}});if(_27){_27.value=_2.replace(_c.validationmessage.notenoughlanguagesmessage.title,{languages:_28.join(", ")});}return _27;},_validateSelfApprove:function(_2d){if(this.selfApprove!==false){return null;}if(!this.languages){if(_2d.length===1&&_2d[0].reviewerType===_9.reviewerType.user){return {value:_c.validationmessage.onlyonereviewer.title,languages:null,level:"warning"};}return null;}var _2e=this.languages.filter(function(_2f){var _30=0;_2d.forEach(function(_31){if(_31.languages.length===0||_31.languages.indexOf(_2f.value)!==-1){if(_31.reviewerType===_9.reviewerType.user){_30++;}else{if(_31.reviewerType===_9.reviewerType.role){_30+=2;}}}});return _30<2;});if(_2e.length>0){return {value:_2.replace(_c.validationmessage.onlyonelanguagereviewer.title,{languages:_2e.map(function(_32){return _32.text;}).join(", ")}),languages:_2e.map(function(_33){return _33.value;}),level:"warning"};}return null;},_validateRoles:function(_34){if(_34.length===0){return null;}var _35=[];_34.forEach(function(_36){if(_36.reviewerType===_9.reviewerType.role&&_36.numberOfRoleUsersExceededMax){_35.push(_36.displayName);}});if(_35.length===0){return null;}var _37=_2.replace(_c.validationmessage.roleusersexceededmaxmessage.description,{rolenames:_35.join(", ")});return {value:_37,languages:null,level:"warning"};},_validateReviewers:function(_38){var _39=null;if(_38.length===0){_39={value:_c.validationmessage.notenoughreviewersmessage.title,languages:null,level:"error"};}return _39;}});});