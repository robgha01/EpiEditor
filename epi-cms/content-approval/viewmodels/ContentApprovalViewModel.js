//>>built
define("epi-cms/content-approval/viewmodels/ContentApprovalViewModel",["dojo/_base/declare","dojo/_base/lang","dojo/on","dojo/when","epi/epi","epi/dependency","epi/shell/DialogService","epi/shell/TypeDescriptorManager","epi-cms/content-approval/ApprovalEnums","epi-cms/content-approval/viewmodels/ApprovalStepViewModel","epi/shell/command/withConditionalConfirmation","dojo/Stateful","epi/shell/DestroyableByKey","epi/shell/_ContextMixin","epi-cms/content-approval/command/SaveApprovalDefinition","epi-cms/content-approval/command/CancelChanges","epi/shell/store/SortableMemory","dojo/store/Observable","epi/i18n!epi/nls/episerver.cms.contentapproval","epi/i18n!epi/nls/episerver.cms.languageselector","epi/i18n!epi/nls/episerver.shared.action"],function(_1,_2,on,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14){return _1([_b,_c,_d],{approvalSteps:null,approvalService:null,userStore:null,commands:null,isDirty:false,isDeclineCommentRequired:false,isApproveCommentRequired:false,isStartCommentRequired:false,selfApprove:true,isEnabled:false,isInherited:false,selectedLanguage:null,approvalLink:null,content:null,isValid:true,isReadOnly:false,isOptionsEnabled:true,languages:null,filterOptions:null,approvalInheritedFrom:null,languageOptions:null,showValidations:false,status:_8.definitionStatus.inherited,_approvalStepsQuery:null,_originalDefinition:null,_validationMessageIds:[],_contextService:null,_messageService:null,constructor:function(_15,_16,_17,_18,_19,_1a,_1b){this.approvalService=_16||_5.resolve("epi.cms.ApprovalService");this._contextService=_17||_5.resolve("epi.shell.ContextService");this._messageService=_18||_5.resolve("epi.shell.MessageService");this.userStore=_19||_5.resolve("epi.storeregistry").get("epi.cms.notification.users");this._contentStore=_1a||_5.resolve("epi.storeregistry").get("epi.cms.content.light");this._typeDescriptorManager=_1b||_7;},postscript:function(){this.inherited(arguments);_3(this.getCurrentContext()).then(this.contextChanged.bind(this));},destroy:function(){this.inherited(arguments);this._removeEventListeners();},contextChanged:function(_1c){this.set("approvalLink",_1c.id);this.approvalService.getDefinition(_1c.id).then(this.loadApprovalDefinition.bind(this)).then(function(){this._contentStore.get(_1c.id).then(this.set.bind(this,"content"));}.bind(this));},createApprovalStep:function(_1d){if(!this._canEditApprovalSteps()){return;}var _1e=this.approvalSteps,_1f=_1e.getSibling(_1d),_20;_20=new _9({languages:this.languages,reviewers:[],userStore:this.userStore,showValidations:this.showValidations});this._addEventListeners(_20);_1e.add(_20,{before:_1f});},getWarningMessage:function(){if(this.get("isInherited")&&this.approvalInheritedFrom){var _21=this.get("isEnabled")?_12.component.inheritedenabled:_12.component.inheriteddisabled;return _2.replace(_21,{name:this.approvalInheritedFrom.name});}else{if(!this.get("isEnabled")){return _12.component.disabledwarning;}}},goToInheritedSequence:function(){this.approvalService.navigateToDefinition(this.get("approvalInheritedFrom").contentLink);},inheritDefinition:function(){var _22=this.get("approvalLink"),_23=this.status;this.set("status",_8.definitionStatus.inherited);return this.approvalService.inheritDefinition(_22).then(this.loadApprovalDefinition.bind(this)).otherwise(this.set.bind(this,"status",_23));},moveApprovalStep:function(_24,up){if(!this._canEditApprovalSteps()){return;}var _25=this.approvalSteps,_26=_25.getSibling(_24,up);if(!_26){return;}if(!up){_26=_25.getSibling(_26);}_25.put(_24,{before:_26});},removeApprovalStep:function(_27){if(!this._canEditApprovalSteps()){return;}if(_27.canBeDeleted){this.approvalSteps.remove(_27.id);}},loadApprovalDefinition:function(_28){this._originalDefinition=null;this.set({approvalInheritedFrom:_28.approvalInheritedFrom,languages:_28.languages,status:_28.status,isReadOnly:_28.isReadOnly,isDeclineCommentRequired:_28.isDeclineCommentRequired,isApproveCommentRequired:_28.isApproveCommentRequired,isStartCommentRequired:_28.isStartCommentRequired,selfApprove:_28.selfApprove,showValidations:false});this._createApprovalSteps(_28.approvalSteps);this._originalDefinition=this.serialize();},saveApprovalDefinition:function(){var _29=this.serialize();return this.approvalService.saveDefinition(_29).then(this.loadApprovalDefinition.bind(this));},serialize:function(){var _2a=this.approvalSteps.data.map(function(_2b){return _2b.serialize();});return {contentLink:this.get("approvalLink"),approvalSteps:_2a,isDeclineCommentRequired:this.isDeclineCommentRequired,isApproveCommentRequired:this.isApproveCommentRequired,isStartCommentRequired:this.isStartCommentRequired,selfApprove:this.selfApprove,status:this.status};},validate:function(){var _2c=null;this.approvalSteps.data.forEach(function(_2d){_2d.validate();});if(this._hasErrors()){_2c={level:"error",dialog:{description:_12.validationmessage.notenoughreviewersmessage.description}};}else{if(this._hasWarnings()){_2c={level:"warning",dialog:{title:_12.validationmessage.stephaswarnings.title,description:_12.validationmessage.stephaswarnings.description,confirmActionText:_12.action.saveanyway,cancelActionText:_14.cancel}};}}return _2c;},enable:function(){this.set("status",_8.definitionStatus.enabled);this._updateIsSequenceEnabled();},disable:function(){this.set("showValidations",false);this.set("status",_8.definitionStatus.disabled);this._updateApprovalSteps();this._updateIsSequenceEnabled();return this.saveApprovalDefinition().otherwise(function(){this.set("showValidations",true);this.enable();}.bind(this));},iconClass:function(){return this.content?this._typeDescriptorManager.getValue(this.content.typeIdentifier,"iconClass"):null;},_createApprovalSteps:function(_2e){var _2f=(_2e||[this._createEmptyStep()]).map(this._createStepViewModel.bind(this)),_30=_11(new _10({data:_2f}));this.set("approvalSteps",_30);this.set("isDirty",false);this._approvalStepsQuery=_30.query();this._updateApprovalSteps();this.destroyByKey("observeHandle");this.ownByKey("observeHandle",this._approvalStepsQuery.observe(function(){this._updateApprovalSteps();}.bind(this)));},_createEmptyStep:function(){return {reviewers:[]};},_createStepViewModel:function(_31,_32){_31=_2.clone(_31);var _33=new _9({id:_32,languages:this.languages,selfApprove:this.selfApprove,reviewers:_31.reviewers,name:_31.name,userStore:this.userStore});this._addEventListeners(_33);return _33;},_updateApprovalSteps:function(){var _34=this._approvalStepsQuery;if(_34){var _35=_34.length>1,_36=!this._canEditApprovalSteps(),_37=this.selectedLanguage,_38=this.selfApprove;_34.forEach(function(_39){_39.set({canBeDeleted:_35,isReadOnly:_36,selfApprove:_38});_39.filterReviewers(_37);});this._onApprovalStepsChanged();}},_resetValidationMessageIds:function(){this._validationMessageIds.forEach(function(_3a){this._messageService.remove({id:_3a});}.bind(this));this._validationMessageIds=[];if(this.showValidations){this._approvalStepsQuery.forEach(function(_3b){if(!_3b.isValid){_3b.validationMessages.forEach(function(_3c){var _3d;if(_3c.level==="error"){_3d="error";}else{if(_3c.level==="warning"){_3d="warn";}}var _3e=this._messageService.put(_3d,_3c.value,"epi.cms.approval",this.get("approvalLink"));this._validationMessageIds.push(_3e);},this);}},this);}},_onApprovalStepsChanged:function(){this._resetValidationMessageIds();this._validateFilterOptions();var _3f=this.serialize();var _40=_4.areEqual(_3f,this._originalDefinition);this._originalDefinition&&this.set("isDirty",!_40);},_addEventListeners:function(_41){this.own(_41.on("create-step",this.createApprovalStep.bind(this)),_41.on("remove-step",this.removeApprovalStep.bind(this)),_41.on("change",this._onApprovalStepsChanged.bind(this)),_41.watch("isValid",this._onApprovalStepsChanged.bind(this)));},_canEditApprovalSteps:function(){return !this.isReadOnly&&this.status===_8.definitionStatus.enabled;},_commandsGetter:function(){if(this.commands===null){this.commands=[new _e({model:this,order:10}),new _f({model:this,order:20})];}return this.commands;},_createLanguageOptions:function(_42){if(!_42){this.set("languageOptions",null);this.set("filterOptions",null);return;}var _43=_42.map(function(_44){return {label:_44.text,value:_44.value};});this.set("languageOptions",_43);var _45=_2.clone(_43);_45.unshift(this._getDefaultLanguageOption());this.set("filterOptions",_45);},_getDefaultLanguageOption:function(){return {label:_13.alllanguages,value:"",selected:true};},_validateFilterOptions:function(){if(!this.filterOptions){return;}var _46=this._stepsMissingLanguageReviewer();this.filterOptions.forEach(function(_47){_47.isValid=_46.every(function(_48){return _48.get("validationMessages").every(function(_49){if(!_49.languages){return true;}return _49.languages.indexOf(_47.value)===-1;});});});this.set("filterOptions",this.filterOptions);},_hasErrors:function(){return this.approvalSteps.data.some(function(_4a){return !_4a.isValid&&_4a.hasErrors();});},_hasWarnings:function(){return this.approvalSteps.data.some(function(_4b){return !_4b.isValid&&_4b.hasWarnings();});},_stepsMissingLanguageReviewer:function(){return this.approvalSteps.data.filter(function(_4c){return !_4c.isValid&&_4c.validationMessages.some(function(_4d){return _4d.languages;});});},_isDeclineCommentRequiredSetter:function(_4e){this.isDeclineCommentRequired=_4e;this._updateApprovalSteps();},_isApproveCommentRequiredSetter:function(_4f){this.isApproveCommentRequired=_4f;this._updateApprovalSteps();},_isStartCommentRequiredSetter:function(_50){this.isStartCommentRequired=_50;this._updateApprovalSteps();},_selfApproveSetter:function(_51){this.selfApprove=_51;this._updateApprovalSteps();},_isDirtySetter:function(_52){this.isDirty=_52;if(!_52){this._removeEventListeners();return;}if(this._interceptor){return;}this._beforeUnloadHandler=on(window,"beforeunload",function(e){var _53=_12.command.cancelchanges.description;e.returnValue=_53;return _53;});this._interceptor=this._contextService.registerRequestInterceptor(function(){var _54={title:_12.command.cancelchanges.title,description:_12.command.cancelchanges.description};return _6.confirmation(_54).then(this._removeEventListeners.bind(this));}.bind(this));},_isReadOnlySetter:function(_55){this.isReadOnly=_55;this._updateApprovalSteps();this._updateIsSequenceEnabled();},_languagesSetter:function(_56){this.languages=_56;this._createLanguageOptions(this.languages);this._updateApprovalSteps();},_selectedLanguageSetter:function(_57){this.selectedLanguage=!_57?null:_57;this._updateApprovalSteps();},_showValidationsSetter:function(_58){this.showValidations=_58;if(this.approvalSteps&&this.approvalSteps.data){this.approvalSteps.data.forEach(function(_59){_59.set("showValidations",_58);});}},_updateIsSequenceEnabled:function(){this.set("isOptionsEnabled",this._canEditApprovalSteps());},_statusSetter:function(_5a){this.status=_5a;this._updateApprovalSteps();},_isInheritedGetter:function(){return this.get("status")===_8.definitionStatus.inherited;},_isEnabledGetter:function(){if(this.get("status")===_8.definitionStatus.inherited){return this.approvalInheritedFrom&&this.approvalInheritedFrom.isEnabled;}return this.get("status")===_8.definitionStatus.enabled;},_removeEventListeners:function(){this._interceptor&&this._interceptor.remove();this._interceptor=null;this._beforeUnloadHandler&&this._beforeUnloadHandler.remove();this._beforeUnloadHandler=null;}});});