//>>built
define("epi-cms/asset/view-model/HierarchicalListViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/topic","dojo/aspect","dojo/Evented","dojo/Stateful","dojo/when","dojo/promise/all","dijit/registry","dijit/Destroyable","epi","epi/dependency","epi/shell/ClipboardManager","epi/shell/command/_CommandProviderMixin","epi/shell/selection","epi/shell/TypeDescriptorManager","epi-cms/_MultilingualMixin","epi-cms/ApplicationSettings","epi-cms/contentediting/_ContextualContentContextMixin","epi-cms/core/ContentReference","epi-cms/widget/ContentForestStoreModel","epi-cms/widget/ContextualContentForestStoreModel","epi-cms/widget/CreateCommandsMixin","epi-cms/command/CopyContent","epi-cms/command/CutContent","epi-cms/command/DeleteContent","epi-cms/command/PasteContent","epi-cms/component/command/ViewTrash","epi-cms/asset/command/ChangeContextToSelection","epi-cms/asset/command/NewFolder","epi-cms/asset/command/RenameSelectedFolder","epi-cms/asset/command/TranslateSelectedContent","epi-cms/plugin-area/assets-pane"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21,_22){return _2([_7,_6,_14,_12,_18,_b],{searchArea:"",searchRoots:"",clipboardManager:null,selection:null,commands:null,createCommands:null,createHierarchyCommands:null,pseudoContextualCommands:null,treePaths:null,selectedTreeItems:null,selectedListItems:null,listQuery:null,listQueryOptions:null,showAllLanguages:true,treeStoreModelClass:null,treeStoreModel:null,store:null,searchStore:null,storeKey:"epi.cms.content.light",mainNavigationTypes:null,containedTypes:null,noDataMessages:null,noDataMessage:"",_profile:null,_commandItems:null,_pluginCommands:null,constructor:function(){this._commandRegistry={sort:function(){var _23=[];for(var key in this){if(key!=="toArray"&&key!=="sort"&&this.hasOwnProperty(key)){var _24=this[key].order;if(!_24){_24=100;}_23.push([_24,this[key].command]);}}_23.sort(function(a,b){return a[0]-b[0];});return _23;},toArray:function(){var _25=this.sort();var _26=[];_1.forEach(_25,function(key){_26.push(key[1]);});return _26;}};this.own(_22.on("added, removed",this._setCommands.bind(this)));},postscript:function(_27){this.inherited(arguments);this.contentRepositoryDescriptors=this.contentRepositoryDescriptors||_d.resolve("epi.cms.contentRepositoryDescriptors");_2.safeMixin(this,this.contentRepositoryDescriptors.get(_27.repositoryKey));this._profile=this._profile||_d.resolve("epi.shell.Profile");this.clipboardManager=this.clipboardManager||new _e();this.selection=this.selection||new _10();this.store=this.store||_d.resolve("epi.storeregistry").get(this.storeKey);this.searchStore=this.searchStore||_d.resolve("epi.storeregistry").get("epi.cms.content.search");this._setupTreeStoreModel();this._setupCommands();this._setCommands();this._setupSearchRoots();this.set("listQueryOptions",this.treeStoreModel._queryOptions);},startup:function(){this.inherited(arguments);this._setupSelection();},getCommand:function(_28){return this._commandRegistry[_28]?this._commandRegistry[_28].command:null;},contentContextChanged:function(_29,_2a){this._setupSearchRoots();if(!this._isSupportedContent(_29)){return;}this.selectItemsByContentReference(_29.id,false);},selectItemsByContentReference:function(_2b,_2c){if(!_2b){return;}var _2d=_15.toContentReference(_2b);_8(this.store.get(_2d.createVersionUnspecificReference().toString()),function(_2e){this.treeStoreModel.getAncestors(_2e,function(_2f){if(!_2c&&this._isAncestorAssetFolder(_2f)){return;}var _30=[];if(_2e.capabilities.isContentFolder){_2f.push(_2e);}else{_30.push(_2e);}var _31=[_2f];if(_c.areEqual(this.get("treePaths"),_31)&&_c.areEqual(this.get("selectedListItems"),_30)){return;}this.emit("setPathsAndItems",_31,_30);}.bind(this));}.bind(this));},selectListItemsByContentReferences:function(_32){_9(_32.map(function(_33){return _8(this.store.get(_33));}.bind(this))).then(function(_34){this.set("selectedListItems",_34);}.bind(this));},_isAncestorAssetFolder:function(_35){if(_35.length===1){return true;}return _35.some(function(_36){return this._isAssetsFolder(_36);}.bind(this));},_isAssetsFolder:function(_37){return _37.typeIdentifier==="episerver.core.contentassetfolder"||_15.compareIgnoreVersion(_37.contentLink,_13.contentAssetsFolder);},updateTreePaths:function(_38){var _39=this.get("treePaths");if(!_39||!_39.length){return;}var _3a=this._getAssetFolderIndex(_39);if(this._selectionContainsAssetFolder(_3a)){var _3b=_3.clone(_39);this._removeOldAssetFolder(_3b,_3a);this._addNewAssetFolder(_38,_3b);if(!_3b.length){_3b=this._getDefaultTreePaths();}_8(_3b).then(function(_3c){this.set("treePaths",_3c);}.bind(this));}},_getAssetFolderIndex:function(_3d){var _3e=-1;_3d.some(function(_3f,_40){return _3f.some(function(_41){var _42=this._isAssetsFolder(_41);if(_42){_3e=_40;}return _42;}.bind(this));}.bind(this));return _3e;},_selectionContainsAssetFolder:function(_43){return _43>-1;},_removeOldAssetFolder:function(_44,_45){_44.splice(_45,1);},_addNewAssetFolder:function(_46,_47){_46.some(function(_48){var _49=this._isAssetsFolder(_48);if(_49){_47.push([this.treeStoreModel.root,_48]);}return _49;}.bind(this));},setSearchText:function(_4a){var _4b=!!_4a;this.set("isSearching",_4b);this._updateSearchListQuery(_4a);var _4c=_4b?null:this.get("selectedListItems")||this.get("selectedTreeItems");this._updateCommands(_4c);},onListItemUpdated:function(_4d){},_isSupportedContent:function(_4e){return !!(_4e&&_4e.id)&&this.containedTypes.some(function(_4f){return _11.isBaseTypeIdentifier(_4e.dataType,_4f);});},_showAllLanguagesSetter:function(_50){this.showAllLanguages=_50;this._updateListQuery(this.selectedTreeItems);if(this.get("isSearching")){var _51=this.get("searchListQuery");this._updateSearchListQuery(_51.queryText);}this.treeStoreModel.set("showAllLanguages",_50);},setTreePaths:function(_52){if(!_c.areEqual(_52,this.get("treePaths"))){this._treePathsSetter(_52);}},_treePathsSetter:function(_53){this.treePaths=_53;this._saveTreePaths(_53);this._changeAttrValue("selectedListItems",null);var _54=_3.clone(_53);var _55=_54?_54.map(function(_56){return _56.pop();}):null;this.set("selectedTreeItems",_55);},_selectedTreeItemsSetter:function(_57){this.selectedTreeItems=_57;this._updateListQuery(_57);if(!this.get("isSearching")){this._updateCommands(_57);}},setSelectedListItems:function(_58){this._selectedListItemsSetter(_58);},_selectedListItemsSetter:function(_59){this.selectedListItems=_59;if(!this.get("isSearching")){this._updateCommands(_59);}},setSelectedSearchResults:function(_5a){this._selectedSearchResultsSetter(_5a);},_selectedSearchResultsSetter:function(_5b){this.selectedSearchResults=_5b;this._updateCommands(_5b);},updateTreeCommands:function(){this._updateCommands(this.get("selectedTreeItems"));},updateListCommands:function(){this._updateCommands(this.get("selectedListItems"));},_setupSelection:function(){if(!this.roots||!this.roots.length){return null;}_8(this.getCurrentContext(),function(ctx){if(this._isSupportedContent(ctx)){this.contentContextChanged(ctx,null);return;}_8(this._loadTreePaths()).then(function(_5c){if(!_5c){_5c=this._getDefaultTreePaths();}_8(_5c).then(function(_5d){this.set("treePaths",_5d);}.bind(this));}.bind(this));}.bind(this));},_getDefaultTreePaths:function(){if(!this.roots||!this.roots.length){return [];}var _5e=_15.toContentReference(this.roots[0]).toString();return this.store.get(_5e).then(function(_5f){return [[this.treeStoreModel.root,_5f]];}.bind(this));},_setupTreeStoreModel:function(){if(!this.treeStoreModelClass){this.treeStoreModelClass=this.enableContextualContent?_17:_16;}var _60=this.treeStoreModel||new this.treeStoreModelClass({store:this.store,roots:this.roots,typeIdentifiers:this.mainNavigationTypes,containedTypes:this.containedTypes,notAllowToCopy:this.preventCopyingFor,notAllowToDelete:this.preventDeletionFor,notSupportContextualContents:this.preventContextualContentFor,autoSelectPastedItem:false,onAddDelegate:_3.hitch(this,function(_61){var _62=_a.getEnclosingWidget(_61.domNode),_63=_62&&_62.item,_64=(typeof (this.treeStoreModel.canEdit)==="function")&&this.treeStoreModel.canEdit(_63);if(_64){_61.edit();var _65=function(){_4.publish("/epi/cms/contentdata/childrenchanged",_63.parentLink);};var _66=_61.on("rename",function(){_66.remove();_65();});var _67=_61.on("cancelEdit",function(){_67.remove();_65();});}}),onRefreshRoots:_3.hitch(this,this._setupSearchRoots),onPasteItemsFailed:_3.hitch(this,this._pasteItemsFailed),additionalQueryOptions:{sort:this._getSortSettings()}});this.own(_60,_5.after(_60,"rename",this._afterRename.bind(this)));this.set("treeStoreModel",_60);},_afterRename:function(_68){return _68.then(function(_69){return this.store.refresh(_69.contentLink).then(function(_6a){var _6b=this.selectedTreeItems;if(_6b&&_6b.length===1){if(_6b[0].contentLink===_6a.contentLink){this.set("selectedTreeItems",[_6a]);}}}.bind(this));}.bind(this));},_getSortSettings:function(){return [{attribute:"name",descending:false}];},_setupSearchRoots:function(){var _6c=this.roots instanceof Array&&this.roots.length>0?_3.clone(this.roots):[];_8(this.getCurrentContent()).then(_3.hitch(this,function(_6d){var _6e=_6d&&_6d.assetsFolderLink;if(_6e&&typeof this._getPseudoContextualContent==="function"&&_6e!==this._getPseudoContextualContent()){_6c.push(_6e);}})).always(_3.hitch(this,function(){this.set("searchRoots",_6c.join(","));}));},_setupCommands:function(){var _6f={category:"context",model:this.treeStoreModel,selection:this.selection,clipboard:this.clipboardManager};this.createHierarchyCommands={};var _70=1;_1.forEach(this.mainNavigationTypes,function(_71){this.createHierarchyCommands[_71]={command:new _1f(_3.mixin({typeIdentifier:_71},_6f)),order:_70};_70=_70+1;},this);this.createCommands=this.getCreateCommands(_70);var _72=_1.filter(this.containedTypes,function(_73){return this.mainNavigationTypes.indexOf(_73)<0;},this);var _74={rename:{command:new _20(_6f),order:10},cut:{command:new _1a(_6f),order:20},copy:{command:new _19(_6f),order:30},paste:{command:new _1c(_3.mixin({typeIdentifiers:this.mainNavigationTypes},_6f)),order:40},edit:{command:new _1e(_3.mixin({forceReload:true,forceContextChange:true,typeIdentifiers:_72},_6f)),order:3},translate:{command:new _21(_6f)},"delete":{command:new _1b(_6f),order:50},trash:{command:new _1d({typeIdentifiers:this.mainNavigationTypes,order:60}),order:60}};this._commandRegistry=_3.mixin(this._commandRegistry,this.createHierarchyCommands,this.createCommands,_74);this.pseudoContextualCommands=this._getPseudoContextualCommands();},_setCommands:function(){var _75=[];_22.get().forEach(function(_76){_76.category="context";_75.push(_76);});this._pluginCommands=_75;var _77=this._commandRegistry.toArray().concat(_75);this.set("commands",_77);},_pasteItemsFailed:function(_78){this.set("selectedListItems",_78);},_updateListQuery:function(_79){var _7a=null;if(_79&&_79.length>0){_7a=this._createListChildrenQuery(_79);this.set("noDataMessage",_79.length>1?this.noDataMessages.multiple:this.noDataMessages.single);}this.set("listQuery",_7a);},_createListChildrenQuery:function(_7b){var _7c=_1.filter(this.containedTypes,function(_7d){return this.mainNavigationTypes.indexOf(_7d)<0;},this);var ids=_7b.map(function(_7e){return _7e.contentLink.toString();});return {references:ids,query:"getchildren",allLanguages:this.showAllLanguages,typeIdentifiers:_7c};},_updateSearchListQuery:function(_7f){var _80=null;if(_7f){_80=this._createListSearchQuery(_7f);}this.set("searchListQuery",_80);},_createListSearchQuery:function(_81){return {queryText:_81,query:"searchcontent",allLanguages:this.showAllLanguages,contentSearchAreas:this.get("searchArea"),searchRoots:this.get("searchRoots"),maxResults:1000,filterDeleted:true};},_updateCommands:function(_82){if(_c.areEqual(this._commandItems,_82)){return;}this._commandItems=_82;this._updateSelection(_82);this._updateCommandModels(_82);if(_82&&_82.length===1){this.decoratePseudoContextualCommands(this.pseudoContextualCommands);}},_updateSelection:function(_83){var _84=_83?_83.map(function(_85){return {type:"epi.cms.contentdata",data:_85};}):[];this.selection.set("data",_84);},_updateCommandModels:function(_86){var _87=this.createCommands;for(var key in _87){_87[key].command.set("model",_86);}this._pluginCommands.forEach(function(_88){_88.set("model",_86);});},_saveTreePaths:function(_89){this._profile.set(this.componentId+"_treePaths",_89);},_loadTreePaths:function(){return this._profile.get(this.componentId+"_treePaths");},_getPseudoContextualCommands:function(){var key,_8a=[];for(key in this.createCommands){_8a.push(this.createCommands[key].command);}for(key in this.createHierarchyCommands){_8a.push(this.createHierarchyCommands[key].command);}_8a.push(this._commandRegistry.paste.command);return _8a;},upload:function(_8b){}});});