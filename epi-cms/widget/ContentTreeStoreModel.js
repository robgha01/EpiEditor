//>>built
define("epi-cms/widget/ContentTreeStoreModel",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/Stateful","dojo/aspect","dojo/Deferred","dojo/promise/all","dojo/when","dojo/topic","epi","epi/dependency","epi/shell/TypeDescriptorManager","epi/shell/_ContextMixin","epi/shell/ViewSettings","epi-cms/ApplicationSettings","epi-cms/contentediting/ContentActionSupport","epi-cms/core/ContentReference","epi-cms/widget/_HierarchicalModelMixin","epi-cms/widget/viewmodel/_UpdateableStoreModelMixin"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14){return _3([_5,_13,_14,_e],{store:null,service:null,root:null,notAllowToDelete:null,notAllowToCopy:null,typeIdentifiers:null,showAllLanguages:true,getChildrenQuery:"getchildren",getRootChildrenQuery:null,_observers:null,_defaultDataStoreName:"epi.cms.content.light",additionalQueryOptions:{},createAsLocalAsset:false,autoSelectPastedItem:true,constructor:function(_15){_3.safeMixin(this,_15);this._observers={};this.store=this.store||_c.resolve("epi.storeregistry").get(this._defaultDataStoreName);this.service=this.service||_c.resolve("epi.cms.ContentHierarchyService");this._queryOptions=_4.mixin({ignore:["query"],comparers:{typeIdentifiers:_4.hitch(this,function(_16,_17){return _1.some(_16,_4.hitch(this,function(_18){return _18===_17.typeIdentifier||_d.isBaseTypeIdentifier(_17.typeIdentifier,_18);}));}),referenceId:function(_19,_1a){return _12.compareIgnoreVersion(_19,_1a.parentLink);},allLanguages:function(_1b,_1c){if(_1b||!_1c.currentLanguageBranch){return true;}return _b.areEqual(_10.currentContentLanguage,_1c.currentLanguageBranch.languageId);},references:function(_1d,_1e){return _1d.some(function(_1f){return _12.compareIgnoreVersion(_1f,_1e.parentLink);});}},sort:this._getSortSettings(this.typeIdentifiers)},this.additionalQueryOptions);var _20=_2.subscribe("/epi/cms/contentdata/updated",this,function(_21){var _22=new _12(_21.contentLink).createVersionUnspecificReference().toString();this.store.refresh(_22).then(_4.hitch(this,function(){if(_21.recursive){this.onItemChildrenReload(_21);}}));});var _23=_2.subscribe("/epi/cms/contentdata/childrenchanged",_4.hitch(this,this._childrenChanged));var _24=_6.after(this.store,"notify",_4.hitch(this,function(_25,id){this.onChange(_25);}),true);this._handles=[_20,_23,_24];},destroy:function(){for(var id in this._observers){if(this._observers[id]){this._observers[id].remove();this._observers[id]=null;}}if(this._handles){_1.forEach(this._handles,function(_26){_26.remove();});this._handles=null;}},isSupportedType:function(_27){return _1.some(this.typeIdentifiers,function(_28){return _28===_27||_d.isBaseTypeIdentifier(_27,_28);});},_showAllLanguagesSetter:function(_29){this.showAllLanguages=_29;this.onItemChildrenReload(this.root);},getRoot:function(_2a,_2b){if(_4.isArray(this.root)){_2a({});}else{_9(this.store.get(this.root),_2a,_2b);}},mayHaveChildren:function(_2c){return _2c.hasChildren;},getChildren:function(_2d,_2e){var id=this.getIdentity(_2d),_2f=this._observers[id],_30=id===this.root,_31=_30&&this.getRootChildrenQuery?this.getRootChildrenQuery:this.getChildrenQuery,_32=this._createQuery({referenceId:id,query:_31}),_33=this.store.query(_32,this._queryOptions);if(_2f){_2f.remove();delete this._observers[id];}this._observers[id]=_33.observe(function(_34,_35,_36){_9(this.store.query(_32,this._queryOptions),this.onChildrenChange.bind(this,_2d));}.bind(this),true);_9(_33,_2e);},_getSortSettings:function(_37){if(!_37){return {};}if(_37 instanceof String){_37=[_37];}var _38,_39=[];_37.map(function(_3a){_38=_d.getValue(_3a,"sortKey");if(_38){_39.push(_38.sortDescending?{attribute:_38.columnName,descending:true}:{attribute:_38.columnName});}});return _39;},_createQuery:function(_3b,_3c){var _3d=this.typeIdentifiers&&(_4.isArray(this.typeIdentifiers)?this.typeIdentifiers:this.typeIdentifiers.split(","));var _3e=this.showAllLanguages?{allLanguages:true}:{},_3f=_3c?{}:{typeIdentifiers:_3d};var _40=_4.mixin(_3b,_3f,_3e);return _40;},_createChildrenQuery:function(_41,_42){var _43=_4.mixin(_41,{query:"getchildren"});return this._createQuery(_43,_42);},move:function(_44,_45){var _46=_44.map(function(_47){return _47.data;});return this.pasteItems(_46,_45,false);},remove:function(_48){_48=_48.map(function(_49){return _49.data;});var _4a=_48.map(function(_4b){return this.store.remove(_4b.contentLink);},this);return _8(_4a).then(_4.hitch(this,function(){this.onDeleted(_48);}));},copy:function(_4c,_4d){var _4e=_4c.map(function(_4f){return _4f.data;});return this.pasteItems(_4e,_4d,true);},pasteItems:function(_50,_51,_52,_53){var _54=_52?"copy":"move",ids,_55=[],_56;ids=_50.map(this.getIdentity,this);return _9(this.getCurrentContext()).then(function(ctx){return this._isNodeAContextAncestor(ids,ctx).then(function(_57){_56=_57;return _57;});}.bind(this)).then(function(){return this.service[_54](ids,this.getIdentity(_51),this.createAsLocalAsset,_53);}.bind(this)).then(function(_58){return _8(_50.map(function(_59){var _5a=_58.extraInformation[_59.contentLink].extraInformation||_59.contentLink;var _5b=_12.toContentReference(_5a).createVersionUnspecificReference().toString();return this.store.get(_5b);},this));}.bind(this)).then(function(_5c){if(_51.isWastebasket){this._handleSelect(_50,_56);}else{_a.publish("/epi/cms/contentdata/childrenchanged",_51.contentLink);var _5d=[];_50.forEach(function(_5e){if(_5d.indexOf(_5e.parentLink)===-1){_a.publish("/epi/cms/contentdata/childrenchanged",_5e.parentLink);_5d.push(_5e.parentLink);}});}this._handleDelete(_5c);_5c.forEach(function(_5f){this._onPasteComplete(_5f,_5f.isDeleted,null,_51);},this);_55=_5c.filter(function(_60){return _50.some(function(_61){return (_61.contentLink===_60.contentLink)&&(_61.parentLink===_60.parentLink);});});if(this.createAsLocalAsset===true){_a.publish("/epi/cms/action/createlocalasset");}}.bind(this)).then(function(){if(_55.length>0){this.onPasteItemsFailed(_55);}}.bind(this));},pasteItem:function(_62,_63,_64,_65,_66){return this.pasteItems([_62],_64,_65,_66).then(function(_67){return _67.extraInformation[_62.contentLink];});},onPasteComplete:function(){},_onPasteComplete:function(_68,_69,_6a,_6b){this.onPasteComplete();this._selectItemOnPasteComplete(_68,_69,_6a,_6b);},_selectItemOnPasteComplete:function(_6c,_6d,_6e,_6f){if(this.autoSelectPastedItem&&_6c&&_6c.contentLink&&!_6d){this.onSelect(_6c.contentLink,true);}},newItem:function(_70,_71){this.newItems([_70],_71);},newItems:function(_72,_73){var _74=_72.map(function(_75){return _75.dndData.data;});this._pasteNewItems(_74,_73);},_pasteNewItems:function(_76,_77){this.pasteItems(_76,_77,false);},_updateItemChanged:function(_78){_9(this.store.refresh(_78),_4.hitch(this,function(_79){this._childrenChanged(_79);}));},_childrenChanged:function(_7a){var dfd=new _7();this.getChildren(_7a,_4.hitch(this,function(_7b){this.onChildrenChange(_7a,_7b);dfd.resolve(_7b);}));return dfd;},_isNodeAContextAncestor:function(_7c,_7d){var dfd=new _7(),_7e=_7c.some(function(_7f){return _12.compareIgnoreVersion(_7f,_7d.id);});if(_7e){dfd.resolve(true);}else{this.getAncestors(_7d,function(_80){var _81=_80.some(function(_82){return _7c.indexOf(_82.contentLink)>-1;});dfd.resolve(_81);});}return dfd.promise;},_handleSelect:function(_83,_84){var _85,_86;if(_84){_85=_83[0];if(_85.capabilities.isPage){_86=_83.length===1&&_85;this.onSelect(_86?_86.parentLink:_10.startPage,true);return;}_a.publish("/epi/shell/context/request",{uri:_f.settings.defaultContext});}var _87=_83.filter(function(_88){return this.isSupportedType(_88.typeIdentifier);}.bind(this));if(_87.length===1){this.onSelect(_87[0].parentLink,true);}else{if(_87.length>1){this.onSelect(_10.globalAssetsFolder,true);}}},checkItemAcceptance:function(_89,_8a){var _8b=_8a.getSelectedNodes?_8a.getSelectedNodes():_8a.getSelectedTreeNodes();var _8c=_8b.map(function(_8d){var _8e=_8a.getItem(_8d.id);var _8f=_8e.data;if(_8f.dndData){_8f=_8f.dndData;}return this.canPaste(_8f,_89);},this);return _8(_8c).then(function(_90){return _90.every(function(_91){return _91;});});},_handleDelete:function(_92){var _93=_92.filter(function(_94){return _94.isDeleted;});if(_93.length>0){_93.forEach(function(_95){var id=this.getIdentity(_95),_96=this._observers[id];if(_96){_96.remove();delete this._observers[id];}this.onDelete(_95,true);},this);this.onDeleted(_93);}},getIdentity:function(_97){if(_4.isObject(_97)){return this.store.getIdentity(_97);}return _97;},getObjectIconClass:function(_98,_99){var _9a=_d.getValue(_98.typeIdentifier,"iconClass");if(!_9a){return _99;}var _9b="";switch(parseInt(_98.contentLink,10)){case _10.globalAssetsFolder:_9b="AllSites";break;case _10.siteAssetsFolder:_9b="ThisSite";break;default:break;}return (_9b===""&&_9a===_99)?_9a:(_99+" "+_9a+_9b);},getLabel:function(_9c){return _9c.name;},canExpandTo:function(_9d){var _9e=new _7();this.getAncestors(_9d,_4.hitch(this,function(_9f){_9e.resolve(this.getIdentity(_9f[0])===this.root.id);}));return _9e.promise;},canCopy:function(_a0){if(!_a0){return false;}var _a1=_a0.contentLink,_a2=_a1===this.root||(_1.indexOf(this.notAllowToCopy,_a1)>=0);return !_a2&&_11.hasAccess(_a0.accessMask,_11.accessLevel.Read)&&_11.hasProviderCapability(_a0.providerCapabilityMask,_11.providerCapabilities.Copy);},canCut:function(_a3){if(!_a3){return false;}var _a4=_a3.contentLink,_a5=_a4===this.root||(_1.indexOf(this.notAllowToDelete,_a4)>=0);return !_a5&&_11.isActionAvailable(_a3,_11.action.Delete,_11.providerCapabilities.Move,true);},canDelete:function(_a6){if(!_a6){return false;}var _a7=_a6.contentLink,_a8=_a7===this.root||(_1.indexOf(this.notAllowToDelete,_a7)>=0);return !_a8&&_11.isActionAvailable(_a6,_11.action.Delete,_11.providerCapabilities.Delete,true);},canPaste:function(_a9,_aa,_ab){if(!_a9||!_aa){return false;}var _ac=_ab&&_aa.isWastebasket,_ad=!_ab&&(this.getIdentity(_a9)===this.getIdentity(_aa)),_ae=!_ab&&(_a9.parentLink===this.getIdentity(_aa)),_af=_11.isActionAvailable(_aa,_11.action.Create,_11.providerCapabilities.Create,true);return !_aa.isDeleted&&!_ac&&!_ad&&!_ae&&_af;},canEdit:function(_b0){if(!_b0){return false;}var _b1=_b0.contentLink,_b2=_b1===this.root;return !_b2&&_11.hasAccess(_b0.accessMask,_11.accessLevel.Edit);},onItemChildrenReload:function(_b3){},onChange:function(){},onChildrenChange:function(){},onDelete:function(){},onDeleted:function(_b4){},onSelect:function(_b5,_b6,_b7){},onPasteItemsFailed:function(_b8){}});});