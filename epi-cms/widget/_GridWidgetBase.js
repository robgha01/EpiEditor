//>>built
define("epi-cms/widget/_GridWidgetBase",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dom-construct","dojo/keys","dojo/topic","dojo/when","dgrid/Keyboard","dgrid/OnDemandGrid","dgrid/Selection","dijit/layout/_LayoutWidget","epi","epi/datetime","epi/UriParser","epi/username","epi/shell/dgrid/Formatter","epi/shell/TypeDescriptorManager","epi-cms/_ContentContextMixin","epi-cms/core/ContentReference","epi-cms/dgrid/DnD","epi-cms/dgrid/formatters","epi-cms/dgrid/WithContextMenu","epi/dependency"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,DnD,_14,_15,_16){return _1([_b,_12],{_gridClass:_1([_9,_10,_a,DnD,_8,_15]),storeKeyName:null,grid:null,store:null,ignoreVersionWhenComparingLinks:true,trackActiveItem:true,defaultGridMixin:null,currentItem:null,contextChangeEvent:"click",forceContextReload:false,selectionMode:"single",selection:null,postMixInProperties:function(){this.inherited(arguments);this.defaultGridMixin={selectionMode:this.get("selectionMode"),dndParams:{creator:_2.hitch(this,this._dndNodeCreator),copyOnly:true,selfAccept:false}};if(!this.store&&this.storeKeyName){var _17=_16.resolve("epi.storeregistry");this.store=_17.get(this.storeKeyName);}},startup:function(){this.inherited(arguments);if(this.contextChangeEvent){var _18=_2.hitch(this,"_onChangeContext");this.grid.on(".dgrid-row:"+this.contextChangeEvent,_18);if(typeof this.grid.addKeyHandler=="function"){this.grid.addKeyHandler(_5.ENTER,_18);this.grid.addKeyHandler(_5.SPACE,_18);}}this.grid.on("dgrid-select, dgrid-deselect",_2.hitch(this,"_onSelectionChanged"));this.grid.on("dgrid-error",_2.hitch(this,"_onError"));if(this.trackActiveItem){this.own(_3.after(this.grid,"insertRow",_2.hitch(this,this._selectActiveItem)));}this.own(this.connect(this,"layout",_2.hitch(this,function(){this.grid.resize();})));this.grid.startup();},destroy:function(){if(this.grid){this.grid.destroy();}this.inherited(arguments);},select:function(_19){this.grid.clearSelection();if(_19){var _1a=(_19 instanceof _13?_19:new _13(_19.id)).createVersionUnspecificReference().toString();this.grid.select(_1a);}},_forceKeepContext:function(uri){return this._isSameAsCurrentContext(uri);},_onChangeContext:function(e){this._onChangeContextInternal(e);},_onChangeContextInternal:function(e){var row=this.grid.row(e),uri=row.data.uri,_1b={uri:uri};if(this._forceKeepContext(uri)){return;}this._requestNewContext(_1b,{sender:this,forceReload:this.forceContextReload});},_onSelectionChanged:function(e){var _1c=[];for(var id in this.grid.selection){if(this.grid.selection[id]){var row=this.grid.row(id);_1c.push(row.data);}}this.set("selection",_1c);this.emit("selectionChanged",{selection:_1c});this._onSelect(e);},_onSelect:function(e){},_onError:function(e){var _1d=this.grid.errorMessage;var _1e=e.error;if(_1e.status&&_1e.status===403){_1d=_c.resources.messages.nopermissiontoviewdata;}this._showErrorMessage(_1d);},_requestNewContext:function(_1f,_20){_6.publish("/epi/shell/context/request",_1f,_20);},restore:function(){this.resize();},_isActiveItem:function(row){return _7(this.getCurrentContext(),_2.hitch(this,function(_21){var _22=row.data.uri;return _21&&this._compareUris(_22,_21.uri);}));},_selectActiveItem:function(_23){var row=this.grid.row(_23);if(!row){return _23;}_7(this._isActiveItem(row),_2.hitch(this,function(_24){if(_24){if(this.grid.selectionMode==="single"){this.grid.clearSelection();}this.grid.select(row,null);}}));return _23;},contextChanged:function(_25,_26){this.inherited(arguments);if(_25.type!=="epi.cms.contentdata"){return;}if(!_26||_26.sender!==this){this.onContextChanged(_25);}},onContextChanged:function(_27){this.fetchData();},fetchData:function(){},_showErrorMessage:function(_28){this.grid.cleanup();this.grid.contentNode.innerHTML=_28||"";},contextChangeFailed:function(_29,_2a,_2b){this.inherited(arguments);if(_2b&&_2b.sender===this){this._selectActiveItem();}},_renderContentItem:function(_2c,_2d,_2e,_2f){_2e.innerHTML=_14.contentItem(_2c.typeIdentifier,_2c.missingLanguageBranch,_2d);},_localizeDate:function(_30){return _14.localizedDate(_30);},_createUserFriendlyUsername:function(_31){return _14.userName(_31);},_dndNodeCreator:function(_32,_33){var _34=_11.getAndConcatenateValues(_32.typeIdentifier,"dndTypes");if(!_34&&this.dndTypes){_34=this.dndTypes;}var _35=_4.create("div").appendChild(document.createTextNode(_32.name));return {node:_35,type:_34,data:_32};},_aroundInsertRow:function(_36){return _2.hitch(this,function(_37,_38,_39,i,_3a){var row=_36.apply(this.grid,arguments);var _3b=this.get("currentItem");if(_3b){var _3c=(_3b instanceof _13?_3b:new _13(_3b.id)).createVersionUnspecificReference().toString();if(_3c===_37.contentLink){this.select(_3b);}}return row;});},_getCurrentItem:function(){return _7(this.getCurrentContext(),function(_3d){return {id:_13.tryConvert(_3d.id,_3d).id};});},_setSelectionModeAttr:function(_3e){if(this.grid){this.grid.set("selectionMode",_3e);}this._set("selectionMode",_3e);}});});