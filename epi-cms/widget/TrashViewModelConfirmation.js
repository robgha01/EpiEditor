//>>built
define("epi-cms/widget/TrashViewModelConfirmation",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/aspect","dojo/when","epi/dependency","epi/string","epi/shell/TypeDescriptorManager","epi/shell/widget/dialog/Dialog","epi/shell/DialogService","epi-cms/widget/ContentSelectorDialog","epi-cms/contentediting/ContentActionSupport","epi/i18n!epi/cms/nls/episerver.cms.components.trash"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){return function(_f){var _10=function(_11,_12,_13){return _b.confirmation({description:_8.toHTML(_12),title:_8.toHTML(_11)}).then(function(){return _13;});};var _14=function(_15){var _16=_7.resolve("epi.cms.contentRepositoryDescriptors");var _17=[];_16.list().forEach(function(key){_16.get(key).containedTypes.forEach(function(_18){if(_9.isBaseTypeIdentifier(_15,_18)){_17=_17.concat(_16.get(key).containedTypes);}});});return _17;};var _19=function(_1a,_1b,_1c){var df=new _3(),_1d=_e.restore.dialog,_1e=_9.getValue(_1a.typeIdentifier,"containerTypes"),_1f={showButtons:false,roots:_1b,multiRootsMode:true,canSelectOwnerContent:false,allowedTypes:_1e||_14(_1a.typeIdentifier),selectedContentType:_1a.typeIdentifier,showAllLanguages:true};var _20=new _c(_1f);var _21=new _a({title:_8.toHTML(_1d.title),description:_1c||_8.toHTML(_1d.description),confirmActionText:_8.toHTML(_e.restore.label),content:_20});var _22=function(_23){_6(_f.contentStore.query({id:_23}),function(_24){_21.onActionPropertyChanged({name:"ok"},"disabled",!_24);});};_20.on("change",function(_25){if(_25){_22(_25);}else{_21.onActionPropertyChanged({name:"ok"},"disabled",true);}});_21.on("execute",function(){df.resolve(_20.get("value"));});_21.on("onHide",function(){df.cancel();});_21.show();_20.onChange(null);return df;};var _26=function(_27,_28){var _29=_d.action.Create,_2a=_d.providerCapabilities.Create,_2b=_28&&!(_28.isWastebasket||_28.isDeleted)&&_d.isActionAvailable(_28,_29,_2a,true,true);if(!_2b){_b.alert(_8.toHTML(_e.restore.userdonothavepermission));return false;}return true;};var _2c=function(_2d){var _2e=_7.resolve("epi.cms.contentRepositoryDescriptors");var _2f=[];_2e.list().forEach(function(key){var _30=_2e.get(key);_30.containedTypes.forEach(function(_31){if(_9.isBaseTypeIdentifier(_2d.typeIdentifier,_31)){_30.roots.forEach(function(_32){if(_2f.indexOf(_32)===-1){_2f.push(_32);}});}});});return _2f;};var _33=function(_34,_35,_36,_37,_38,_39){var _3a;if(!_38||!_34||!_35){return false;}if(_37&&_36){_3a=_10(_e.restore.label,_e.restore.confirmquestion,_36);}else{_3a=_19(_35,_2c(_35),_39);}_6(_3a,function(_3b){_6(_34.contentStore.get(_3b),function(_3c){if(!_26(_35,_3c)){return false;}return _38.apply(_34,[_35,_3b]);});},function(){return false;});};_5.around(_f,"restore",function(_3d){return function(_3e,_3f){return _6(_f.contentStore.query({id:_3e.contentLink}),_4.hitch(this,function(_40){var _41=null;var _42=null;if(_40.hasOwnProperty("statusCode")&&(_40.statusCode===401||_40.statusCode===403)){_41=_8.toHTML(_e.restore.userdonothavepermission);}if(_40.hasOwnProperty("isDeleted")&&!_40.isDeleted){_41=_8.toHTML(_e.restore.contentalreadyrestored);_42=function(){_f.updateTrash(_f.get("currentTrash"));};}if(_41){_b.alert(_41).then(_42);return false;}var _43=_f.get("currentTrash");if(_40.parentLink!==_43.wasteBasketLink){return _6(_19(_40,_2c(_40)),function(_44){_6(_f.contentStore.get(_44),function(_45){if(!_26(_40,_45)){return false;}return _3d.apply(_f,[_40,_44]);});},function(){return false;});}else{return _6(_f.getOldParent(_40.contentLink),function(_46){var _47=_46?_46.contentLink:null;_33(_f,_40,_47,_47!=null,_3d);});}}),_4.hitch(this,function(_48){_b.alert(_8.toHTML(_e.restore.contentdeletedpermanently)).then(function(){_f.updateTrash(_f.get("currentTrash"));});return false;}));};});return _f;};});