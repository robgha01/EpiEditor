//>>built
require({cache:{"url:epi-cms/widget/templates/ThumbnailSelector.html":"<div data-dojo-attach-point=\"inputContainer, stateNode, dropAreaNode\" id=\"widget_${id}\"\r\n     class=\"dijitReset dijitInline dijitInputContainer epi-resourceInputContainer thumbnail-editor\">\r\n    <div class=\"dijitTextBox\" data-dojo-attach-point=\"_dropZone\" data-dojo-type=\"epi-cms/widget/FilesUploadDropZone\" data-dojo-attach-event=\"onDrop: _onDrop\" data-dojo-props=\"outsideDomNode: this.domNode\"></div>\r\n    <a class=\"thumbnail-button dijitTextBox\" href=\"#\" data-dojo-type=\"dijit/layout/_LayoutWidget\" data-dojo-attach-point=\"button\" data-dojo-attach-event=\"onClick: _onButtonClick\" >\r\n        <figure data-dojo-attach-point=\"displayNode\" class=\"dijitHidden\">\r\n            <img data-dojo-attach-point=\"thumbnail\"/>\r\n            <figcaption class=\"dijitInline dojoxEllipsis\">\r\n                <span data-dojo-attach-point=\"selectedContentNameNode\"></span>\r\n                <span data-dojo-attach-point=\"selectedContentLinkNode, resourceName\"></span>\r\n            </figcaption>\r\n        </figure>\r\n        <div data-dojo-type=\"dijit/ProgressBar\" data-dojo-attach-point=\"progressBar\" data-dojo-props=\"maximum:100\"></div>\r\n        <div data-dojo-attach-point=\"actionsContainer\" class=\"epi-content-area-actionscontainer\">\r\n            <span>${resources.selectimage}</span>\r\n        </div>\r\n    </a>\r\n\r\n    <a data-dojo-attach-point=\"clearButton\" href=\"#\" class=\"epi-clearButton\">&nbsp;</a>\r\n</div>\r\n"}});define("epi-cms/widget/ThumbnailSelector",["dojo/_base/declare","dojo/when","dojo/on","dojo/topic","dojo/dom-class","dijit/focus","dijit/ProgressBar","epi/Url","epi/routes","epi/shell/dnd/Target","epi/shell/DialogService","epi-cms/core/ContentReference","epi-cms/widget/MediaSelector","epi-cms/contentediting/_ContextualContentContextMixin","epi-cms/command/UploadContent","epi-cms/widget/UploadUtil","epi-cms/widget/viewmodel/MultipleFileUploadViewModel","epi-cms/widget/LocalFolderUploader","dojo/text!./templates/ThumbnailSelector.html","epi/i18n!epi/cms/nls/episerver.cms.widget.thumbnailselector","epi-cms/widget/FilesUploadDropZone"],function(_1,_2,on,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13){var _14=_1(_d,{_dialogService:null,allowedExtensions:[],postCreate:function(){this.inherited(arguments);this._dialogService=this._dialogService||_a;if(this._currentContext.currentMode==="create"){return;}this.uploadCommand=new _e({viewModel:this});_2(this.getCurrentContent()).then(function(_15){this._dropZone.set("settings",{enabled:true,validSelection:true,dropFolderName:this.getContextualRootName(_15),descriptionTemplate:_13.dropfile});}.bind(this));},_onButtonClick:function(){if(this.progressBar.progress&&this.progressBar.progress!==this.progressBar.maximum){return;}this.inherited(arguments);},upload:function(_16){var _17=new _11({model:new _10({store:this._store,query:this.query}),uploadProgressThreshold:40,thumbnailMaxFileSize:50*1024*1024});_17.own(on(_17,"uploadProgress",function(_18){if(this._destroyed){return;}this.progressBar.update({progress:_18});}.bind(this)));_17.own(on(_17,"uploadFilePreview",function(_19,_1a){if(this._destroyed){return;}_4.add(this.domNode,"uploading");this.set("selectedContentName",_13.uploading+_1a);this.set("previewUrl",_19);this.thumbnail.src=_19;}.bind(this)));_17.own(_17.on("uploadComplete",function(_1b){if(this._destroyed){return;}this.progressBar.update({progress:0});_5.focus(this.button.domNode);_4.remove(this.domNode,"uploading");if(!_1b||_1b.length===0){this.set("value",this.value);this._dialogService.alert(_13.failed);return;}if(_1b[0].statusMessage){this.set("value",this.value);this._dialogService.alert(_1b[0].statusMessage);return;}this.set("value",_1b[0].contentLink);this.onChange(this.value);_3.publish("/epi/cms/upload",this.assetsFolderLink);}.bind(this)));_17.upload(_16);},_refreshTargetUploadContent:function(){var _1c=this;if(this.assetsFolderLink&&!this.isPseudoContextualRoot({contentLink:this.assetsFolderLink})){return this.assetsFolderLink;}function _1d(_1e){if(!_1c.isPseudoContextualRoot({contentLink:_1e.assetsFolderLink})){return _1e.assetsFolderLink;}return _1c._store.refresh(_1e.contentLink).then(function(_1f){return _1f.assetsFolderLink;});};return _2(this.getCurrentContent()).then(function(_20){return _2(_1d(_20)).then(function(_21){_1c.assetsFolderLink=new _b(_21).createVersionUnspecificReference().toString();_1c.query.references=[_1c.assetsFolderLink];return _2(_1c._store.get(_21)).then(function(_22){_1c.uploadCommand.set("model",_22);});});});},_onDrop:function(evt,_23){_23=_f.filterFileOnly(_23);if(!_23||_23.length!==1){this._dialogService.alert(_13.singleimage);return;}var _24=_23[0].name.split(".").pop().toLowerCase();if(this.allowedExtensions.indexOf(_24)===-1){this._dialogService.alert(_13.wrongfileformat);return;}_2(this._refreshTargetUploadContent()).then(function(){this.uploadCommand.set("fileList",_23);this.uploadCommand.execute();}.bind(this));}});return _1([_c,_14],{resources:_13,templateString:_12,_setPreviewUrlAttr:function(_25){this.inherited(arguments);_4.toggle(this.displayNode,"dijitHidden",!_25);_4.toggle(this.actionsContainer,"dijitHidden",_25);},_getThumbnailUrl:function(_26){var url=new _7(_8.getActionPath({moduleArea:"CMS",controller:"Thumbnail",action:"Generate"}));url.query={contentLink:_26.contentLink,"epi.preventCache":new Date().valueOf()};return url;},_updateDisplayNode:function(_27){this.inherited(arguments);if(_27){this.thumbnail.src=this._getThumbnailUrl(_27).toString();}this.stateNode.title=_27?_27.name:"";},postCreate:function(){this.inherited(arguments);this.query={query:"getchildren",allLanguages:true};},_onButtonClick:function(){if(this.readOnly){return;}this.inherited(arguments);},_setReadOnlyAttr:function(_28){this.inherited(arguments);this.button.domNode.style.display="";this.button.set("readOnly",_28);}});});