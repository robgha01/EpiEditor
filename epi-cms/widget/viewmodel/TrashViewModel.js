//>>built
define("epi-cms/widget/viewmodel/TrashViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/topic","dojo/when","dojo/Stateful","dojo/_base/json","epi/epi","epi/shell/TypeDescriptorManager","epi/dependency","epi/i18n!epi/cms/nls/episerver.cms.components.trash"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _2([_6],{resources:_b,trashes:null,currentTrash:null,queryOptions:null,isEmptyTrash:false,storeRegistry:null,contentStore:null,contentService:null,trashStore:null,showAllLanguages:true,_contentRepositoryDescriptors:null,postscript:function(){this.inherited(arguments);this.storeRegistry=this.storeRegistry||_a.resolve("epi.storeregistry");this.contentStore=this.contentStore||this._getStore();this.contentService=this.contentService||_a.resolve("epi.cms.ContentHierarchyService");this.trashStore=this.trashStore||this.storeRegistry.get("epi.cms.wastebasket");this._contentRepositoryDescriptors=this._contentRepositoryDescriptors||_a.resolve("epi.cms.contentRepositoryDescriptors");if(!this.trashes){this._createTrashes();}},destroy:function(){_8.removeDelegateAspects(this.contentStore);},_getStore:function(){var _c=this.storeRegistry.get("epi.cms.content.light"),_d=this;var _e=_8.delegate(_c,{getChildren:function(_f,_10){var _11=_d.get("currentTrash"),_12=_d._createQueryOptions(_11);_3.mixin(_12.query,{referenceId:_f.contentLink});return this.query(_12.query,_12.options);},mayHaveChildren:function(_13){return _13.hasChildren;}},["notify"]);return _e;},_createTrashes:function(){_5(this.trashStore.query(),function(_14){this.set("trashes",_3.clone(_14));}.bind(this));},_currentTrashSetter:function(_15){this.currentTrash=_15;if(_15.isRequireLoad){this.updateTrash(_15);_15.isRequireLoad=false;}},getEmptyTrashConfirmMessage:function(_16){var _17=_b.emptytrash.singleproviderdescription;if(this.trashes.length>1){_17=_b.emptytrash.description.replace("{0}",_16);}return _17;},updateTrash:function(_18){if(_18&&_18.active){this.set("queryOptions",this._createQueryOptions(_18));}else{this.set("queryOptions",null);}},_createQueryOptions:function(_19){var _1a={referenceId:_19.wasteBasketLink,query:"getchildren"};var _1b={ignore:["query"],comparers:this._createComparers()};if(this.showAllLanguages){_3.mixin(_1a,{allLanguages:this.showAllLanguages});_1b.ignore.push("allLanguages");}if(_19.isSearchable){_3.mixin(_1a,{isSearchable:_19.isSearchable});_1b.ignore.push("isSearchable");}if(_19.queryText){_3.mixin(_1a,{query:"searchdeletedcontent",matchProvider:true,queryText:_19.queryText});}return {query:_1a,options:_1b};},_createComparers:function(){return {referenceId:function(_1c,_1d){return _1c===_1d.parentLink;}};},emptyTrash:function(_1e){if(!_1e){return;}_5(this.trashStore.executeMethod("Empty",_1e),function(_1f){var _20=_1.filter(this.get("trashes"),function(_21){return _21&&_21.wasteBasketLink===_1e;});_1.forEach(_20,function(_22){_22.isRequireLoad=true;});this.isEmptyTrash=true;_4.publish("/epi/cms/trash/empty",_1f.extraInformation);if(this.currentTrash.wasteBasketLink===_1e){this.set("currentTrash",this.currentTrash);}}.bind(this),function(_23){if(_23.status===403){this.set("actionResponse",_b.emptytrash.accessdenied);}}.bind(this));},deleteContent:function(_24){if(!_24){return;}_5(this.trashStore.executeMethod("PermanentDelete",_24).then(function(_25){var _26=this;var _27=this.get("trashes");var _28;_27.some(function(_29,_2a){if(_25.extraInformation===_29.wasteBasketLink){_28=_2a;_29.isRequireLoad=true;_26.set("currentTrash",_29);return true;}return false;});if(_28){_27[_28].isRequireLoad=true;}}.bind(this)).otherwise(function(_2b){if(_2b.status===403){this.set("actionResponse",_b.singledelete.accessdenied);}else{if(_2b.status===400){this.set("actionResponse",_b.singledelete.notfromwastebasket);}}}.bind(this)));},restore:function(_2c,_2d){if(!(_2c&&_2c.contentLink&&_2c.isDeleted&&_2d)){return;}return this.contentService.move(_2c.contentLink,_2d);},getOldParent:function(_2e){var _2f={referenceId:_2e,query:"getrestorepoint",allLanguages:true};return _5(this.contentStore.query(_2f)).then(function(_30){var _31=_30&&_3.isArray(_30)&&_30.length>0?_30[0]:null;return _31;});}});});