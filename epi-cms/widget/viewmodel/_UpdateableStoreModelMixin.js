//>>built
define("epi-cms/widget/viewmodel/_UpdateableStoreModelMixin",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/Evented","dojo/json","dojo/topic","dojo/when","epi/dependency","epi-cms/ApplicationSettings","epi-cms/_ContentContextMixin","epi-cms/core/ContentReference"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _2(_5,{updateableStore:null,updateableStoreKey:"epi.cms.contentdata",propertyNames:{name:"icontent_name",nameInUrl:"iroutable_routesegment"},refreshTranslatedAncestors:true,onAddDelegate:null,postscript:function(){this.inherited(arguments);this._setupStore();},_setupStore:function(){if(!this.updateableStore&&this.updateableStoreKey){this.updateableStore=_9.resolve("epi.storeregistry").get(this.updateableStoreKey);}},rename:function(id,_d){var _e=this,_f=new _4();_8(_e.patch(id,{name:_d,nameInUrl:null}),function(_10){_8(_e.refreshTranslated(id),function(){_f.resolve(_10);},function(e){_f.reject(e);});},function(e){_f.reject(e);});return _f;},add:function(_11,_12){var _13=this;var def=new _4();_8(_13.updateableStore.add(_11),function(_14){var id=_13.getContentId(_14),_15=_13.getParentIdentity(_11),_16=null;_8(_13.updateableStore.get(id),function(_17){if(_13.getParentIdentity(_17)!==_15){_16=typeof _12=="function"&&_12();}_8(_16).then(_13.updateableStore.updateDependentStores.bind(this,_17)).then(function(){_8(_13._childrenChanged(_15),function(){_8(_13.refreshTranslated(id),function(){_13.onSelect(id,true,_13.onAddDelegate);def.resolve(_17);});});});});});return def.promise;},patch:function(id,_18){var _19=this,_1a=new _4(),_1b={id:id,properties:{}};for(var key in _18){if(_18.hasOwnProperty(key)){_1b.properties[this._convertPropertyName(key)]=_6.stringify(_18[key]);}}_8(_19.updateableStore.patch(_1b,{id:_1b.id}),function(_1c){if(_1c&&_1c.successful){var _1d={contentLink:id,properties:_1b.properties,capabilities:{supportsVersions:false}};_3.mixin(_1d,_18);_8(_19.updateableStore.patchCache(_1d),_1a.resolve,_1a.reject);}else{return _1a.reject(_1c&&_1c.validationErrors);}});return _1a;},_convertPropertyName:function(_1e){return this.propertyNames[_1e]||_1e;},refreshTranslated:function(_1f){var _20=this,_21=new _4(),_22;function _23(_24){var id=_20.getIdentity(_24),_25=_20.getParentIdentity(_24);if(_25===_20.root||id===_20.root||!_24.missingLanguageBranch){return false;}return true;};if(!_20.refreshTranslatedAncestors){return _21.resolve();}_8(_20.refreshAncestors(_1f,_23),function(_26){if(!(_26 instanceof Array)||_26.length===0){_21.resolve();return;}_26.reverse();var _27=_1.some(_26,function(_28){if(_28.missingLanguageBranch){_22=_20.getLabel(_28);return true;}return false;});_8(_20.store.get(_1f),function(_29){if(_27&&_29&&!_29.missingLanguageBranch){_20.emit("translationFailed",_22);}_21.resolve();});});return _21;},getContentId:function(_2a){return _c.toContentReference(_2a).id.toString();}});});