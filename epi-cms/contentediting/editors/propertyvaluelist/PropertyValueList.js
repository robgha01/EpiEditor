//>>built
require({cache:{"url:epi-cms/contentediting/editors/propertyvaluelist/templates/PropertyValueList.html":"<div class=\"epi-property-value-list dijitInline\"  tabindex=\"-1\" role=\"presentation\">\r\n    <div data-dojo-attach-point=\"listNode\"></div>\r\n    <div data-dojo-attach-point=\"addNode\" class=\"add\"></div>\r\n</div>\r\n"}});define("epi-cms/contentediting/editors/propertyvaluelist/PropertyValueList",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dom-class","dojo/when","dojo/dom-construct","dojo/keys","dijit/registry","dijit/_WidgetBase","dijit/_TemplatedMixin","dgrid/List","dgrid/Keyboard","dgrid/extensions/DnD","epi/shell/dgrid/SingleQuery","epi/shell/dgrid/WidgetRow","epi-cms/dgrid/WithContextMenu","epi/shell/MetadataTransformer","epi/shell/widget/_ValueRequiredMixin","epi/shell/widget/WidgetFactory","epi/shell/widget/_FocusableMixin","epi/shell/command/builder/ButtonBuilder","./viewmodels/PropertyValueListViewModel","./PropertyValueListItem","./command/AddPropertyValue","dojo/text!./templates/PropertyValueList.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19){var _1a=_1([_b,_e,_d,_c,_10,_f]);return _1([_9,_a,_12,_14],{templateString:_19,baseClass:"epi-content-area-editor",multiple:true,value:null,model:null,_listSelectionMode:"single",postMixInProperties:function(){this.inherited(arguments);this.metadataTransformer=this.metadataTransformer||new _11();this._widgetFactory=new _13();this.own(this.model=this.model||new _16({maxLength:this.metadata.customEditorSettings.maxLength}));},buildRendering:function(){this.inherited(arguments);this._setupModelWatchers();this._setupList();this._setupAddCommand();},startup:function(){if(this._started){return;}this.inherited(arguments);if(this.list){this.list.startup();}},onChange:function(_1b){},isValid:function(){return !this.required||this.model.get("hasValue");},_getValueAttr:function(){return this.model.getFilteredValue();},_setupModelWatchers:function(){var _1c=function(){this.onChange(this.get("value"));}.bind(this);this.own(_3.after(this.model,"moveUp",_1c),_3.after(this.model,"moveDown",_1c),_3.after(this.model,"remove",_1c),this.model.on("itemAdded",this._onItemAdded.bind(this)));},_setupList:function(){this.own(this.list=new _1a({"class":"epi-grid-height--auto epi-card-list epi-card-list--numbered",store:this.model.get("store"),commandCategory:"itemContext",dndSourceType:[this.name],deselectOnRefresh:false,tabIndex:-1,dndParams:{withHandles:true,creator:this._createAvatar.bind(this),skipForm:true},maintainOddEven:false,selectionMode:this._listSelectionMode,renderRow:this._renderPropertyValue.bind(this)},this.listNode),this.list.addKeyHandler(_7.DELETE,this._removeItem.bind(this)),this.list.addKeyHandler(_7.UP_ARROW,this._moveItem.bind(this,true)),this.list.addKeyHandler(_7.DOWN_ARROW,this._moveItem.bind(this,false)),this.on("keypress",this._createItem.bind(this)),this.list.on("dgrid-select, dgrid-deselect, dgrid-contextmenu",function(_1d){this._updateSelectedValue();}.bind(this)),this.list.on("dgrid-contextmenu",function(){this.displayMessage(false);}.bind(this)));var _1e=this.list.get("dndSource");this.own(_3.after(_1e,"onDndStart",function(_1f,_20,_21){var _22=_1f===_1e;_4.toggle(this.domNode,"dojoDndTargetDisabled",!_22);}.bind(this),true),_3.after(_1e,"onDndDrop",function(){this.onChange(this.get("value"));}.bind(this),true));this.list.contextMenu.addProvider(this.model);},_createAvatar:function(_23){var _24=_8.byNode(this.list.row(_23).element);var _25=_6.create("div").appendChild(document.createTextNode(_24.getDisplayedValue()));return {node:_25,type:this.name,data:_23};},_updateSelectedValue:function(){var id=Object.keys(this.list.selection)[0],_26=null;if(id!==undefined){_26={id:id,data:this.list.row(id).data};}this.model.set("selectedValue",_26);},_setupAddCommand:function(){this.own(this._addPropertyValueCommand=new _18({model:this.model}));var _27=new _15({settings:{"class":"epi-chromeless",showLabel:false}});_27.create(this._addPropertyValueCommand,this.addNode);},_renderPropertyValue:function(_28){var _29=_2.clone(this.metadata.customEditorSettings.innerPropertySettings);_29.settings.value=_28.item;if(typeof this.get("readOnly")!=="undefined"){_29.settings.readOnly=this.get("readOnly");}var _2a=new _17({widgetFactory:this._widgetFactory,editorDefinition:this.metadataTransformer.transformPropertySettings(_29)});this.list.own(_2a.on("change",function(_2b){this.model.put(_28.id,_2b);this._set("value",this.get("value"));this.onChange(this.get("value"));this.validate();}.bind(this)),_2a.on("focus",function(_2c){if(this.readOnly||_2c){return;}var row=this.list.row(_28.id);if(!row||!row.element){return;}this.list.focus(row.element);this.list.clearSelection();this.list.select(row);}.bind(this)),_2a);return _2a.domNode;},_removeItem:function(){this.model.remove();},_moveItem:function(_2d,_2e){if(_2e.ctrlKey){var row=this.list.row(_2e);this.list.focus(row);_2d?this.model.moveUp():this.model.moveDown();}},_createItem:function(_2f){if(_2f.target.type==="text"){return;}if(_2f.key==="+"){this.model.addItem();_2f.preventDefault();}},_onItemAdded:function(e){var row=this.list.row(e.itemId);if(!row||!row.element){return;}this.list.focus(row.element);var _30=_8.byNode(row.element);if(_30&&_30.focus){_30.focus();}},_setValueAttr:function(_31){this._set("value",_31);this.model.set("value",_31);},_setReadOnlyAttr:function(_32){this._set("readOnly",_32);this.model.set("readOnly",_32);this.list.set("selectionMode",this.readOnly?"none":this._listSelectionMode);this.list.set("dndDisabled",this.readOnly);}});});