//>>built
require({cache:{"url:epi-cms/contentediting/editors/templates/ContentAreaEditor.html":"<div class=\"dijitInline\" tabindex=\"-1\" role=\"presentation\">\r\n    <div data-dojo-attach-point=\"treeNode\"></div>\r\n    <div data-dojo-attach-point=\"actionsContainer\" class=\"epi-content-area-actionscontainer\"></div>\r\n</div>\r\n"}});define("epi-cms/contentediting/editors/ContentAreaEditor",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dom-class","dojo/dom-style","dojo/on","dojo/topic","dojo/when","dijit/registry","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_CssStateMixin","dijit/_WidgetsInTemplateMixin","epi/shell/dnd/Target","epi/shell/command/_CommandProviderMixin","./_ContentAreaTree","./_ContentAreaTreeModel","./_TextWithActionLinksMixin","epi-cms/_ContentContextMixin","epi-cms/contentediting/viewmodel/ContentAreaViewModel","epi/shell/widget/ContextMenu","epi/shell/widget/_ValueRequiredMixin","epi-cms/widget/overlay/Block","epi-cms/widget/command/CreateContentFromSelector","epi-cms/widget/_HasChildDialogMixin","epi-cms/contentediting/command/BlockRemove","epi-cms/contentediting/command/BlockEdit","epi-cms/contentediting/command/MoveToPrevious","epi-cms/contentediting/command/MoveToNext","epi-cms/contentediting/command/MoveOutsideGroup","epi-cms/contentediting/command/Personalize","epi-cms/contentediting/command/SelectDisplayOption","dojo/text!./templates/ContentAreaEditor.html","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editors.contentarea"],function(_1,_2,_3,_4,_5,on,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21){return _1([_9,_a,_c,_b,_15,_12,_e,_18,_11],{baseClass:"epi-content-area-editor",res:_21,templateString:_20,value:null,multiple:true,parent:null,overlayItem:null,model:null,intermediateChanges:true,editMode:"onpageedit",_preventOnBlur:false,_dndTarget:null,allowedTypes:null,restrictedTypes:null,constructor:function(){this.allowedDndTypes=[];},onChange:function(_22){},_handleModelChange:function(_23){this.validate();this.onChange(_23);},_onBlur:function(){if(this._preventOnBlur){return;}this.inherited(arguments);},focus:function(){if(this.tree&&this.model.get("value").length>0){this._focusManager.focus(this.tree.domNode);}else{if(this.textWithLinks){this.textWithLinks.focus();}}},postMixInProperties:function(){this.inherited(arguments);this.commands=this._commands||[new _1a(),new _1f(),new _1e({category:null}),new _1d(),new _1b(),new _1c(),new _19()];this.commands.forEach(function(_24){this.own(_24);},this);this.own(this.model=this.model||new _13(),this.treeModel=this.treeModel||new _10({model:this.model}),this.model.watch("selectedItem",_2.hitch(this,function(_25,_26,_27){this.updateCommandModel(_27);})),on(this.model,"changed",_2.hitch(this,function(){if(!this._started||this._supressValueChanged){return;}this._set("value",this.model.get("value"));this._handleModelChange(this.value);})));this.allowedDndTypes.push("personalizationarea");},buildRendering:function(){this.inherited(arguments);this.contextMenu=new _14();this.contextMenu.addProvider(this);this.own(this.contextMenu);this.setupActionLinks(this.actionsContainer);this.own(this._dndTarget=new _d(this.actionsContainer,{accept:this.allowedDndTypes,reject:this.restrictedDndTypes,isSource:false,alwaysCopy:false,allowMultipleItems:true,insertNodes:function(){}}));this.own(_3.after(this._dndTarget,"onDropData",_2.hitch(this,function(_28,_29,_2a,_2b){_28.forEach(function(_2c){this.model.modify(_2.hitch(this,function(){this.model.addChild(_2c.data);}));},this);if(!this.tree){this._createTree();}}),true));this.own(_3.after(this._dndTarget,"onDrop",_2.hitch(this,"focus")));},postCreate:function(){this.inherited(arguments);this.set("emptyMessage",_21.emptymessage);if(this.parent&&this.overlayItem){this.connect(this.parent,"onStartEdit",function(){this._selectFromOverlay(this.overlayItem.model);});}this.own(_6.subscribe("/dnd/start",_2.hitch(this,this._startDrag)));},startup:function(){if(this._started){return;}this.inherited(arguments);this.tree&&this.tree.startup();this.contextMenu.startup();},destroy:function(){this.tree&&this.tree.destroyRecursive();this.inherited(arguments);},isCreateLinkVisible:function(){return this.model.canCreateBlock(this.allowedTypes,this.restrictedTypes);},executeAction:function(_2d){if(_2d==="createnewblock"){this._preventOnBlur=true;this.validate(false);var _2e=new _17({creatingTypeIdentifier:"episerver.core.blockdata",createAsLocalAsset:true,autoPublish:true,allowedTypes:this.allowedTypes,restrictedTypes:this.restrictedTypes});_2e.set("model",{save:_2.hitch(this,function(_2f){this._preventOnBlur=false;var _30=_2.clone(this.get("value"),true)||[];_30.push(_2f);this.set("value",_30);this.parent.set("editing",true);this.onChange(_30);this.onBlur();}),cancel:_2.hitch(this,function(){this._preventOnBlur=false;this.onBlur();})});_2e.execute();}},isValid:function(_31){return (this._preventOnBlur||!this.required||this.model.get("value").length>0);},_setReadOnlyAttr:function(_32){this._set("readOnly",_32);_5.set(this.actionsContainer,"display",_32?"none":"");if(this._source){this._source.isSource=!this.readOnly;}if(this.model){this.model.set("readOnly",_32);}this.tree&&this.tree.set("readOnly",_32);},_checkAcceptance:function(_33,_34){return this.readOnly?false:this._source.defaultCheckAcceptance(_33,_34);},_createTree:function(){this.tree=new _f({accept:this.allowedDndTypes,reject:this.restrictedDndTypes,contextMenu:this.contextMenu,model:this.treeModel,readOnly:this.readOnly}).placeAt(this.domNode,"first");this.tree.own(_3.after(this.tree.dndController,"onDndEnd",_2.hitch(this,"focus")));},_selectFromOverlay:function(_35){var _36=_35&&_35.selectedItem&&_35.selectedItem.serialize(),_37=this.model,_38=["root"];if(!_36){return;}if(_36.contentGroup){_37=_37.getChild({name:_36.contentGroup});_38.push(_37.id);}_37=_37.getChild(_36);if(!_37){return;}_38.push(_37.id);_37.set("selected",true);_37.set("ensurePersonalization",_35.selectedItem.ensurePersonalization);this.tree&&this.tree.set("path",_38);},_startDrag:function(_39,_3a,_3b){var _3c=this._dndTarget.accept&&this._dndTarget.checkAcceptance(_39,_3a);_4.toggle(this.domNode,"dojoDndTargetDisabled",!_3c);var _3d=_8.getEnclosingWidget(_3a[0]);if(_3d&&_3d.isInstanceOf(_16)&&this.parent.cancel){this.parent.set("isModified",false);this.parent.cancel();}},_setValueAttr:function(_3e){this.tree&&this.tree.destroyRecursive();this._set("value",_3e||[]);this._supressValueChanged=true;this.model.set("value",_3e);this._supressValueChanged=false;this._createTree();}});});