//>>built
define("epi-cms/contentediting/viewmodel/PublishMenuViewModel",["dojo/_base/declare","dojo/_base/lang","dojo/when","dojo/Deferred","dijit/Destroyable","dojox/html/entities","epi","epi/datetime","epi/dependency","epi/Url","epi/string","epi/username","epi-cms/content-approval/ApprovalEnums","epi-cms/contentediting/ContentActionSupport","epi-cms/contentediting/PageShortcutTypeSupport","epi-cms/contentediting/viewmodel/_ContentViewModelObserver","epi/shell/command/_CommandConsumerMixin","epi/shell/command/_GlobalCommandProviderMixin","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editactionpanel.publishactionmenu"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,res){return _1([_10,_11,_12,_5],{commandKey:"epi.cms.publishmenu",contentActionSupport:null,inUseNotificationManager:null,_currentUser:null,commands:null,mainButtonCommand:null,lastExecutedCommand:null,mainButtonSectionVisible:null,lastChangeStatus:null,topInfoSectionVisible:null,bottomInfoSectionVisible:null,publishInfoSectionVisible:null,lastPublishedText:null,lastPublishedViewLinkVisible:null,lastPublishedViewLinkHref:null,additionalInfoSectionVisible:null,additionalInfoText:null,isOpen:null,typeIdentifier:null,postscript:function(){this.inherited(arguments);this.res=this.res||res;this.projectService=this.projectService||_9.resolve("epi.cms.ProjectService");this.approvalService=this.approvalService||_9.resolve("epi.cms.ApprovalService");this.contentActionSupport=this.contentActionSupport||_e;this.initializeCommandProviders();},onDataModelChange:function(_13,_14,_15){var _16=this.dataModel.contentData,_17=(_16.publishedBy!==null&&_16.publishedBy!==undefined);this._updateCommands();this.set("topInfoSectionVisible",this._getTopInfoSectionVisible(_16));this.set("bottomInfoSectionVisible",this._getBottomInfoSectionVisible());this.set("publishInfoSectionVisible",this._getPublishInfoSectionVisible(_16));this.set("lastPublishedTitle",this._getLastPublishedTitle(_16));this.set("lastPublishedTitleVisible",_17);this.set("lastPublishedText",this._getLastPublishedText(_16));this.set("lastPublishedViewLinkVisible",this._getLastPublishedViewLinkVisible(_16,_17));this.set("lastPublishedViewLinkHref",this._getLastPublishedHref(_16));this.set("typeIdentifier",_16.typeIdentifier);this._setAdditionalInfo(_16);if(this._shouldShowApprovalInfo()){this._setApprovalInfo(_16);}else{this._setLastChangeStatus(_16);}},onCommandsChanged:function(_18,_19,_1a){if(_19){_19.forEach(function(_1b){this.destroyByKey(_1b);},this);}_1a.forEach(function(_1c){if(_1c.options&&_1c.options.isMain){this.ownByKey(_1c,_1c.watch("canExecute",function(){this._calculateMainButtonCommand();}.bind(this)));}},this);},_dataModelSetter:function(_1d){this.updateCommandModel(_1d);this.inherited(arguments);},_shouldShowApprovalInfo:function(){var _1e=this.dataModel.contentData.status===_e.versionStatus.AwaitingApproval;var _1f=this.dataModel.languageContext&&this.dataModel.languageContext.isTranslationNeeded;return _1e&&!_1f;},_isOpenSetter:function(_20){this.isOpen=_20;if(_20){var _21=this.dataModel.contentData;if(this._shouldShowApprovalInfo()){this._setApprovalInfo(_21);}else{this._setLastChangeStatus(_21);}}},_setApprovalInfo:function(_22){return this.approvalService.getApproval(_22.contentLink).then(_2.hitch(this,function(_23){if(!_23){if(this.dataModel.contentData.status===_e.versionStatus.AwaitingApproval){this._setAbortInfo(_22);}return null;}var _24=_2.replace(this.res.approvalinfo.timepassed,{timepassed:_8.timePassed(new Date(_23.startDate))});var _25=" <br /> "+_2.replace(this.res.approvalinfo.stepinfo,{activeStepIndex:_23.activeStepIndex+1,totalsteps:_23.totalSteps});var _26=_24+(_23.status===_d.status.inReview?_25:"");this.set("topInfoSectionVisible",true);this.set("lastChangeStatus",_26);var _27=_2.replace(this.res.approvalinfo.requestedby,{username:this._getFriendlyUsername(_23.startedBy,true),time:_8.toUserFriendlyHtml(_23.startDate)});this.set("publishInfoSectionVisible",true);this.set("lastPublishedText",_27);this.set("lastPublishedTitleVisible",false);this.set("lastPublishedViewLinkVisible",false);return _23;})).otherwise(function(){return null;});},_setAbortInfo:function(_28){this.set("topInfoSectionVisible",true);this._setLastChangeStatus(_28);this.set("publishInfoSectionVisible",true);this.set("lastPublishedText",this.res.approvalinfo.approvalmissing);this.set("lastPublishedTitleVisible",false);this.set("lastPublishedViewLinkVisible",false);},_updateCommands:function(){this._calculateMainButtonCommand();this.set("commands",this.getCommands());},_calculateMainButtonCommand:function(){var _29=this.getCommands(),_2a=null;_29.forEach(function(_2b){if(_2b.canExecute&&_2b.options&&_2b.options.isMain&&_2b.options.priority&&(!_2a||_2a.options.priority<_2b.options.priority)){_2a=_2b;}});this.set("mainButtonCommand",_2a);this.set("mainButtonSectionVisible",_2a!==null);},_getBottomInfoSectionVisible:function(){return this.getCommands().some(function(_2c){return _2c.isAvailable&&_2c!==this.mainButtonCommand;}.bind(this));},_getTopInfoSectionVisible:function(_2d){return this.mainButtonCommand||!((_2d.status===_e.versionStatus.Published||_2d.status===_e.versionStatus.Expired)&&!_2d.isCommonDraft);},_getPublishInfoSectionVisible:function(_2e){var _2f=this.inUseNotificationManager.hasInUseNotificationWarning(_2e.inUseNotifications),_30=this._isOriginallyEditable();return !(_2f&&_30);},_getLastPublishedViewLinkVisible:function(_31,_32){return _32&&!!_31.publicUrl;},_setLastChangeStatus:function(_33){var _34,_35,_36=this;var _37=this.dataModel.get("lastSaved");_35=_34=this._getTemplatedText(this.res.lastchangestatus,_33.changedBy,_37);if(this.lastExecutedCommand&&this.lastExecutedCommand.options&&this.lastExecutedCommand.options.successStatus){var _38=this.lastExecutedCommand.options.successStatus;this.lastExecutedCommand=this.mainButtonCommand;_35=_38;}if(_33.missingLanguageBranch&&_33.missingLanguageBranch.isTranslationNeeded){_35=_2.replace(this.res.nottranslated,{languageName:_7.resources.language[_33.missingLanguageBranch.languageId],languageId:_33.missingLanguageBranch.languageId});}if(_33.status===_e.versionStatus.Published||_33.status===_e.versionStatus.Expired){_35=this.res.notmodifiedsincelastpublish;}if(_33.status===_e.versionStatus.PreviouslyPublished){_35=this._getTemplatedText(this.res.previouslypublished,_33.versionCreatedBy,_33.versionCreatedTime);}if(_33.status===_e.versionStatus.Rejected){_35=this._getTemplatedText(this.res.rejectedapproval,_33.versionCreatedBy,_33.versionCreatedTime);}if(_33.status===_e.versionStatus.DelayedPublish){_35=this.projectService.getProjectsForContent(_33.contentLink).then(function(_39){_39=_39.filter(function(_3a){return _3a.status==="delayedpublished";});if(_39.length){return _2.replace(_36.res.projectdelayedpublish,{date:_8.toUserFriendlyHtml(_33.properties.iversionable_startpublish),project:_6.encode(_39[0].name)});}return _34;});}_3(_35,_2.hitch(this,"set","lastChangeStatus"));},_getLastPublishedTitle:function(_3b){return _3b.status===_e.versionStatus.PreviouslyPublished?this.res.currentlypublished:this.res.lastpublishedby;},_getLastPublishedText:function(_3c){return (_3c.publishedBy===null||_3c.publishedBy===undefined)?this.res.notpublishedbefore:this._getTemplatedText(this.res.publishedtime,_3c.publishedBy,_3c.lastPublished,true);},_getLastPublishedHref:function(_3d){if(!_3d.publicUrl){return null;}var url=new _a(_3d.publicUrl);if(_3d.properties.pageShortcutType===_f.pageShortcutTypes.Shortcut){url.query.id=new Date().valueOf();}return url.toString();},_setAdditionalInfo:function(_3e){var _3f=this.inUseNotificationManager.hasInUseNotificationWarning(_3e.inUseNotifications),_40=this._isOriginallyEditable(),_41=_3f&&_40;this.set("additionalInfoSectionVisible",_41);if(_41){var _42=this.inUseNotificationManager.getOtherUsersInUseNotifications(_3e.inUseNotifications);this.set("additionalInfoText",this._getTemplatedText(this.res.inusewarning,_42.join(",")));}},_isOriginallyEditable:function(){var _43=this.inUseNotificationManager.ignoreOthersNotifications;this.inUseNotificationManager.ignoreOthersNotifications=true;var _44=this.dataModel.canChangeContent();this.inUseNotificationManager.ignoreOthersNotifications=_43;return _44;},_getFriendlyUsername:function(_45,_46){return _c.toUserFriendlyHtml(_45,null,_46);},_getTemplatedText:function(_47,_48,_49,_4a){var _4b=new Date(_49);return _2.replace(_47,{username:this._getFriendlyUsername(_48,_4a),time:_8.toUserFriendlyHtml(_4b),timepassed:_8.timePassed(_4b)});},_canTransitionTo:function(_4c,_4d){return _4c.transitions.some(function(_4e){return _4e.name===_4d;});}});});