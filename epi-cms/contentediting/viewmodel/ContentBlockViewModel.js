//>>built
define("epi-cms/contentediting/viewmodel/ContentBlockViewModel",["dojo/_base/declare","dojo/_base/lang","dojo/when","dojo/promise/all","dojox/html/entities","epi","epi/dependency","./_ViewModelMixin","epi-cms/widget/viewmodel/ContentStatusViewModel","epi-cms/dgrid/formatters","epi/shell/TypeDescriptorManager","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editors.contentarea.personalize"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _1([_9,_8],{label:null,store:null,hasSiblings:true,isVisible:true,settings:{displayOptionsAttributeName:"data-epi-content-display-option",contentGroupAttributeName:"data-contentgroup"},roles:null,contentGroup:null,name:null,contentTypeName:null,roleIdentities:null,typeIdentifier:null,attributes:null,constructor:function(){this.roleIdentities=this.roleIdentities||[];this.attributes={};},postscript:function(){this.inherited(arguments);if(!this.store){var _d=_7.resolve("epi.storeregistry");this.store=_d.get("epi.cms.visitorgroup");}this.contentTypeName=this.contentTypeName||(this.typeIdentifier&&_b.getResourceValue(this.typeIdentifier,"name"));this.set("label",this.name);this.set("tooltip",_a.title(this.name,this.contentLink,this.contentTypeName));this._reloadRoles();},serialize:function(){return {contentGroup:this.contentGroup,contentLink:this.contentLink,name:this.name,roleIdentities:this.roleIdentities,typeIdentifier:this.typeIdentifier,attributes:this.attributes};},equals:function(_e){for(var _f in _e){if(!_6.areEqual(this[_f],_e[_f])){return false;}}return true;},isRoleSelected:function(_10){if(!this.roleIdentities){return false;}return this.roleIdentities.indexOf(_10)>-1;},hasAnyRoles:function(){if(!this.roleIdentities){return false;}return this.roleIdentities.length>0;},moveNext:function(){var _11=this.parent.indexOf(this);this.parent.modify(function(){this.parent.move(this,_11+1);},this);},movePrevious:function(){var _12=this.parent.indexOf(this);this.parent.modify(function(){this.parent.move(this,_12-1);},this);},moveOutsideGroup:function(){if(!this.contentGroup){return;}this.parent.modify(function(){this.parent.moveOutsideGroup(this);},this);},remove:function(){this.parent.modify(function(){this.parent.removeChild(this);},this);},personalize:function(){this.parent.modify(function(){this.parent.personalize(this);},this);},selectRole:function(_13,_14){var _15=(this.roles||[]).map(function(_16){return _16.id;});var _17=_15.indexOf(_13);if(_17>=0){if(!_14){_15.splice(_17,1);}}else{if(_14){_15.push(_13);}}this.set("roleIdentities",_15);},resetRoleIdentities:function(){this.set("visible",true);this.set("roleIdentities",null);},_displayOptionSetter:function(_18){this.attributes[this.settings.displayOptionsAttributeName]=_18;},_displayOptionGetter:function(){return this.attributes[this.settings.displayOptionsAttributeName];},_roleIdentitiesSetter:function(_19){this.roleIdentities=_19||[];this._reloadRoles();},_parentSetter:function(_1a){this.parent=_1a;this.set("contentGroup",this.parent.name);},_contentGroupSetter:function(_1b){this.contentGroup=_1b||"";this.attributes[this.settings.contentGroupAttributeName]=this.contentGroup;this._reloadRoles();},_reloadRoles:function(){var _1c=this.store;if(!_1c){return;}var _1d=_4(this.roleIdentities.map(function(id){return _3(_1c.get(id)).otherwise(function(){console.warn("Could not load visitor group with id: "+id);});}));_1d.then(_2.hitch(this,"set","roles"));return _1d;},_hasSiblingsSetter:function(_1e){this.hasSiblings=_1e;this._updateRolesString();},_selectedSetter:function(_1f){this.selected=_1f;if(_1f){this.emit("selected",this);}},_updateRolesString:function(){if(!this.contentGroup||this.roles===null){this.set("rolesString","");return;}if(!this.hasAnyRoles()){if(this.hasSiblings){this.set("rolesString",_c.everyoneelsesee);}else{this.set("rolesString",_c.everyonesees);}return;}if(!this.roles.length){this.set("rolesString",_c.groupcannotsees);return;}var _20=this.roles.map(function(r){return "<em>"+_5.encode(r.name)+"</em>";}).sort().join(", ");var _21=_20.replace(/, (?=[^,]+$)/," "+_c.groupsand);var _22="";if(this.roles.length>1){_22=_2.replace(_c.groupssee,{groupNames:_21});}else{_22=_2.replace(_c.groupsees,{groupName:_21});}this.set("rolesString",_22);},_rolesSetter:function(_23){this.roles=_23.filter(function(_24){return !!_24;});this._updateRolesString();}});});