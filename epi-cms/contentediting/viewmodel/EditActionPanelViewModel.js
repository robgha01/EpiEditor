//>>built
define("epi-cms/contentediting/viewmodel/EditActionPanelViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/Stateful","dojo/string","dojox/html/entities","epi-cms/contentediting/ContentActionSupport","epi-cms/contentediting/viewmodel/_ContentViewModelObserver","epi-cms/contentediting/viewmodel/PublishMenuViewModel","epi/datetime","epi/dependency","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editactionpanel"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _2([_8],{state:null,buttonText:null,statusText:null,statusIcon:null,additionalClass:null,nonEditableIndicator:null,visible:null,publishMenuViewModel:null,inUseNotificationManager:null,skipChildModels:false,_virtualStatusEnum:{NotCreated:0,NotPublishedYet:1,NoChangeToPublish:2,ChangesToPublish:3,ReadyToPublish:4,ScheduledPublish:5,Published:6,PreviouslyPublished:7,Expired:8,InUse:9,Deleted:10,AwaitingApproval:11,Rejected:12},_isSavingHandle:null,_virtualStatusCssState:[],_virtualStatusLocalization:[],_statusIcon:[],_statusMap:{},postscript:function(){this.res=this.res||_c;this.inherited(arguments);this.inUseNotificationManager=this.inUseNotificationManager||_b.resolve("epi.cms.contentediting.inUseNotificationManager");if(this._virtualStatusCssState.length===0){for(var _d in this._virtualStatusEnum){this._virtualStatusCssState.push(_d);this._virtualStatusLocalization.push(this.res["status"][_d.toLowerCase()]);}this._statusMap[_7.versionStatus.CheckedOut]=this._virtualStatusEnum.NotPublishedYet;this._statusMap[_7.versionStatus.CheckedIn]=this._virtualStatusEnum.ReadyToPublish;this._statusMap[_7.versionStatus.Rejected]=this._virtualStatusEnum.Rejected;this._statusMap[_7.versionStatus.DelayedPublish]=this._virtualStatusEnum.ScheduledPublish;this._statusMap[_7.versionStatus.Published]=this._virtualStatusEnum.Published;this._statusMap[_7.versionStatus.PreviouslyPublished]=this._virtualStatusEnum.PreviouslyPublished;this._statusMap[_7.versionStatus.Expired]=this._virtualStatusEnum.Expired;this._statusMap[_7.versionStatus.AwaitingApproval]=this._virtualStatusEnum.AwaitingApproval;this._statusIcon[_7.versionStatus.DelayedPublish]="epi-iconClock";this._statusIcon[_7.versionStatus.Rejected]="epi-icon--inverted epi-iconStop";this._statusIcon[_7.versionStatus.AwaitingApproval]="epi-icon--inverted epi-iconGlasses";}if(!this.skipChildModels){this.publishMenuViewModel=new _9({inUseNotificationManager:this.inUseNotificationManager});}},destroy:function(){if(this.publishMenuViewModel){this.publishMenuViewModel.destroy();}if(this._isSavingHandle){this._isSavingHandle.unwatch();}this.inherited(arguments);},_dataModelSetter:function(_e){this.inherited(arguments);if(this.publishMenuViewModel){this.publishMenuViewModel.set("dataModel",_e);}},onDataModelChange:function(){var _f=this.dataModel.contentData;if(this._isChangingContentStatusHandle){this._isChangingContentStatusHandle.unwatch();}this._isChangingContentStatusHandle=this.dataModel.watch("isSaving",function(_10,_11,_12){if(_12){this.set("statusText","");}else{this._refresh(_12);}}.bind(this));this._refresh((!this.dataModel.hasErrors&&this.dataModel.hasPendingChanges)||this.dataModel.isSaving);if(_f.isDeleted){this.set("statusIcon","");this.set("nonEditableIndicator",true);}else{this.set("statusIcon",this._getStatusIcon(_f));var _13=this.dataModel.canChangeContent(_7.action.Edit);var _14=_f.status===_7.versionStatus.AwaitingApproval;this.set("nonEditableIndicator",!_13&&!_14);}this.set("visible",!_f.isWastebasket);},_refresh:function(_15){if(_15){return;}var _16=this.dataModel.contentData;var _17=this._getVirtualStatus(_16);this.set("additionalClass",this._getVirtualStatus(_16)===this._virtualStatusEnum.ChangesToPublish?"animated8 shake":"");this.set("state",this._virtualStatusCssState[_17]);this.set("statusText",this._getStatusText(_17,_16));this.set("buttonText",this._getButtonText(_17,_16));},_getStatusText:function(_18,_19){if(_18===this._virtualStatusEnum.Deleted){return this._virtualStatusLocalization[_18];}if(_19.status===_7.versionStatus.DelayedPublish){return _5.substitute(this._virtualStatusLocalization[_18],[_a.toUserFriendlyHtml(_19.properties.iversionable_startpublish)]);}if(_18===this._virtualStatusEnum.InUse){var _1a=this.inUseNotificationManager.getOtherUsersInUseNotifications(_19.inUseNotifications);_1a=_1a.map(function(_1b){return _6.encode(_1b);}).join(",");return _5.substitute(this._virtualStatusLocalization[_18],[_1a]);}if(_19.status===_7.versionStatus.AwaitingApproval){if(this._canApproveCurrentStep()){return this.res.awaitingyourapproval.label;}return this.res.currentlyinreview.label;}return this._virtualStatusLocalization[_18];},_getStatusIcon:function(_1c){if(this._isRejected()){return "";}return this._statusIcon[_1c.status]||"";},_getButtonText:function(_1d,_1e){if((_1d===this._virtualStatusEnum.NotPublishedYet||_1d===this._virtualStatusEnum.ChangesToPublish||_1d===this._virtualStatusEnum.ReadyToPublish)&&this.dataModel.canChangeContent(_7.action.Publish)){return this.res.buttonlabel.publish;}else{if(this._shouldShowApprovalButton(_1d)){return this.res.awaitingyourapproval.button;}else{return this.res.buttonlabel.option;}}},_shouldShowApprovalButton:function(_1f){return _1f===this._virtualStatusEnum.AwaitingApproval&&this._isContentInCurrentLanguage()&&this._canApproveCurrentStep();},_isContentInCurrentLanguage:function(){var _20=this.dataModel.contentData;if(_20&&_20.capabilities&&!_20.capabilities.language){return true;}if(!this.dataModel.languageContext){return false;}var _21=this.dataModel.currentContentLanguage;var _22=this.dataModel.languageContext.language;return _21===_22;},_getVirtualStatus:function(_23){if(_23.isDeleted){return this._virtualStatusEnum.Deleted;}var _24,_25,_26;_24=this.inUseNotificationManager.ignoreOthersNotifications;this.inUseNotificationManager.ignoreOthersNotifications=true;_25=this.dataModel.canChangeContent();this.inUseNotificationManager.ignoreOthersNotifications=_24;_26=this.inUseNotificationManager.hasInUseNotificationWarning(_23.inUseNotifications);if(_26&&_25){return this._virtualStatusEnum.InUse;}if(_23.isCommonDraft){if(_23.status===_7.versionStatus.Published){return this._virtualStatusEnum.NoChangeToPublish;}if(_23.status===_7.versionStatus.CheckedOut){return _23.isMasterVersion?this._virtualStatusEnum.NotPublishedYet:this._virtualStatusEnum.ChangesToPublish;}}if(this._isRejected()){return this._virtualStatusEnum.NotPublishedYet;}return this._statusMap[_23.status];},_isRejected:function(){return !this._canTransitionTo("readyforreview")&&this._canTransitionTo("readytopublish");},_canApproveCurrentStep:function(){return this._canTransitionTo("approvechanges");},_canTransitionTo:function(_27){return this.dataModel.contentData.transitions.some(function(_28){return _28.name===_27;});}});});