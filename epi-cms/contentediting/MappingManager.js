//>>built
define("epi-cms/contentediting/MappingManager",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/connect","dojo/dom-attr","dojox/encoding/digests/SHA1"],function(_1,_2,_3,_4,_5,_6,_7){return _1(null,{_mappings:null,domUtils:null,attrNames:["data-epi-edit","data-epi-property-name","data-epi-property-display-names","data-epi-property-customsettings-customtag","data-epi-use-mvc","data-epi-disabled","data-epi-useoverlay","data-epi-overlay-z-index","data-epi-property-type","data-epi-property-edittype","data-epi-property-editorsetting","data-epi-property-editor","data-epi-property-render"],constructor:function(){this._mappings=[];this.domUtils=_6;},clear:function(){var _8;try{while((_8=this._mappings.pop())){this._clearMapping(_8);}}catch(ex){console.error(ex);}},_calculateNodeHash:function(_9){if(!_9){return "";}var _a=_3.map(this.attrNames,_2.hitch(this,function(n){return this.domUtils.get(_9,n)||"";}));return _7(_4.toJson(_a));},add:function(_b){if(_b.node){_b.nodeHash=this._calculateNodeHash(_b.node);}if(_b.blockPropertyInfo&&!_b.propertyName){_b.propertyName=_b.blockPropertyInfo.name;}this._mappings.push(_b);},_tryRemapNode:function(_c,_d){if(this._calculateNodeHash(_d.node)===_c.nodeHash){_c.node=_d.node;_c.updateController.displayNode=_d.node;_c.updateController.checkEmptyHtml();if(_c.overlayItem){_c.overlayItem.set("disabled",false);_c.overlayItem.set("sourceItemNode",_d.node);_c.overlayItem.refresh();}return {success:true,mappedNode:_d};}return {success:false};},remap:function(_e){var _f=[];var _10=(_e!=null?_e.slice(0):[]);_3.forEach(this._mappings,_2.hitch(this,function(_11){if(!_11.updateController){return;}var _12=null;var _13=_3.some(_10,_2.hitch(this,function(_14){var _15=this._tryRemapNode(_11,_14);_12=_12||_15.mappedNode;return _15.success;}));if(_13){if(_12){_10.splice(_3.indexOf(_10,_12),1);}}else{this._clearMapping(_11);delete _11.node;_f.push(_11);}if(_11.wrapper&&_11.node){_11.wrapper.set("blockDisplayNode",_11.node);}}));var _16;while((_16=_f.pop())){this._mappings.splice(_3.indexOf(this._mappings,_16),1);}return _10;},findOne:function(_17,_18){var _19;_3.some(this._mappings,function(m){if(m[_17]===_18){_19=m;return true;}});return _19;},find:function(){var _1a;if(arguments[0]===undefined){return this._mappings;}else{if(_2.isFunction(arguments[0])){_1a=arguments[0];}else{var _1b=arguments[0],_1c=arguments[1];_1a=function(m){return m[_1b]===_1c;};}}return _3.filter(this._mappings,_1a);},_clearMapping:function(_1d){for(var _1e in _1d){if(_1d[_1e]){if(_1e!=="node"){if(_2.isFunction(_1d[_1e].destroyRecursive)){_1d[_1e].destroyRecursive();}else{if(_2.isFunction(_1d[_1e].destroy)){_1d[_1e].destroy();}else{if(_2.isFunction(_1d[_1e].remove)){_1d[_1e].remove();}}}}_1d[_1e]=null;}}}});});