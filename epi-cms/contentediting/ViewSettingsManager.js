//>>built
define("epi-cms/contentediting/ViewSettingsManager",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/topic","dojo/when","dojo/Stateful","epi/epi","epi/dependency","epi/UriParser","epi/shell/_ContextMixin","epi/shell/StickyViewSelector"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1([_6,_a],{_hashWrapper:null,viewSettings:null,_viewSettingsMap:null,viewSettingsHashValue:null,_activeKey:"active",enabled:false,previewParams:null,_stickyViewSelector:null,postscript:function(){this.inherited(arguments);this._stickyViewSelector=this._stickyViewSelector||new _b();this._hashWrapper=this._hashWrapper||_8.resolve("epi.shell.HashWrapper");this.previewParams={};this.viewSettingsHashValue=[];this._viewSettingsMap={};_2.forEach(this.viewSettings,_3.hitch(this,function(_c){if(!this._viewSettingsMap[_c.key]){this._viewSettingsMap[_c.key]=_c;}else{throw "Duplicated view settings key.";}}));this.own(_4.subscribe("/epi/cms/action/viewsettingvaluechanged",_3.hitch(this,this._viewSettingChanged)),_4.subscribe("/epi/cms/action/eyetoggle",_3.hitch(this,this._viewSettingEnabledChanged)));var _d=this._hashWrapper.getHash();if(_d&&_d.viewsetting){this.viewSettingsHashValue=this._toObjects(_d.viewsetting);}this.enabled=this._loadProperty(this._activeKey)==="true";_2.forEach(this.viewSettingsHashValue,_3.hitch(this,function(_e){var _f=this._viewSettingsMap[_e.type];if(_f){_f.set("enabled",this.get("enabled"));_f.value=_e.id;_f.beforePreviewLoad(this.previewParams,this.get("enabled"));}}));},onPreviewReady:function(_10){this._preview=_10;_2.forEach(this.viewSettings,_3.hitch(this,function(_11){_11.afterPreviewLoad(_10,this.get("enabled"));}));},getSettingProperty:function(_12){var _13=_2.filter(this.viewSettingsHashValue,function(_14){return _14.type===_12;});return _13.length>0?_13[0].id:null;},hasVisitorGroup:function(){return this.getSettingProperty("visitorgroup")!==null&&this.getSettingProperty("visitorgroup").id!==null;},_enabledGetter:function(){return this.enabled;},_enabledSetter:function(_15){this.enabled=_15;var _16={};_2.forEach(this.viewSettings,_3.hitch(this,function(_17){_17.set("enabled",_15);_17.beforePreviewLoad(_16,_15);}));if(!_7.areEqual(this.previewParams,_16)){this.previewParams=_16;}else{_2.forEach(this.viewSettings,_3.hitch(this,function(_18){_18.afterPreviewLoad(this._preview,_15);}));}},_applyViewSettingValue:function(key,_19){var _1a,_1b=this._viewSettingsMap[key];if(_1b){_1a=_3.clone(this.previewParams);_1b.value=_19;_1b.beforePreviewLoad(_1a,true);if(!_7.areEqual(this.previewParams,_1a)){this.previewParams=_1a;}else{_1b.afterPreviewLoad(this._preview,true);}}},_viewSettingChanged:function(key,_1c){var _1d=this;_5(this.getCurrentContext()).then(function(_1e){if(key!=="viewlanguage"){this._stickyViewSelector.save(_1e.hasTemplate,_1e.dataType,"onpageedit");}this._commitToHash(function(){var _1f=key;if(!(key instanceof Array)){_1f=[{key:key,value:_1c}];}_1f.forEach(function(_20){_1d._saveProperty(_20.key,_20.value);_1d._applyViewSettingValue(_20.key,_20.value);});});}.bind(this));},_viewSettingEnabledChanged:function(_21){var _22=this;if(_21){_5(this.getCurrentContext()).then(function(_23){this._stickyViewSelector.save(_23.hasTemplate,_23.dataType,"onpageedit");this._commitToHash(function(){_22._saveProperty(_22._activeKey,"true");_22.set("enabled",_21);});}.bind(this));}else{this._commitToHash(function(){var _24=_22._hasSetting();_22._saveProperty(_22._activeKey,_24?false:null);_22.set("enabled",_21);});}},_addProperty:function(_25,_26){this.viewSettingsHashValue.push({type:_25,id:_26});},_updateProperty:function(_27,_28){var _29=-1;_2.forEach(this.viewSettingsHashValue,function(_2a,_2b){if(_2a.type===_27){_29=_2b;return;}});if(_29>-1){this.viewSettingsHashValue[_29].id=_28;}else{this._addProperty(_27,_28);}},_toObjects:function(url){var _2c=[];_2.forEach(url.split("|"),function(_2d,_2e){var uri=new _9(_2d);_2c.push({type:uri.getType(),id:uri.getId()});});return _2c;},_deleteProperty:function(_2f){var _30=-1;_2.forEach(this.viewSettingsHashValue,function(_31,_32){if(_31.type===_2f){_30=_32;return;}});if(_30>-1){this.viewSettingsHashValue.splice(_30,1);}},_commitToHash:function(_33){var obj=this._hashWrapper.getHash();var _34=[];if(obj&&obj.viewsetting){this.set("viewSettingsHashValue",this._toObjects(obj.viewsetting));}else{this.set("viewSettingsHashValue",[]);}_33();_2.forEach(this.viewSettingsHashValue,function(_35,_36){_34.push(_35.type+":///"+_35.id);});if(_34.length>0){obj.viewsetting=_34.join("|");}else{delete obj.viewsetting;}this._hashWrapper.setHash(obj);},_saveProperty:function(_37,_38){if(this.get("viewSettingsHashValue")){if(_38!=null){this._updateProperty(_37,_38);}else{this._deleteProperty(_37);}}else{if(_38!=null){this._updateProperty(_37,_38);}}},_loadProperty:function(_39){var obj=this._hashWrapper.getHash();var _3a=null;if(obj&&obj.viewsetting){var _3b=this._toObjects(obj.viewsetting);var _3c=_2.filter(_3b,function(_3d){return _3d.type===_39;})[0];if(_3c){_3a=_3c.id;}}return _3a;},_hasSetting:function(){var obj=this._hashWrapper.getHash();if(obj&&obj.viewsetting){if(obj.viewsetting.split("|").length>1){return true;}}return false;},getRenderingViewSettings:function(){return _2.filter(this.viewSettings,_3.hitch(this,function(_3e){return _3e.usedForRendering;}));}});});