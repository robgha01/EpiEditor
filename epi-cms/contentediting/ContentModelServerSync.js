//>>built
define("epi-cms/contentediting/ContentModelServerSync",["dojo/_base/array","dojo/_base/declare","dojo/Deferred","dojo/when","dojo/_base/json","dojo/Stateful","epi/assign","epi/datetime","epi/dependency","epi/string","epi/shell/postMessage","./ContentActionSupport"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _2([_6],{_queue:null,_isSynchronizing:false,hasPendingChanges:false,contentLink:null,_oldContentLink:null,contentDataStore:null,processInterval:200,_processIntervalId:0,_saveDeferred:null,_postMessage:null,_profile:null,constructor:function(_d){_2.safeMixin(this,_d);this._queue=[];this._postMessage=this._postMessage||_b;this._profile=this._profile||_9.resolve("epi.shell.Profile");},_contentLinkSetter:function(_e){this._oldContentLink=this.contentLink;this.contentLink=_e;},scheduleForSync:function(_f,_10){if(_10===undefined){return;}this.set("hasPendingChanges",true);_10=_8.transformDate(_10);var _11=this._propertyIndexInQueue(_f);if(_11<0){this._queue.push({name:_f,value:_10});}else{this._queue[_11].value=_10;}},saveProperty:function(_12,_13,_14){this.scheduleForSync(_12,_13);return this._startSynchronizeInterval({delay:0,action:_14});},_propertyIndexInQueue:function(_15){var _16=-1;_1.some(this._queue,function(_17,i){if(_17.name===_15){_16=i;return true;}});return _16;},save:function(){return this._startSynchronizeInterval();},_startSynchronizeInterval:function(_18){var _19;if(!this._saveDeferred){this._saveDeferred=new _3();_19=_18&&_18.delay||this.processInterval;setTimeout(this._synchronizeItem.bind(this,_18),_19);}return this._saveDeferred.promise;},_synchronizeItem:function(_1a){var _1b=this._queue,_1c=this.contentLink,_1d=this._saveDeferred;this._queue=[];this._saveDeferred=null;this.set("hasPendingChanges",false);var _1e=function(_1f){var _20={},_21;if(_1f){_1.forEach(_1f.properties,function(_22){_22.name=_a.pascalToCamel(_22.name);},this);_21=_1f.savedContentLink;_20=_7({successful:false,contentLink:_1f.savedContentLink,hasContentLinkChanged:this._hasContentLinkChanged(_1f)},_1f);if(_21&&_21!==this.contentLink){this.set("contentLink",_21);}_20.oldContentLink=this._oldContentLink;this._oldContentLink=null;this._publishContentSavedMessage(_20);_1d.resolve(_20);}else{_1d.reject({contentLink:_1c,properties:_1b,error:"Unexpected result returned from the server."});}}.bind(this);var _23=function(_24){var _25={contentLink:_1c,properties:_1b,error:_24};_1d.reject(_25);}.bind(this);if(_1b.length===0){_1d.resolve();return;}_4(this._saveProperties(_1b,_1a)).then(_1e).otherwise(_23);},_hasContentLinkChanged:function(_26){var _27=this._oldContentLink&&this._oldContentLink!==this.contentLink;return _26.savedContentLink&&_26.savedContentLink!==this.contentLink||_27;},_publishContentSavedMessage:function(_28){_4(this._profile.get("isEPiBetaUser"),function(_29){if(_29){this._postMessage.publish("beta/contentSaved",_28);}}.bind(this));},pendingSync:function(_2a){return this._propertyIndexInQueue(_2a)!==-1;},_saveProperties:function(_2b,_2c){var _2d=this.contentLink,_2e={};_1.forEach(_2b,function(_2f){_2e[_2f.name]=_5.toJson(_2f.value);});var _30={id:_2d,properties:_2e,action:_2c?_2c.action:_c.saveAction.Save|_c.saveAction.SkipValidation};return this.contentDataStore.patch(_30,{id:_30.id});}});});