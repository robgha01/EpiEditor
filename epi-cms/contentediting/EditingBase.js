//>>built
define("epi-cms/contentediting/EditingBase",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/event","dojo/_base/json","dojo/_base/lang","dojo/aspect","dojo/date/stamp","dojo/dom-attr","dojo/query","dojo/topic","dojo/when","epi/dependency","epi/datetime","epi/string","epi/shell/DestroyableByKey","epi-cms/contentediting/MutationObserver","epi-cms/contentediting/_View","epi-cms/contentediting/AutoSaveButton","epi-cms/contentediting/MappingManager","epi-cms/contentediting/RenderManager","epi-cms/contentediting/UpdateController","epi-cms/widget/overlay/overlayFactory","epi/i18n!epi/cms/nls/episerver.cms.contentediting"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,res){return _3([_13,_11],{toolbar:null,editorFactory:null,activePropertyOnStartup:null,createOverlays:true,_renderManager:null,_mappingManager:null,_activeEditorWrapper:null,_autoSaveButton:null,_deferredReloadHandle:null,_eventHandlers:null,_isCreatingWrapper:null,_mutationObserver:null,constructor:function(){this.defaultQueryParameters={epieditmode:true};},postMixInProperties:function(){this.inherited(arguments);this.editorFactory=this.editorFactory||_e.resolve("epi.cms.contentediting.EditorFactory");this._mappingManager=new _15();this._mutationObserver=new _12();this.own(this._mutationObserver.on("dom-updated",function(){this.emit("dom-updated");}.bind(this)));this._eventHandlers=[];},postCreate:function(){this.inherited(arguments);this.subscribe("/epi/cms/action/disableundoredoactions",this._toggleUndoRedoActions);},destroy:function(){this._stopActiveEditorWrapper();if(this._renderManager){this._renderManager.destroy();}if(this._autoSaveButton){this._autoSaveButton.destroyRecursive();}this._mappingManager.clear();if(this.toolbar){this.toolbar=null;}this.overlay.destroyDescendants();this._mutationObserver.teardown();this.inherited(arguments);},_setCommandEnabled:function(_19,_1a){if(this.toolbar){this.toolbar.setItemProperty(_19,"disabled",!_1a);}},onContentLinkSyncChange:function(){this.inherited(arguments);this._setButtonState();},onReloadRequired:function(){this.inherited(arguments);setTimeout(function(){this._renderManager.suspend();this._renderManager.clear();}.bind(this),0);},_setViewModelAttr:function(_1b){if(_1b===this.viewModel){return;}this.inherited(arguments);this.destroyByKey("viewModel");this.ownByKey("viewModel",_2.connect(this.viewModel,"onContentChange",this,this._stopActiveEditorWrapper));this.ownByKey("viewModel",_2.connect(this.viewModel,"onSetActiveProperty",this,this.onSetActiveProperty));this.ownByKey("viewModel",_2.connect(this.viewModel,"onPropertyReverted",this,this._onPropertyReverted));this.ownByKey("viewModel",_c.subscribe("/dnd/start",function(){setTimeout(this.beginOperation.bind(this),0);}.bind(this.viewModel)));this.ownByKey("viewModel",_c.subscribe("/dnd/stop",_7.hitch(this,function(){if(this._activeEditorWrapper){return;}this.viewModel.endOperation();})));},_stopActiveEditorWrapper:function(){if(this._activeEditorWrapper!=null){_d(this._activeEditorWrapper.tryToStopEditing(),_7.hitch(this,function(){this._activeEditorWrapper=null;}));}},onSetActiveProperty:function(_1c){},onPreviewReady:function(_1d,doc,_1e){if(_1e||_1d!==this.viewModel){this.set("viewModel",_1d);this.setupEditMode(doc);}else{if(_1d){this.remapEditMode(doc);}}},_setButtonState:function(){this._setCommandEnabled("reverttopublished",this.viewModel&&!this.viewModel.contentData.isPendingPublish);},setupEditMode:function(doc){this.viewModel.reload().then(_7.hitch(this,function(){this._mappingManager.clear();if(this._renderManager){this._renderManager.destroy();}this._renderManager=new _16();if(this.toolbar&&!this._autoSaveButton){this._autoSaveButton=new _14({button:this.toolbar._getWidget("autosave")});this.own(_8.after(this._autoSaveButton,"onLayoutChanged",_7.hitch(this,function(){this.mainLayoutContainer.layout();})));}this._autoSaveButton.set("model",this.viewModel);var _1f=_7.hitch(this,function(){this._toggleUndoRedoActions(this.viewModel.hasUndoSteps,this.viewModel.hasRedoSteps);});this.viewModel.resetNotifications();this._destroyOverlay();this.ownByKey("viewModel",this.viewModel.watch("hasUndoSteps",_1f),this.viewModel.watch("hasRedoSteps",_1f));_1f();this.onReadySetupEditMode(doc);this._mutationObserver.setup(doc);doc=null;this._setButtonState();this.onPrepareOverlayComplete();}));},remapEditMode:function(doc){this.viewModel.reload().then(_7.hitch(this,function(){this._renderManager.resume();if(doc){setTimeout(_7.hitch(this,function(){this._remapUpdateControllers(doc);this.onPrepareOverlayComplete();this._toggleUndoRedoActions(this.viewModel.hasUndoSteps,this.viewModel.hasRedoSteps);this._autoSaveButton.set("model",this.viewModel);this._mutationObserver.setup(doc);}),1);}}));},_destroyOverlay:function(){this.destroyByKey("overlay");},onReadySetupEditMode:function(doc){this._createUpdateControllers(doc);},onSetupEditModeComplete:function(){if(this.activePropertyOnStartup){this.onSetActiveProperty(this.activePropertyOnStartup);this.activePropertyOnStartup=null;}},_getPropertyNodes:function(doc){var _20=_b("[data-epi-edit], [data-epi-property-name]",doc);var _21=_b("[data-epi-edit] [data-epi-edit], [data-epi-property-name] [data-epi-property-name], [data-epi-property-name] [data-epi-edit], [data-epi-edit] [data-epi-property-name]",doc);return _1.filter(_20,function(_22){return _21.indexOf(_22)===-1;});},_getEditableNodes:function(doc){if(!doc||!this.viewModel.canChangeContent()){return [];}var _23=this._getPropertyNodes(doc);var _24=[];_1.forEach(_23,function(_25){var _26=_10.pascalToCamel(_a.get(_25,"data-epi-edit")||_a.get(_25,"data-epi-property-name"));var _27=this.viewModel.getPropertyMetaData(_26);if(!_27){return;}if(_27.settings&&_27.settings.readOnly){return;}var _28=_10.pascalToCamel(_27.getName());var _29=_a.get(_25,"data-epi-property-display-name");if(_29){_27=_7.delegate(_27,{displayName:_29});}if(_27!=null&&_27.showForEdit){var _2a={cacheResults:true,rerenderOnCancel:false,propertyRenderSettings:_a.get(_25,"data-epi-property-rendersettings")||undefined,useMvc:_a.has(_25,"data-epi-use-mvc")?_a.get(_25,"data-epi-use-mvc").toLowerCase()==="true":false};_2a=_7.mixin(_2a,_27.additionalValues.renderSettings);var _2b=_a.get(_25,"data-epi-edit")?"none":_a.get(_25,"data-epi-property-render")||_27.customEditorSettings.rendererClass;switch(_2b){case "client":_2b="epi-cms/contentediting/ClientRenderer";break;case "none":_2b="epi-cms/contentediting/NullRenderer";break;}var _2c=_a.has(_25,"data-epi-property-editorsettings")?_6.fromJson(_a.get(_25,"data-epi-property-editorsettings")):null;var _2d=_a.has(_25,"data-epi-property-overlaysettings")?_6.fromJson(_a.get(_25,"data-epi-property-overlaysettings")):null;_2d=_7.mixin(_2d,_27.overlaySettings);_24.push({node:_25,disabled:(_a.get(_25,"data-epi-disabled")==="true"),useOverlay:(_a.get(_25,"data-epi-useoverlay")==="true"),overlayZIndex:parseInt(_a.get(_25,"data-epi-overlay-z-index"),10)||0,property:{name:_28,contentLink:this.viewModel.contentLink,contentModel:this.viewModel.contentModel,type:_a.get(_25,"data-epi-property-type"),wrapperType:_a.get(_25,"data-epi-edit")?"floating":_a.get(_25,"data-epi-property-edittype"),editorParams:_2c,overlayParams:_2d,editorWidgetType:_a.get(_25,"data-epi-property-editor"),renderSettings:_2a,rendererClass:_2b,metadata:_27,propertyNodeName:_26}});}},this);_24.sort(function(a,b){if(a.overlayZIndex<b.overlayZIndex){return -1;}else{if(a.overlayZIndex>b.overlayZIndex){return 1;}else{return 0;}}});return _24;},_createUpdateControllers:function(doc){var _2e=this._createFullPageUpdateController(doc);if(_2e){this._connectFullPageUpdateControllerEvents(_2e);this._mappingManager.add({updateController:_2e});}var _2f=this._getEditableNodes(doc);_1.forEach(_2f,function(_30){var _31=_30.property;var _32=_30.node.innerHTML;var _33=this._createNodeUpdateController(_30);_d(this._createNodeOverlay(_30),_7.hitch(this,function(_34){this._connectUpdateControllerAndOverlayEvents(_33,_34);this._mappingManager.add({blockPropertyInfo:_31,node:_30.node,updateController:_33,overlayItem:_34});}));this._renderManager.cacheRender(_31.name,_31.renderSettings,this.viewModel.getProperty(_31.name),_32);},this);},_createNodeOverlay:function(_35){var _36=new _4();if(!this.createOverlays){_36.resolve(null);return _36;}_d(_18.create(_35),_7.hitch(this,function(_37){this.overlay.addChild(_37);_36.resolve(_37);}));return _36;},_createNodeUpdateController:function(_38){var _39=_38.property;var _3a=_39.metadata;var _3b=new _17({displayName:_3a.displayName,renderManager:this._renderManager,contentModel:_39.contentModel,contentLink:_39.contentLink,modelPropertyName:_39.name,nodePropertyName:_39.propertyNodeName,renderSettings:_39.renderSettings,rendererClass:_39.rendererClass,displayNode:_38.node});return _3b;},_createFullPageUpdateController:function(doc){var _3c=[];if(doc){var _3d=_b("input[data-epi-full-refresh-property-names][type='hidden']",doc);_1.forEach(_3d,function(tag){_1.forEach(_a.get(tag,"data-epi-full-refresh-property-names").split(","),function(_3e){if(!_1.some(_3c,function(p){return p===_3e;})){_3c.push(_10.pascalToCamel(_3e));}});});}_1.forEach(this.viewModel.metadata.properties,function(_3f){if(_3f.additionalValues["reloadOnChange"]===true){_3c.push(_10.pascalToCamel(_3f.name));}});if(!_3c.length){return null;}var _40=new _17({displayName:"",renderManager:this._renderManager,contentModel:this.viewModel.contentModel,modelPropertyName:_3c,renderSettings:{isFullReload:true}});return _40;},_remapUpdateControllers:function(doc){var _41=this._getEditableNodes(doc);var _42=this._mappingManager.remap(_41);_1.forEach(_42,function(_43){var _44=_43.property;var _45=this._createNodeUpdateController(_43);_d(this._createNodeOverlay(_43),_7.hitch(this,function(_46){this._connectUpdateControllerAndOverlayEvents(_45,_46);this._mappingManager.add({blockPropertyInfo:_44,node:_43.node,updateController:_45,overlayItem:_46});}));this._renderManager.cacheRender(_44.name,_44.renderSettings,this.viewModel.getProperty(_44.name),_43.node.innerHTML);},this);var _47=this._createFullPageUpdateController(doc);if(_47){this._connectFullPageUpdateControllerEvents(_47);this._mappingManager.add({updateController:_47});}},_connectUpdateControllerAndOverlayEvents:function(_48,_49){if(_48){this.ownByKey("overlay",_8.after(_48,"onReloadRequired",_7.hitch(this,this._onBlockReloadRequired),true),_8.after(_48,"onRender",_7.hitch(this,this._onBlockRender),true));}if(_49){this.ownByKey("overlay",_8.after(_49,"onClick",_7.hitch(this,this._onOverlayItemClick),true),_8.after(_49,"onValueChange",_7.hitch(this,function(_4a){this._onOverlayValueChange(_49,_4a);}),true));}},_connectFullPageUpdateControllerEvents:function(_4b){this.destroyByKey("fullpageoverlay");this.ownByKey("fullpageoverlay",_8.after(_4b,"onReloadRequired",this._onBlockReloadRequired.bind(this),true),_8.after(_4b,"onRender",this._onBlockRender.bind(this),true));},_getEditor:function(_4c){var _4d=this._mappingManager.findOne("overlayItem",_4c);return (_4d.wrapper&&_4d.wrapper.editorWidget)?_4d.wrapper.editorWidget:null;},onEditorWrapperCreated:function(_4e){},_onOverlayItemClick:function(_4f){if(this._isCreatingWrapper){return;}this._isCreatingWrapper=true;var _50=this._mappingManager.findOne("overlayItem",_4f);var _51=_50.blockPropertyInfo;var val=this.viewModel.getProperty(_50.propertyName);var _52=_7.clone(val,true);var _53;var _54=_7.hitch(this,function(_55){_50.wrapper=_55;this._activeEditorWrapper=_55;_c.publish("/epi/layout/pinnable/propertyEditor/show",null);_1.forEach(this._mappingManager.find(),function(m){if(m.overlayItem){m.overlayItem.set("active",false);}});_50.overlayItem.set("active",true);var _56={value:_52,parent:_55};_d(_55.startEdit(_56)).always(_7.hitch(this,function(){this._isCreatingWrapper=null;}));this.overlay.set("readOnly",_55.isOverlayDisabled);this.viewModel.set("disableUndo",_55.isUndoDisabled);});if(_50.wrapper){_53=_50.wrapper;if(_53&&_53.editorWidget&&!_53.editorWidget.overlayItem){_53.editorWidget.overlayItem=_4f;}_53.set("blockDisplayNode",_50.node);_54(_53);}else{_d(this._createEditorWrapper(_51,_4f,_50.node,_52),_7.hitch(this,function(_57){_54(_57);this.onEditorWrapperCreated(_57);}));}},_createEditorWrapper:function(_58,_59,_5a,_5b){var def=new _4(),_5c={overlayItem:_59};_d(this.editorFactory.createEditor(_58,_5a,_5b,_5c),_7.hitch(this,function(_5d){this.ownByKey("overlay",_8.after(_5d,"onValueChange",_7.hitch(this,this._onWrapperValueChange),true),_8.after(_5d,"onCancel",_7.hitch(this,this._onWrapperCancel),true),_8.after(_5d,"onStopEdit",_7.hitch(this,this._onWrapperStopEdit),true));def.resolve(_5d);}),def.reject);return def;},_onBlockReloadRequired:function(_5e){var _5f=function(){if(this._activeEditorWrapper&&this._activeEditorWrapper.hasInlineEditor){return;}if(this._deferredReloadHandle){this._deferredReloadHandle.remove();this._deferredReloadHandle=null;}this._toggleUndoRedoActions(false,false);this.onReloadRequired();}.bind(this);if(this.viewModel.isSaved){_5f();}else{if(!this._deferredReloadHandle){this.own(this._deferredReloadHandle=_8.after(this.viewModel,"onPropertySaved",_5f,true));}}},_onBlockRender:function(_60){var _61=this._mappingManager.findOne("updateController",_60);if(_61&&_61.overlayItem){_61.overlayItem.refresh();}},_saveEditorChanges:function(_62,_63){var _64=this._getEditor(_62);if(_64&&!_64.overlayItem){_64.overlayItem=_62;}if(_64&&_64.saveChanges){_64.saveChanges(_64,_63);}},_onOverlayValueChange:function(_65,_66){this._saveEditorChanges(_65,_66.value);this.viewModel.setProperty(_66.propertyName,_66.value);},_onWrapperValueChange:function(_67,_68,_69){var _6a=this._mappingManager.findOne("wrapper",_67),_6b=_6a.propertyName;if(_6a.overlayItem){_6a.overlayItem.set("updated",true);}this.viewModel.beginOperation();this.viewModel.setProperty(_6b,_68,_69);},_onWrapperStopEdit:function(_6c,_6d,_6e,_6f){var _70=this._mappingManager.findOne("wrapper",_6c);this.viewModel.endOperation();if(_70.overlayItem){_70.overlayItem.set("active",false);}this._activeEditorWrapper=null;this.overlay.set("readOnly",false);this.viewModel.set("disableUndo",false);},_onWrapperCancel:function(_71,_72){var _73=this._mappingManager.findOne("wrapper",_71),_74=_73.updateController;this.viewModel.abortOperation();if(_74&&_74.renderSettings&&_74.renderSettings.rerenderOnCancel){_74.render();}if(_73.overlayItem){_73.overlayItem.set("active",false);}this._activeEditorWrapper=null;this.overlay.set("readOnly",false);this.viewModel.set("disableUndo",false);},_onPropertyReverted:function(_75,_76){this._mappingManager.find("propertyName",_75).forEach(function(_77){var _78=_77.wrapper,_79;if(_78){_79=_78.get("editing");_78.set("editing",false);_78.set("value",_76);_78.set("editing",_79);}});},_toggleUndoRedoActions:function(_7a,_7b){this._setCommandEnabled("undo",!!_7a);this._setCommandEnabled("redo",!!_7b);}});});