//>>built
require({cache:{"url:epi-cms/contentediting/templates/PageDataController.html":"<div style=\"width: 100%; height: 100%;\">\r\n    <div data-dojo-attach-point=\"mainLayoutContainer\" data-dojo-type=\"epi/shell/layout/PreserveRatioBorderContainer\" data-dojo-props=\"gutters: false, livesplitters: false\" style=\"width: 100%; height: 100%\">\r\n        <div data-dojo-attach-point=\"toolbar\" data-dojo-type=\"epi-cms/contentediting/EditToolbar\" data-dojo-props=\"region:'top'\"></div>\r\n        <div data-dojo-attach-point=\"notificationBar\" data-dojo-type=\"epi-cms/contentediting/NotificationBar\" data-dojo-props=\"region:'top', layoutPriority: 90\"></div>\r\n        <div data-dojo-attach-point=\"activityFeed\" data-dojo-type=\"epi-cms/activity/ActivityFeed\" data-dojo-props=\"region: 'right', model: this.activityModel, layoutPriority: 95, splitter: true, minSize: 200\" style=\"width: 25%; min-width: 200px\" class=\"dijitHidden\"></div>\r\n        <div data-dojo-attach-point=\"editLayoutContainer\" data-dojo-type=\"epi/shell/layout/CardContainer\" data-dojo-props=\"region: 'center', layoutPriority: 100\">\r\n            <div data-dojo-attach-point=\"iframeWithOverlay\" data-dojo-type=\"epi/shell/widget/IframeWithOverlay\" data-dojo-props=\"fitContainer: true, iframeName:'${iframeName}'\">\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n"}});define("epi-cms/contentediting/PageDataController",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-style","dojo/aspect","dojo/Deferred","dojo/topic","dojo/when","dijit/_TemplatedMixin","dijit/_Widget","dijit/_WidgetsInTemplateMixin","epi/debounce","epi/dependency","epi/Url","epi/shell/StickyViewSelector","epi/shell/TypeDescriptorManager","epi/shell/postMessage","epi-cms/_ContentContextMixin","epi-cms/contentediting/EditNotifications","epi-cms/contentediting/ContentViewModel","epi-cms/contentediting/viewmodel/ContentActivityFeedViewModel","epi-cms/contentediting/command/Editing","epi/i18n!epi/cms/nls/episerver.cms.contentediting","dojo/text!./templates/PageDataController.html","dijit/layout/BorderContainer","epi/shell/layout/CardContainer","epi/shell/layout/PreserveRatioBorderContainer","epi/shell/widget/IframeWithOverlay","epi-cms/contentediting/EditToolbar","epi-cms/contentediting/NotificationBar","epi-cms/activity/ActivityFeed"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,res,_18){return _2([_b,_a,_c,_13],{templateString:_18,contextTypeName:"epi.cms.contentdata",iframeName:"sitePreview",pendingNotificationTimeOutId:null,isActive:true,defaultEditCssRules:[{selector:".epi-injected-minSize",css:"min-height: 30px;"},{selector:".epi-injected-minSize-inline",css:"min-height: 30px; min-width: 100px; display: inline-block !important;"},{selector:"[contenteditable=true]:focus",css:"outline: 3px #1456F1 solid;"}],_currentViewComponent:null,_viewModels:null,_notificationHandlerId:null,_messageService:null,_postMessage:null,_editingCommands:null,_currentViewModel:null,_pageDataStore:null,_availableViews:null,_previewQueryParameters:null,_viewSettingsManager:null,_inUseNotificationManager:null,_ensurePreviewReadyPromise:null,_stickyViewSelector:null,componentTypeName:null,postMixInProperties:function(){this.inherited(arguments);var _19=_e.resolve("epi.storeregistry");this._pageDataStore=this._pageDataStore||_19.get("epi.cms.contentdata");this._stickyViewSelector=new _10();this._viewSettingsManager=_e.resolve("epi.viewsettingsmanager");this._messageService=this._messageService||_e.resolve("epi.shell.MessageService");this._profile=this._profile||_e.resolve("epi.shell.Profile");this._postMessage=this._postMessage||_12;this._editingCommands=_17;if(!this._viewModels){this._viewModels=[];}this._inUseNotificationManager=this.inUseNotificationManager||_e.resolve("epi.cms.contentediting.inUseNotificationManager");this._editNotifications=this._editNotifications||new _14();this.own(this._editNotifications,this._editNotifications.on("changed",function(e){this._defaultNotificationWatchHandler("",e.oldValue,e.newValue,e.notification);}.bind(this)));this.activityModel=this.activityModel||new _16({componentTypeName:this.componentTypeName});this.own(this.activityModel.watch("isActivitiesVisible",this._toggleActivities.bind(this)));},postCreate:function(){var cs;this.inherited(arguments);this.subscribe("/epi/cms/action/switcheditmode",this._switchEditMode.bind(this));cs=_e.resolve("epi.shell.ContextService");this._interceptorHandle=cs.registerRequestInterceptor(this._interceptRequestContext.bind(this));this.own(this.notificationBar.on("notificationsChanged",function(){this.mainLayoutContainer.layout();}.bind(this)),_8.subscribe("/epi/cms/action/undo",this._undoAction.bind(this)),_8.subscribe("/epi/cms/action/redo",this._redoAction.bind(this)),_8.subscribe("/epi/cms/action/save",this._saveAction.bind(this)));},startup:function(){if(this._started){return;}this.inherited(arguments);this.iFrame=this.iframeWithOverlay.iframe;this.connect(this.iFrame,"onLoad","_iFrameLoaded");this.connect(this.iFrame,"onUnload","_iFrameUnLoaded");_4.add(this.toolbar.domNode,"epi-localToolbar epi-viewHeaderContainer");this._injectCssRules();_9(this.getCurrentContext(),function(_1a){this.contextChanged(_1a);}.bind(this));this._toggleActivities();var _1b=this.mainLayoutContainer.getSplitter("right");_6.after(_1b,"_stopDrag",function(){var _1c={size:_5.get(this.activityFeed.domNode,"width")};this.activityModel._persistActivityFeedSettings(_1c);}.bind(this));},buildRendering:function(){this.inherited(arguments);this._loadSettings();},destroy:function(){this._interceptorHandle&&this._interceptorHandle.remove();this._destroyCurrentViewComponent();this._viewModels.forEach(function(vm){vm.destroy();});this._viewModels=null;this.inherited(arguments);},_defaultNotificationWatchHandler:function(_1d,_1e,_1f,_20){if(_1e){this.notificationBar.remove(_1e);}if(_1f&&_1f.content){var _21=_20?this._editNotifications.getAvailableNotificationIndex(_20):0;this.notificationBar.add(_1f,_21);}},_switchEditMode:function(_22,_23,_24){var _25,_26=this._currentViewModel.viewName,_27=false,_28="view",_29="onpageedit",_2a="formedit";if(!this.isActive){return;}if(_26===_28){_8.publish("/epi/cms/action/disablepreview");}if(_26===_2a){_25=_29;_27=true;}else{_25=_2a;}if(_24){this._stickyViewSelector.save(this._currentViewModel.contentData.hasTemplate,this._currentViewModel.contentData.typeIdentifier,_25);}return this._ensurePreviewReady(this.setView(_25,_23),_27,true,_25);},_iFrameLoaded:function(url,_2b){if(!!url&&!_2b){this._requestContextChangeByUrl(url,true,true);}_9(this._profile.get("isEPiBetaUser")).then(function(_2c){if(!_2c){return null;}this._postMessage.publish("beta/epiReady",this._getInitialData(url),this.iFrame.getWindow());}.bind(this));},_getInitialData:function(url){url=new _f(url);if(!url.query||url.query.epieditmode!=="True"){return {isEditable:false};}return {isEditable:!!this._currentViewModel&&this._currentViewModel.canChangeContent()};},_iFrameUnLoaded:function(url){this.iframeWithOverlay.overlay.set("enabled",false);},_destroyCurrentViewComponent:function(){if(this._currentViewComponentReloadRequireHandle){this._currentViewComponentReloadRequireHandle.remove();this._currentViewComponentReloadRequireHandle=null;}if(this._currentViewComponent){this._currentViewComponent.destroyRecursive();this._currentViewComponent=null;}},_getViewModelIndex:function(id){var _2d=-1;_1.some(this._viewModels,function(_2e,idx){if(_2e.contentLink===id){_2d=idx;return true;}});return _2d;},_getViewModel:function(id){var _2f=this._getViewModelIndex(id);if(_2f>=0){return this._viewModels[_2f];}else{return null;}},_removeViewModel:function(id){var _30=this._getViewModelIndex(id);if(_30>=0){var _31=this._viewModels.splice(_30,1)[0];_31.clear();}},_createViewModel:function(_32,ctx){var _33=new _15({contentLink:_32.contentLink,contextTypeName:this.contextTypeName});_33.set("contentData",_32);_33.set("languageContext",ctx.languageContext);this._viewModels.push(_33);return _33;},contentContextUpdated:function(ctx,_34){var _35=ctx.id;this._pageDataStore.refresh(_35).then(function(_36){if(this._currentViewModel){this._updateContentViewModel(_36,ctx.languageContext);this._refreshModel(_36,ctx);this._onViewRequireReload();}}.bind(this));},updateView:function(_37,ctx,_38){this._setActivityCommandModel();_9(this._ensurePreviewReadyPromise,function(){if(_37&&_37.skipUpdateView&&_37.viewName===this._currentViewModel.viewName){return;}if(_38&&_38.widgetResumed){_5.set(this.domNode,"visibility","hidden");}if(_37&&_37.contextIdSyncChange){this._pageDataStore.refresh(ctx.id).then(function(_39){var _3a=this._currentViewModel.contentData.contentLink;this._updateContentViewModel(_39,ctx.languageContext);this._currentViewComponent.onContentLinkSyncChange(_3a,_39.contentLink);this._refreshModel(_39,ctx);}.bind(this));}else{if(this._currentViewModel){this._currentViewModel.suspend();}var _3b;if(_37&&_37.viewName){if(_37.availableViews){this._availableViewsLookup={};_1.forEach(_37.availableViews,function(_3c){this._availableViewsLookup[_3c.key]=_3c;},this);}_3b=_37.viewName;}var _3d=_37.forceReload;if((_3b==="view"||_3b==="onpageedit")&&this._currentViewModel&&this._currentViewModel.viewName==="formedit"){_3d=true;}return this._ensurePreviewReady(this._loadContentDataAndSetView(ctx.id,_3b,ctx,_37.availableViews),true,_3d,_3b);}}.bind(this));},_getPreviewUrl:function(_3e){return _9(this.getCurrentContext(),function(_3f){return (_3e==="view"&&_3f.previewUrl)?_3f.previewUrl:_3f.editablePreviewUrl;});},_ensurePreviewReady:function(_40,_41,_42,_43){var def=new _7();if(_40){def=_40;}else{def.resolve();}if(_41&&_43!=="formedit"){def=def.then(function(_44){return _9(this._getPreviewUrl(_43),function(url){return _9(this._changeUrl(url,_42),function(){return _44;});}.bind(this));}.bind(this));}this._ensurePreviewReadyPromise=_9(def,function(_45){var doc=this.iframeWithOverlay.iframe.getDocument();var _46=this.connect(this._currentViewComponent,"onPrepareOverlayComplete",function(){this.disconnect(_46);_46=null;this.iframeWithOverlay.overlay.set("enabled",this._currentViewModel.get("showOverlay")&&this.iframeWithOverlay.iframe.isInspectable());if(this._viewSettingsManager.get("enabled")&&this._viewSettingsManager.getSettingProperty("project")){this.iframeWithOverlay.overlay.set("enabled",false);}this.iframeWithOverlay.layout(true);});_5.set(this.domNode,"visibility","visible");this._viewSettingsManager.onPreviewReady(this.iframeWithOverlay);this._currentViewComponent.onPreviewReady(this._currentViewModel,doc,!!_45);this._editNotifications.updateSettings({viewModel:this._currentViewModel,viewSetting:this._viewSettingsManager});}.bind(this));return this._ensurePreviewReadyPromise;},_loadContentDataAndSetView:function(_47,_48,ctx,_49){var def=new _7();_9(this._pageDataStore.refresh(_47)).then(function(_4a){this.toolbar.update({currentContext:ctx,viewConfigurations:{availableViews:_49,viewName:_48},contentData:_4a});if(!_4a){return;}if(this._currentViewModel&&this._currentViewModel.contentLink!==_47){this.notificationBar.clear();}this._currentViewModel=this._getViewModel(_4a.contentLink);if(!this._currentViewModel){this._currentViewModel=this._createViewModel(_4a,ctx);this._setActivityModel(_4a);}else{this._updateContentViewModel(_4a,ctx.languageContext);}this._currentViewModel.set("viewLanguage",this._viewSettingsManager.get("enabled")?this._viewSettingsManager.getSettingProperty("viewlanguage"):null);this._refreshModel(_4a,ctx);_9(this.setView(_48)).then(function(){def.resolve(true);}).otherwise(function(){def.cancel();});}.bind(this)).otherwise(function(){def.reject();});return def.promise;},_updateContentViewModel:function(_4b,_4c){this._currentViewModel.wakeUp();this._currentViewModel.set("contentData",_4b);this._currentViewModel.set("languageContext",_4c);this._setActivityModel(_4b);},_refreshModel:function(_4d,_4e){var _4f=this._currentViewModel;if(_4f){this.toolbar.set("contentViewModel",_4f);this._inUseNotificationManager.updateCommandModel(_4f);this._editingCommands.set("model",_4f);this._editNotifications.update(_4d,_4e,_4f);}},itemChanged:function(id,_50){},setView:function(_51,_52){var def=new _7();if(_51==="onpageedit"&&(!this._currentViewModel.contentData.hasTemplate||!(_51 in this._availableViewsLookup))){_51="formedit";}if(_51&&!(_51 in this._availableViewsLookup)){return;}var _53=function(){_9(this._setView(_51,_52),function(){def.resolve();},function(){def.cancel();});}.bind(this);var _54=function(){_8.publish("/epi/cms/action/showerror");def.cancel();};_9(this._savePendingChanges(),_53,_54);return def;},_setView:function(_55,_56){var def=new _7(),_57=this._currentViewComponent,_58=_57&&_57.viewModel&&_57.viewModel.viewName===_55;var _59=function(def){if(this.editLayoutContainer.leftOver&&!this._currentViewComponent.canHandleLeftOver){_9(this.editLayoutContainer.selectedChildWidget===this.editLayoutContainer.leftOver?this.editLayoutContainer.selectChild(this.iframeWithOverlay):null,function(){this.editLayoutContainer.removeChild(this.editLayoutContainer.leftOver);this.editLayoutContainer.leftOver.destroyRecursive();this.editLayoutContainer.leftOver=null;}.bind(this));}def.resolve();}.bind(this);_8.publish("/epi/shell/action/changeview/updatestate",{viewName:_55});if(_58){this._currentViewModel.viewName=_55;this.toolbar.set("contentViewModel",this._currentViewModel);_59(def);}else{this._destroyCurrentViewComponent();var _5a=this._availableViewsLookup[_55].viewType;require([_5a],function(_5b){this._currentViewComponent=new _5b(_3.mixin({mainLayoutContainer:this.mainLayoutContainer,editLayoutContainer:this.editLayoutContainer,iframeWithOverlay:this.iframeWithOverlay,contextTypeName:this.contextTypeName,toolbar:this.toolbar},_56));this._currentViewComponentReloadRequireHandle=this.connect(this._currentViewComponent,"onReloadRequired",this._onViewRequireReload);_9(this._profile.get("isEPiBetaUser"),function(_5c){if(_5c){this._currentViewComponent.on("dom-updated",_d(this._onDomUpdated,this,100));}}.bind(this));this._currentViewComponent.startup();this._currentViewModel.viewName=_55;this.toolbar.set("contentViewModel",this._currentViewModel);_59(def);}.bind(this));}return def;},_onViewRequireReload:function(){return this._ensurePreviewReady(null,true,true,this._currentViewModel.viewName);},resize:function(_5d){this.inherited(arguments);if(this._started){this.mainLayoutContainer.resize(_5d);}},onShow:function(){this.iframeWithOverlay.overlay.set("enabled",true);this.iframeWithOverlay.overlay.set("readOnly",false);},onHide:function(){this.iframeWithOverlay.overlay.set("enabled",false);if(this._currentViewModel){this._currentViewModel.resetNotifications();}},_requestContextChangeByUrl:function(url,_5e,_5f,_60,_61){var _62=new _f(url,_60,_61),_63={url:_62.toString()},_64={sender:this,forceContextChange:_5e,suppressFailure:_5f,viewName:this._currentViewModel&&this._currentViewModel.viewName};_8.publish("/epi/shell/context/request",_63,_64);},_changeUrl:function(url,_65){var _66=_3.mixin(this._previewQueryParameters,this._viewSettingsManager.get("previewParams"));return this.iframeWithOverlay.iframe.load(url,{query:_66},true,_65);},_interceptRequestContext:function(_67,_68){if(!(_68&&_68.sender&&_68.sender===this)){return this._savePendingChanges();}else{var def=new _7();def.resolve();return def;}},_savePendingChanges:function(){if(this._saveDeferred&&!this._saveDeferred.isFulfilled()){return this._saveDeferred.promise;}else{this._saveDeferred=new _7();}if(this._currentViewModel&&this._currentViewModel.get("hasPendingChanges")&&!this._currentViewModel.get("hasErrors")){var _69=this._currentViewModel.watch("hasPendingChanges",function(_6a,_6b,_6c){if(!_6c){_69.remove();_69=null;this._saveDeferred.resolve();}}.bind(this));this._currentViewModel.save();}else{this._saveDeferred.resolve();}return this._saveDeferred.promise;},savePendingChanges:function(){return this._savePendingChanges();},_injectCssRules:function(){this.iFrame.addCssRules(this.defaultEditCssRules);},_undoAction:function(){if(this.get("isActive")&&this._currentViewModel){this._currentViewModel.undo();}},_redoAction:function(){if(this.get("isActive")&&this._currentViewModel){this._currentViewModel.redo();}},_saveAction:function(){if(this.get("isActive")&&this._currentViewModel){this._currentViewModel.save();}},_onDomUpdated:function(){if(!this._currentViewComponent){return;}var doc=this.iframeWithOverlay.iframe.getDocument();this._currentViewComponent.onPreviewReady(this._currentViewModel,doc,false);},_setIsActiveAttr:function(_6d){this._set("isActive",_6d);if(_6d){this._currentViewModel&&this._currentViewModel.wakeUp();this._editNotifications.wakeUp();}else{this._viewModels.forEach(function(_6e){_6e.suspend();});this._editNotifications.suspend();}},_toggleActivities:function(){_4.toggle(this.activityFeed.domNode,"dijitHidden",!this.activityModel.isActivitiesVisible);_4.toggle(this.activityFeed._splitterWidget.domNode,"dijitHidden",!this.activityModel.isActivitiesVisible);this._loadSettings();this.mainLayoutContainer.layout();},_setActivityCommandModel:function(){var _6f=_e.resolve("contentActivityCommandProvider");_6f.updateCommandModel(this.activityModel);},_setActivityModel:function(_70){this.activityModel.set({contentLink:_70.contentLink,name:_70.name});},_loadSettings:function(){var _71=this.activityModel.getActivityFeedSettings();if(!_71||!_71.size||_5.get(this.mainLayoutContainer.domNode,"width")<_71.size){return;}_5.set(this.activityFeed.domNode,"width",_71.size+"px");}});});