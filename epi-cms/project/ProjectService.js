//>>built
define("epi-cms/project/ProjectService",["dojo/_base/declare","dojo/_base/lang","dojo/when","dojo/Deferred","dojo/promise/all","dojo/Evented","dojo/aspect","dijit/Destroyable","epi/dependency","epi/shell/xhr/errorHandler","epi-cms/ApplicationSettings","epi-cms/core/ContentReference"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _1([_6,_8],{isProjectModeEnabled:false,projectItemStore:null,projectStore:null,_currentProjectProfileKey:"epi.current-project-id",constructor:function(_d){_1.safeMixin(this,_d);this.projectItemStore=this.projectItemStore||_9.resolve("epi.storeregistry").get("epi.cms.project.item");this.projectStore=this.projectStore||_9.resolve("epi.storeregistry").get("epi.cms.project");this.profile=this.profile||_9.resolve("epi.shell.Profile");this.isProjectModeEnabled=_b.isProjectModeEnabled;this.own(this.projectItemStore.on("update",this._onProjectItemUpdated.bind(this)),this.projectItemStore.on("delete",this._onProjectItemRemoved.bind(this)),this.projectStore.on("update",this._onProjectUpdated.bind(this)),this.projectStore.on("delete",this._onProjectRemoved.bind(this)));},hasScheduledProjectItems:function(_e){return _a.wrapXhr(this.projectStore.refresh(_e)).then(function(_f){return _f.itemStatusCount.delayedpublish>0||_f.itemStatusCount.delayedpublish_nopublishaccess>0;}.bind(this));},getProjectItemsForContent:function(_10){if(!(_10 instanceof Array)){_10=[_10];}return _3(this.projectItemStore.query({contentLinks:_10}));},getProjectItemForContent:function(_11){var _12=new _c(_11);if(_12.workId===0){return new _4().reject("The content link needs to be version specific");}return this.getProjectItemsForContent(_11).then(function(_13){for(var i=0;i<_13.length;i++){if(_13[i].contentLink===_11){return _13[i];}}return null;});},getProjectsForContent:function(_14){var _15=this;if(!(_14 instanceof Array)){_14=[_14];}return this.getProjectItemsForContent(_14).then(function(_16){if(_16.length===0){return new _4().resolve([]);}return _15.getProjects(_16);});},canAddContent:function(_17,_18,_19){var _1a=_18.filter(function(_1b,pos){return _18.indexOf(_1b)===pos;});return this.projectStore.executeMethod("CanAddContent",_17,{contentReferences:_1a,languageId:_19});},getProjects:function(_1c){var _1d=this.projectStore;var _1e=_1c.map(function(_1f){return _1d.get(_1f.projectId);});return _5(_1e);},exists:function(_20){return _a.wrapXhr(this.projectStore.executeMethod("exists",_20));},addProjectItems:function(_21,_22){_22=_22.filter(function(_23,pos){if(_c.isContentReference(_23)&&_22.indexOf(_23)===pos){return true;}});var _24=this.projectItemStore.executeMethod("addItems",_21,{contentLinks:_22}).then(function(_25){_25.forEach(function(_26){this.projectItemStore.notify(_26,this.projectItemStore.getIdentity(_26));},this);return _25;}.bind(this));return _a.wrapXhr(_24);},removeProjectItems:function(_27){var _28=_27.map(function(_29){return _29.id;});return _a.wrapXhr(this.projectItemStore.removeRange(_28));},markAsReadyForReview:function(_2a,_2b){var _2c=_2.mixin({projectItems:_2a},_2b);return _a.wrapXhr(this.projectItemStore.executeMethod("ReadyForReview","",_2c));},markAsReadyToPublish:function(_2d){return _a.wrapXhr(this.projectItemStore.executeMethod("ReadyToPublish","",_2d));},isPartOfDelayedPublishedProject:function(_2e){return this.getProjectsForContent([_2e]).then(function(_2f){return _2f.some(function(_30){return _30.status==="delayedpublished";});});},publishProject:function(_31,_32){var _33=this.projectStore;if(isNaN(_31)){throw new Error("projectId is not a number");}return _a.wrapXhr(_33.executeMethod("Publish",_31,{delayPublishUntil:_32})).then(_33.patchCache.bind(_33));},reactivateProject:function(_34){var _35=this.projectStore;if(isNaN(_34)){throw new Error("The given project ID is not a number.");}return _a.wrapXhr(_35.executeMethod("Reactivate",_34)).then(_35.patchCache.bind(_35));},getCurrentProjectId:function(){if(!this.isProjectModeEnabled){return new _4().resolve(null);}return _3(this.profile.get(this._currentProjectProfileKey));},getCurrentProject:function(){var _36=this.projectStore;var _37=this;return this.getCurrentProjectId().then(function(_38){if(!_38){return null;}return _3(_36.get(_38)).otherwise(function(ex){if(ex.status===404){_37.setCurrentProject(null);}return null;});});},setCurrentProject:function(_39){this.emit("currentProjectChanged",_39);return this.profile.set(this._currentProjectProfileKey,_39&&_39.id,{location:"server"});},_onProjectItemUpdated:function(_3a){this.emit("project-item-updated",_3a.target);},_onProjectItemRemoved:function(_3b){this.emit("project-item-removed",_3b.id);},_onProjectUpdated:function(_3c){this.emit("project-updated",_3c.target);},_onProjectRemoved:function(_3d){this.emit("project-removed",_3d.id);}});});