//>>built
define("epi-cms/project/viewmodels/_ProjectViewModel",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/Evented","dojo/Stateful","dojo/topic","dojo/dom-class","dojo/promise/all","dojo/when","dojo/string","dijit/Destroyable","epi/epi","epi/datetime","epi/dependency","epi/username","epi/shell/_ContextMixin","epi/shell/xhr/errorHandler","epi-cms/plugin-area/project-overview","../../contentediting/ContentActionSupport","epi/shell/command/withConfirmation","../command/AddProject","../command/PublishProject","../command/EditProjectItem","../command/ReadyForReviewProjectItem","../command/ReadyToPublishProjectItem","../command/RefreshProjectItems","../command/RemoveProject","../command/RemoveProjectItem","../command/RemoveProjectScheduling","../command/RenameProject","../command/SortProjectItems","../command/ScheduleProject","epi/i18n!epi/nls/episerver.cms.components.project","epi/i18n!epi/nls/episerver.shared.action"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21,res,_22){return _1([_6,_c,_5,_11],{commands:null,namedCommands:null,created:"",createdBy:"",profile:null,contentLanguage:"",dndEnabled:false,isActivitiesVisible:false,projectStore:null,projectSortOrder:null,projectItemStore:null,projectItemQuery:null,activitiesStore:null,projectItemSortOrder:null,projectStatus:"",projectName:"",notificationMessage:"",selectedProject:null,selectedProjectItems:null,projectItemCountMessage:"",placeholderState:"noProjects",_sortOrderProfileKey:"epi.project-sort-order",_isActivitiesVisibleProfileKey:"epi.project-is-activities-visible",_messages:null,constructor:function(){this.projectItemSortOrder=[];this.projectSortOrder=[{attribute:"created",descending:true}];this.selectedProjectItems=[];this.own(_13.on("added, removed",this._updateCommands.bind(this)));},postscript:function(){this.inherited(arguments);this.projectService=this.projectService||_f.resolve("epi.cms.ProjectService");this.projectStore=this.projectStore||_f.resolve("epi.storeregistry").get("epi.cms.project");this.projectItemStore=this.projectItemStore||_f.resolve("epi.storeregistry").get("epi.cms.project.item");this.activitiesStore=this.activitiesStore||_f.resolve("epi.storeregistry").get("epi.cms.activities");this.profile=this.profile||_f.resolve("epi.shell.Profile");this._messages=this.isProjectModeEnabled()?res.status.message:_2.mixin({},res.status.message,res.status["messagelegacy"]);this._createCommands();this.own(this.projectService.on("project-item-updated",_2.hitch(this,this._updateSelectedItems)),this.projectService.on("project-updated",_2.hitch(this,this._projectUpdated)));},initialize:function(){return _9(_a(this.profile.get(this._sortOrderProfileKey),_2.hitch(this,function(_23){var _24=this._findSortOption("key",_23)||this.namedCommands.sortProjectItems.options[0];this._changeAttrValue("projectItemSortOrder",_24.value);})),_a(this._loadSelectedProject(),_2.hitch(this,function(_25){this._updateSelectedProjectDependencies(_25);this._changeAttrValue("selectedProject",_25);})),_a(this.profile.getContentLanguage(),_2.hitch(this,function(_26){this.set("contentLanguage",_26);})),_a(this.profile.get(this._isActivitiesVisibleProfileKey),_2.hitch(this,function(_27){if(typeof _27==="boolean"){this.set("isActivitiesVisible",_27);}})));},isProjectModeEnabled:function(){return this.projectService.isProjectModeEnabled;},getCommands:function(){return this.commands;},addProject:function(_28){this.projectStore.add(_28).then(_2.hitch(this,function(_29){this.set("selectedProject",_29);})).otherwise(_12.forXhr);},getProject:function(){return this.get("selectedProject");},updateProject:function(_2a){this.projectStore.put(_2a).then(_2.hitch(this,"set","selectedProject")).otherwise(_12.forXhr);},publishProject:function(_2b,_2c){var _2d=this;return this.projectService.publishProject(_2b,_2c).then(function(_2e){return _2d._updateSelectedProjectAndRefreshContextRequest(_2e).then(function(){return _2e;});});},reactivateProject:function(_2f){var _30=this;if(isNaN(_2f)){throw new Error("The given project ID is not a number.");}return this.projectService.reactivateProject(_2f).then(function(_31){return _30._updateSelectedProjectAndRefreshContextRequest(_31).then(function(){return _31;});});},refreshActivities:function(){this.emit("refresh-activities");},refreshProject:function(_32){var _33=this;if(_32===undefined){_32=true;}if(this.selectedProject){return this.projectStore.refresh(this.selectedProject.id).then(function(_34){_33.set("selectedProject",_34);if(_32){_33.emit("refresh");}return _34;},function(ex){_33.set("selectedProject",null);});}if(_32){this.emit("refresh");}},removeProject:function(){var _35=this,_36=this.projectStore;if(!this.selectedProject){return new _4().resolve();}return _36.remove(this.selectedProject.id).then(function(){_35.set("selectedProject",null);});},canAddContent:function(_37){var _38=this.get("selectedProject").id;return this.projectService.canAddContent(_38,_37);},canPublishProject:function(_39){var _3a;function _3b(){return Object.keys(_3a).some(function(key){if(key.indexOf("nopublishaccess")>-1){if(_3a[key]>0){return true;}}});};function _3c(_3d){return _3a[_3d]>0;};_39=_39||this.selectedProject;_3a=_39&&_39.itemStatusCount;if(this.isProjectModeEnabled()){return !!_39&&_39.itemStatusCount.checkedin>0;}else{return !!_39&&(_39.status==="active"||_39.status==="publishfailed")&&!_3b()&&!_3c("notcreated")&&!_3c("rejected")&&!_3c("checkedout")&&(_3c("checkedin")||_3c("published")||_3c("previouslypublished")||_3c("delayedpublish"));}},addProjectItems:function(_3e,_3f){var _40=this.get("selectedProject");_3f=_3f||(_40&&_40.id);if(!_3f){throw new Error("If no projectId is provided a selectedProject must be set in the context");}return this.projectService.addProjectItems(_3f,_3e);},removeSelectedProjectItems:function(){var _41=this.projectService.removeProjectItems(this.selectedProjectItems);_41.then(function(){this.emit("item-removed");}.bind(this));return _41;},markProjectItemsAsReadyForReview:function(_42){return this._setStatusOnProjectItems("markAsReadyForReview",{comment:_42});},markProjectItemsAsReadyToPublish:function(){this._setStatusOnProjectItems("markAsReadyToPublish");},_setStatusOnProjectItems:function(_43,_44){if(!this.selectedProjectItems.length){return new _4().resolve();}var _45=this;var _46=this.selectedProjectItems.map(function(_47){return _47.id;});return this.projectService[_43](_46,_44).then(function(){return _a(_45.getCurrentContext());}).then(function(ctx){var _48;_45.selectedProjectItems.some(function(_49){if(_49.contentLink===ctx.id){_48=_49;return true;}});if(_48){_45.requestContextChange(_48.contentLink);}});},requestContextChange:function(_4a){var _4b=_4a.uri?_4a:{uri:"epi.cms.contentdata:///"+_4a};_7.publish("/epi/shell/context/request",_4b,{sender:this});},updateActivityFeed:function(_4c){},_projectUpdated:function(_4d){if(this.selectedProject&&this.selectedProject.id===_4d.id){this.set("selectedProject",_4d);}},_updateSelectedItems:function(_4e){var _4f=this.selectedProjectItems.length;for(var i=0;i<_4f;i++){if(this.selectedProjectItems[i].id===_4e.id){this.selectedProjectItems[i]=_4e;this.set("selectedProjectItems",this.selectedProjectItems);this.emit("selected-project-items-updated",this.selectedProjectItems);break;}}},onCommandsChanged:function(_50,_51,_52){},_updateCommands:function(){var _53=this.commands;this._createCommands();this.onCommandsChanged("commands",_53,this.commands);},_createCommands:function(){var _54=this._getOrCreateNamedCommands();var _55=Object.keys(_54).map(function(key){return _54[key];});_13.get().forEach(function(_56){this.own(_56);_55.push(_56);}.bind(this));_55=_55.sort(function(a,b){return a.order-b.order;});this.set("commands",_55);},_getOrCreateNamedCommands:function(){if(this.namedCommands){return this.namedCommands;}var _57=Object.assign(this._createProjectCommands(),this._createProjectItemCommands());this.own.apply(this,_57);this.set("namedCommands",_57);return _57;},_createProjectCommands:function(){return {addProject:new _16({model:this,order:10}),renameProject:new _1f({model:this,order:20}),removeProject:new _1c({model:this,order:30,store:this.projectStore}),publishProject:new _17({model:this,order:40}),scheduleProject:new _21({model:this,order:50}),removeProjectScheduling:_15(new _1e({model:this,order:60}),null,{title:res.command.removeschedulingprojectitem.title,description:res.command.removeschedulingprojectitem.confirmation,confirmActionText:_22.remove,cancelActionText:_22.cancel})};},_createProjectItemCommands:function(){return {readyForReviewProjectItem:new _19({model:this,order:90}),readyToPublishProjectItem:new _1a({model:this,order:100}),editProjectItem:new _18({model:this,order:110}),removeProjectItem:_15(new _1d({model:this,order:120}),null,{title:res.command.removeprojectitem.label,description:res.command.removeprojectitem.confirmation,confirmActionText:_22.remove,cancelActionText:_22.cancel}),sortProjectItems:new _20({model:this,order:130}),refreshProjectItems:new _1b({model:this,order:140})};},_loadSelectedProject:function(){return this.projectService.getCurrentProject();},_persistSelectedProject:function(_58){this.profile.set(this._selectedProjectProfileKey,_58&&_58.id,{location:"server"});},_persistSortOrder:function(_59){var _5a=this._findSortOption("value",_59),key=_5a&&_5a.key||null;this.profile.set(this._sortOrderProfileKey,key,{location:"server"});},_persistIsActivitiesPanelVisible:function(_5b){this.profile.set(this._isActivitiesVisibleProfileKey,_5b,{location:"server"});},_findSortOption:function(key,_5c){var _5d=this.namedCommands.sortProjectItems.options,_5e=null;_5c&&_5d.some(function(_5f){if(_5c===_5f[key]){_5e=_5f;return true;}});return _5e;},_updateSelectedProjectDependencies:function(_60){var _61="",_62="",_63="",_64=false,_65="",_66=null,_67="",_68="",_69=this.isProjectModeEnabled();if(_60){_61=_e.toUserFriendlyString(new Date(_60.created));_62=_10.toUserFriendlyString(_60.createdBy,null,true);_64=(_69&&_60.status!=="publishing")||_60.status==="active"||_60.status==="publishfailed";_66={projectId:_60.id};_68=_60.name;if(!this.canPublishProject(_60)||_69){_67=this._messages[_60.status]||"";if(_60.status==="delayedpublished"&&!_69){_63=_e.toUserFriendlyString(_60.delayPublishUntil);_67=_2.replace(_67,{date:_63});_65=_2.replace(res.status.state.delayedpublished,{delayPublishUntil:_63});}}if(_60.status==="publishfailed"){_65=this._getProjectFailedMessage(_60);}}this.set({created:_61,createdBy:_62,dndEnabled:_64,notificationMessage:_65,projectItemQuery:_66,projectStatus:_67,projectName:_68});},_getProjectFailedMessage:function(_6a){var _6b=0,_6c="",_6d=res.notifications.publishfailed;_6b=this._getUnpublishedItems(_6a.itemStatusCount);if(_6b>0){_6c=_2.replace(_6b>1?_6d.notificationtextmultipleitems:_6d.notificationtextsingleitem,{failedItemsCount:_6b});}return _6c;},_getUnpublishedItems:function(_6e){var _6f=0;Object.keys(_6e).forEach(function(key){if(key.indexOf("checkedin")===0){_6f+=_6e[key];}});return _6f;},_isActivitiesVisibleSetter:function(_70){if(_70===this.isActivitiesVisible){return;}this.isActivitiesVisible=_70;this._persistIsActivitiesPanelVisible(_70);},_selectedProjectSetter:function(_71){_71=_2.clone(_71);if(_d.areEqual(this.selectedProject,_71)){return;}if(this.selectedProject&&(!_71||this.selectedProject.id!==_71.id)){this.emit("clear-selection");}this.selectedProject=_71;this._updateSelectedProjectDependencies(_71);},_projectItemSortOrderSetter:function(_72){if(_72&&_72===this.projectItemSortOrder){return;}this.projectItemSortOrder=_72;this._persistSortOrder(_72);},_updateSelectedProjectAndRefreshContextRequest:function(_73){var _74=this;_74.set("selectedProject",_73);return _a(this.getCurrentContext()).then(function(_75){_74.requestContextChange(_75);return _75;});},_selectedProjectItemsSetter:function(_76){this.selectedProjectItems=_76;this._updateProjectCountMessage(_76);},_updateProjectCountMessage:function(_77){var _78=_77&&_77.length>0?_77.length:null,_79="";function _7a(_7b,_7c){_79=_b.substitute(res.notifications.selecteditems[_7c],{count:_7b});};if(_78){if(_78===1){_7a(_78,"singular");}else{if(_78>1){_7a(_78,"plural");}}}this.set("projectItemCountMessage",_79);}});});