//>>built
require({cache:{"url:epi-cms/project/templates/ProjectNotification.html":"<span class=\"dijitReset dijitInline dijitIcon epi-objectIcon epi-iconProject\"></span>\r\n<span class=\"dijitReset dijitInline epi-project-notification__content\">{partOfProject}</span>"}});define("epi-cms/project/ProjectNotification",["dojo/_base/declare","dojo/_base/lang","dojo/promise/all","dojo/Stateful","dojox/html/entities","epi/dependency","epi/shell/DestroyableByKey","epi-cms/ApplicationSettings","epi-cms/contentediting/command/CreateDraft","epi-cms/core/ContentReference","dojo/text!./templates/ProjectNotification.html","epi/i18n!epi/cms/nls/episerver.cms.components.project.notifications"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _1([_4,_7],{order:10,_projectService:null,_createDraftCommand:null,constructor:function(_d,_e){this._projectService=_e||_6.resolve("epi.cms.ProjectService");this._createDraftCommand=new _9({ignoreContentStatus:true});this.own(this._projectService.on("project-item-updated",_2.hitch(this,this._onItemUpdated)),this._projectService.on("project-item-removed",_2.hitch(this,this._onItemRemoved)),this._projectService.on("project-updated",function(){this._onModelChanged(this.value);}.bind(this)));},_valueSetter:function(_f){var _10=_f.contentViewModel;this.value=_10;if(!_10||!_10.contentLink){this.set("model",null);this._currentProjectItemId=0;return;}this._createDraftCommand.set("model",_10);var _11="contentLinkWatch";this.destroyByKey(_11);this.ownByKey(_11,_10.watch("contentLink",_2.hitch(this,"_onModelChanged",_10)));this._onModelChanged(_10);},_onItemUpdated:function(_12){this._onItemsAddedOrRemoved(_12.id);},_onItemRemoved:function(id){this._onItemsAddedOrRemoved(id);},_onItemsAddedOrRemoved:function(_13){if(!this.model){return;}if(this._currentProjectItemId===_13){this._updateNotification(this.model.contentLink);}},_onModelChanged:function(_14){if(_14.get("isSuspended")){return;}this._projectService.getProjectItemForContent(_14.contentLink).then(function(_15){var _16=_14.languageContext,_17=_16&&_16.isTranslationNeeded&&_8.currentContentLanguage===_16.preferredLanguage;this.set("model",_14);this._currentProjectItemId=_15&&_15.id||0;this._updateNotification(_14.contentLink,_14.contentData.isPartOfAnotherProject,_17);}.bind(this)).otherwise(function(){this._currentProjectItemId=0;}.bind(this));},_updateNotification:function(_18,_19,_1a){var _1b=this;_3([this._projectService.getProjectsForContent(_18),this._projectService.getCurrentProject()]).then(function(_1c){var _1d=_1c[0],_1e=_1c[1];if(_1d.length===0){_1b.set("notification",null);return;}var _1f=_1d.map(function(_20){return _5.encode(_20.name);}).join(", ");var _21="";if(_19){_21=_c.partofanotherproject+": "+_1f;}else{if(_1e){_21=_c.partofcurrentproject;}else{_21=_c.partofproject+": "+_1f;}}var _22=_2.replace(_b,{partOfProject:_21});var _23=_19&&_1b._projectService.isProjectModeEnabled&&!_1a?[_1b._createDraftCommand]:[];_1b.set("notification",{content:_22,commands:_23});});}});});