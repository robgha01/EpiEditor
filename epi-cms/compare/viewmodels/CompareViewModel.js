//>>built
define("epi-cms/compare/viewmodels/CompareViewModel",["dojo/_base/declare","dojo/aspect","dojo/topic","dojo/_base/lang","dojo/Stateful","dojo/when","epi/shell/DestroyableByKey","epi/dependency","epi-cms/core/ContentReference","epi-cms/compare/viewmodels/CompareToolbarViewModel"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _1([_5,_7],{contentLink:null,languages:null,typeIdentifier:null,leftVersion:null,rightVersion:null,leftVersionUri:null,rightVersionUrl:null,hasAccess:true,contentDataStore:null,contentVersionStore:null,orientation:"vertical",compareToolbarViewModel:null,_rightVersionDeferred:null,postscript:function(){this.inherited(arguments);this.contentDataStore=this.contentDataStore||_8.resolve("epi.storeregistry").get("epi.cms.contentdata");this.contentVersionStore=this.contentVersionStore||_8.resolve("epi.storeregistry").get("epi.cms.contentversion");this._setupCompareToolbarViewModel();this.own(_3.subscribe("/epi/cms/content/statuschange/",_4.hitch(this,"_refresh")));},_refresh:function(){var _b=this.contentVersionStore;_6(_b.refresh(this.leftVersion.contentLink),_4.hitch(this,function(_c){this.set("leftVersion",_c);}));if(this.rightVersion){_6(_b.refresh(this.rightVersion.contentLink),_4.hitch(this,function(_d){this.set("rightVersion",_d);}));}},_contentLinkSetter:function(_e){this.contentLink=_e;var _f=this.contentVersionStore;if(this._rightVersionDeferred&&!this._rightVersionDeferred.isFulfilled()){this._rightVersionDeferred.cancel();}_6(_f.get(_e),_4.hitch(this,function(_10){this.set("leftVersion",_10);if(!this.rightVersion||!_9.compareIgnoreVersion(this.leftVersion.contentLink,this.rightVersion.contentLink)){var _11={contentLink:_e,language:this.leftVersion.language,query:"getcompareversion"};this._rightVersionDeferred=_f.query(_11);_6(this._rightVersionDeferred,_4.hitch(this,function(_12){this.set("hasAccess",true);this.set("rightVersion",_12&&_12.length?_12[0]:null);}),_4.hitch(this,function(_13){this.set("hasAccess",_13.status!==403);this.set("rightVersion",null);}));}}));},_leftVersionSetter:function(_14){this.leftVersion=_14;if(this.compareToolbarViewModel){if(this.compareToolbarViewModel.leftVersion!==_14){this.compareToolbarViewModel.set("leftVersion",_14);}}this.set("leftVersionUri",_14.uri);},_rightVersionSetter:function(_15){var _16="removeAfter";this.rightVersion=_15;this.destroyByKey(_16);if(_15){this.ownByKey(_16,_2.after(this.contentVersionStore,"remove",_4.hitch(this,function(_17){if(_15.contentLink===_17){this.set("rightVersion",null);}}),true));}if(this.compareToolbarViewModel){if(this.compareToolbarViewModel.rightVersion!==_15){this.compareToolbarViewModel.set("rightVersion",_15);}}if(_15===null){this.set("rightVersionUrl","about:blank");this.set("rightVersionContentLink",null);return;}_6(this.contentDataStore.get(_15.contentLink),_4.hitch(this,function(_18){if(this.leftVersion===this.rightVersion){this.set("rightVersionUrl","about:blank");}this.set("rightVersionUrl",_18.editablePreviewUrl);this.set("rightVersionContentLink",_18.contentLink);}));},_typeIdentifierSetter:function(_19){this.typeIdentifier=_19;if(this.compareToolbarViewModel){this.compareToolbarViewModel.set("typeIdentifier",_19);}},_languagesSetter:function(_1a){this.languages=_1a;if(this.compareToolbarViewModel){this.compareToolbarViewModel.set("languages",_1a);}},_hasAccessSetter:function(_1b){this.hasAccess=_1b;if(this.compareToolbarViewModel){this.compareToolbarViewModel.set("hasAccess",_1b);}},_setupCompareToolbarViewModel:function(){this.compareToolbarViewModel=this.compareToolbarViewModel||new _a({contentVersionStore:this.contentVersionStore,leftVersion:this.leftVersion,rightVersion:this.rightVersion,typeIdentifier:this.typeIdentifier,hasAccess:this.hasAccess,languages:this.languages});this.own(this.compareToolbarViewModel.watch("leftVersion",_4.hitch(this,function(_1c,_1d,_1e){if(this.leftVersion!==_1e){this.set("leftVersion",_1e);}})));this.own(this.compareToolbarViewModel.watch("rightVersion",_4.hitch(this,function(_1f,_20,_21){if(this.rightVersion!==_21){this.set("rightVersion",_21);}})));}});});