//>>built
define("epi-cms/CMSModule",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/when","epi","epi/_Module","epi/dependency","epi/shell/request/mutators","epi/routes","epi/shell/conversion/ObjectConverterRegistry","epi/shell/store/JsonRest","epi/shell/store/Throttle","epi/shell/TypeDescriptorManager","epi/shell/ViewSettings","epi/shell/StickyViewSelector","epi-cms/ApplicationSettings","epi-cms/BackContextHistory","epi-cms/ContextSynchronizer","epi-cms/ContentRepositoryDescriptorService","epi-cms/conversion/ContentFragmentConverter","epi-cms/conversion/ContentLightUriConverter","epi-cms/conversion/ContentReferenceConverter","epi-cms/conversion/PropertyDateConverter","epi-cms/core/ContentReference","epi-cms/store/configurableQueryEngine","epi-cms/store/PageVersionQueryEngine","epi-cms/project/ProjectActivitiesQueryEngine","epi-cms/component/command/GlobalToolbarCommandProvider","epi-cms/compare/command/CompareCommandProvider","epi-cms/notification/command/NotificationCommandProvider","epi-cms/command/ViewSettingsCommandProvider","epi-cms/content-activity/command/ContentActivityCommandProvider","epi-cms/contentediting/ContentHierarchyService","epi-cms/contentediting/EditorFactory","epi-cms/contentediting/InUseNotificationManager","epi-cms/contentediting/ViewSettingsManager","epi-cms/content-approval/ApprovalService","epi-cms/project/ProjectService","epi-cms/activity/ActivityService","epi-cms/notification/NotificationService","epi-cms/project/request/projectMode","epi-cms/request/contentLanguage","epi-cms/project/ProjectModeRequestInterceptor","epi-cms/project/ProjectItemQueryEngine","epi-cms/contentediting/command/Editing","epi-cms/contentediting/commandproviders/ContentDetails","epi-cms/contentediting/commandproviders/PublishMenu","epi-cms/contentediting/commandproviders/PublishMenuGlobal","epi-cms/contentediting/viewsettings/ChannelViewSetting","epi-cms/contentediting/viewsettings/ResolutionViewSetting","epi-cms/contentediting/viewsettings/ViewLanguageViewSetting","epi-cms/contentediting/viewsettings/VisitorGroupViewSetting","epi-cms/project/ProjectViewSetting","epi-cms/widget/ContentTypeService","epi-cms/Profile"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21,_22,_23,_24,_25,_26,_27,_28,_29,_2a,_2b,_2c,_2d,_2e,_2f,_30,_31,_32,_33,_34,_35,_36,_37){return _2([_6],{_settings:null,_hashWrapper:null,_firstTimeHashUpdated:false,constructor:function(_38){this._settings=_38;},initialize:function(){this.inherited(arguments);_8.add(_29);_8.add(_2a);_2.safeMixin(_10,this._settings);var _39=_7.resolve("epi.shell.Profile");return _4(_39.getContentLanguage()).then(_3.hitch(this,function(_3a){_10.currentContentLanguage=_39.contentLanguage=_3a;if(_10.enableStickyView){_f.enable();}else{_f.disable();}this.registerDependency("epi.cms.BackContextHistory",new _11());this.registerDependency("epi.cms.ContextSynchronizer",new _12(),undefined,function(_3b){_3b.destroy();});this.registerDependency("epi.cms.contentEditing.command.Editing",_2d);this._hashWrapper=_7.resolve("epi.shell.HashWrapper");var _3c=this.resolveDependency("epi.shell.ContextService");this.registerDependency("epi.cms.contentRepositoryDescriptors",new _13(this._settings.contentRepositoryDescriptors));_3c.registerRoute("epi.cms.contentdata",_3.hitch(this,this._redirectContentDataContext));_3c.registerRoute("epi.cms.project",_3.hitch(this,this._redirectContext));_3c.registerRoute("epi.cms.approval",_3.hitch(this,this._redirectContext));this._initializeEditorFactory();this._initializeStores();this.registerDependency("epi.cms.ApprovalService",new _25());this.registerDependency("epi.cms.ProjectService",new _26());this.registerDependency("epi.cms.ActivityService",new _27());this.registerDependency("epi.cms.NotificationService",new _28());this.registerDependency("epi.cms.ContentHierarchyService",new _21());this._projectModeRequestInterceptor=new _2b();this.registerDependency("epi.cms.ContentTypeService",new _36());this._setupConverters();this._setupViewSettings(_3c);var _3d=new _20();this.registerDependency("contentActivityCommandProvider",_3d);var _3e=_7.resolve("epi.globalcommandregistry");_3e.registerProvider("epi.cms.publishmenu",new _30());_3e.registerProvider("epi.cms.globalToolbar",new _1c());_3e.registerProvider("epi.cms.globalToolbar",new _1d());_3e.registerProvider("epi.cms.globalToolbar",new _1f());_3e.registerProvider("epi.cms.globalToolbar",new _1e());_3e.registerProvider("epi.cms.globalToolbar",_3d);this._setupInUseNotificationManager(_3e);}));},_redirectContentDataContext:function(_3f,_40,uri){if(_e.viewName==="/episerver/dashboard"){var _41=_9.getActionPath({moduleArea:"CMS",controller:"Home",action:""});_41=_41.substring(0,_41.length-1);var _42=_41+"#"+this._hashWrapper.extractHash(_3f,_40);this._redirect(_42);}else{if(_3f.hasSiteChanged){var _43=_3f.fullHomeUrl+"#"+this._hashWrapper.extractHash(_3f,_40);this._redirect(_43);}else{if(_40&&_40.trigger==="internal"&&this._firstTimeHashUpdated){return;}this._firstTimeHashUpdated=true;this._hashWrapper.onContextChange(_3f,_40);}}},_redirectContext:function(_44,_45){this._hashWrapper.onContextChange(_44,_45);},_redirect:function(url){window.location=url;},_setupConverters:function(){var _46=new _15(),_47=new _16(),_48=new _14(),_49=new _17(),_4a=this.resolveDependency("epi.cms.contentRepositoryDescriptors"),key;for(key in _4a){var _4b=_4a[key];if(_4b.linkableTypes){_4b.linkableTypes.forEach(function(_4c){_a.registerConverter(_4c,_4c+".link",_46);_a.registerConverter(_4c+".fragment",_4c+".link",_46);_a.registerConverter(_4c,"link",_46);});}}for(key in _d._uiDescriptors){var _4d=_d._uiDescriptors[key].descriptor;_a.registerConverter(_4d.typeIdentifier,_4d.typeIdentifier+".reference",_47);_a.registerConverter(_4d.typeIdentifier+".fragment",_4d.typeIdentifier+".reference",_47);_a.registerConverter(_4d.typeIdentifier,_4d.typeIdentifier+".light",_46);_a.registerConverter(_4d.typeIdentifier,_4d.typeIdentifier+".fragment",_48);}_46.registerDefaultConverters(_a);_49.registerDefaultConverters(_a);},_setupViewSettings:function(_4e){var _4f=new _24({viewSettings:[new _32(),new _34(),new _31(),new _35(_4e),new _33(_4e)]});this.registerDependency("epi.viewsettingsmanager",_4f);},_initializeStores:function(){var _50=this.resolveDependency("epi.storeregistry"),_51,_52,_53;_51=_50.create("epi.cms.contentdata",this._getRestPath("contentdata"),{idProperty:"contentLink"});_52=_50.create("epi.cms.content.light",this._getRestPath("contentstructure"),{idProperty:"contentLink",queryEngine:_19});_53=_50.create("epi.cms.contentversion",this._getRestPath("contentversion"),{idProperty:"contentLink",queryEngine:_1a});_50.create("epi.cms.displayoptions",this._getRestPath("displayoptions"));_50.create("epi.cms.category",this._getRestPath("categories"));_50.create("epi.cms.inusenotification",this._getRestPath("inusenotification")).addDependentStore(_51);_50.create("epi.cms.visitorgroup",this._getRestPath("visitorgroup"));_50.create("epi.cms.language",this._getRestPath("language"),{idProperty:"languageId"});_50.create("epi.cms.sitestructure",this._getRestPath("sitestructure"),{idProperty:"url"});_50.create("epi.cms.displaychannels",this._getRestPath("channel"));_50.create("epi.cms.wastebasket",this._getRestPath("wastebasket"));_50.create("epi.cms.project",this._getRestPath("project"),{queryEngine:_19,realtimeInfo:{subscriptionKey:"/episerver/cms/project"}});_50.create("epi.cms.project.item",this._getRestPath("project-item"),{queryEngine:_2c,realtimeInfo:{subscriptionKey:"/episerver/cms/project-item"}});_50.create("epi.cms.activities",this._getRestPath("activities"),{queryEngine:_1b,realtimeInfo:{subscriptionKey:"/episerver/cms/activity"}});_50.create("epi.cms.activities.comments",this._getRestPath("activities-comments"),{realtimeInfo:{subscriptionKey:"/episerver/cms/activity-comment"}});_50.create("epi.cms.contenttype",this._getRestPath("contenttype")).query();_50.create("epi.cms.notification",this._getRestPath("notification"),{queryEngine:_19,realtimeInfo:{subscriptionKey:"/episerver/cms/notification"}});_50.create("epi.cms.notification.users",this._getRestPath("notification-users"),{idProperty:"userName"});_50.add("epi.cms.approval.definition",new _c(new _b({idProperty:"contentLink",target:this._getRestPath("approval-definition"),preventCache:true})));_50.add("epi.cms.approval",new _c(new _b({target:this._getRestPath("approval"),preventCache:true})));_50.add("epi.cms.contentreferences",new _c(new _b({target:this._getRestPath("contentreferences"),idProperty:"contentLink",preventCache:true})));_50.add("epi.cms.referenced-content",new _c(new _b({target:this._getRestPath("referenced-content"),idProperty:"contentLink",preventCache:true})));_50.add("epi.cms.content.search",new _c(new _b({target:this._getRestPath("contentstructure"),idProperty:"contentLink"})));_51.addDependentStore(_52,{refreshOnPatch:true,refresh:function(_54){setTimeout(function(){var id=_51.getIdentity(_54);var _55=new _18(id).createVersionUnspecificReference().toString();_52.refresh(_55);});}});_51.addDependentStore(_53,{transformDelegate:function(_56){if(_56.capabilities&&!_56.capabilities.versionable){return null;}if(!_56.properties){return null;}var _57={pageChangedBy:"savedBy",pageSaved:"savedDate",pageLanguageBranch:"language",pageName:"name",name:"name",icontent_name:"name"};var _58=_3.mixin({},_56);for(var p in _57){if(p in _58.properties){_58[_57[p]]=_58.properties[p];}}return _58;}});},_getRestPath:function(_59){return _9.getRestPath({moduleArea:"cms",storeName:_59});},_initializeEditorFactory:function(){this.registerDependency("epi.cms.contentediting.EditorFactory",function(){var _5a=new _22();_5a.registerEditorWrapper("inline","epi-cms/contentediting/InlineEditorWrapper",function(_5b,_5c){});_5a.registerEditorWrapper("richtextinline","epi-cms/contentediting/RichTextInlineEditorWrapper",function(_5d,_5e){});_5a.registerEditorWrapper("flyout","epi-cms/contentediting/FlyoutEditorWrapper",function(_5f,_60){});_5a.registerEditorWrapper("floating","epi-cms/contentediting/FloatingEditorWrapper",function(_61,_62){});_5a.registerEditorWrapper("contenteditable","epi-cms/contentediting/ContentEditableWrapper",function(_63,_64){});_5a.registerEditorWrapper("legacyProperty","epi-cms/contentediting/DialogEditorWrapper",function(_65,_66){_65.closeOnChange=true;_65.showButtons=false;});return _5a;});},_setupInUseNotificationManager:function(_67){var _68=new _23();this.registerDependency("epi.cms.contentediting.inUseNotificationManager",_68);_67.registerProvider("epi.cms.publishmenu",new _2f());_67.registerProvider("epi.cms.contentdetailsmenu",new _2e());}});});